# Story 1.6: Minimal Orchestrator - Expression Coordinator

## Status
Draft

## Story
**As a** software developer,
**I want** a minimal orchestrator node that sends expression commands via ROS2,
**so that** I can prove the full pipeline (Orchestrator → ROS2 → I2C → ESP32 → SPI eye displays) works.

## Acceptance Criteria

1. **Orchestrator Node:**
   - Python ROS2 node: `orchestrator/ros2_nodes/minimal_coordinator.py`
   - Node name: `/olaf/minimal_coordinator`

2. **Publisher:**
   - Publishes to `/olaf/head/expression`

3. **Expression Cycle:**
   - Timer cycles through expressions every 10 seconds:
     - Neutral → Happy → Curious → Thinking → Confused → Sad → Excited → repeat
   - Intensity randomly varies between 2-4
   - Trigger random blink every 3-8 seconds

4. **Execution:**
   - Launch: `ros2 run olaf_orchestrator minimal_coordinator`
   - Every 10 seconds: Logs expression change, eye displays update
   - Periodic blinks occur independently

5. **End-to-End Validation:**
   - Full chain: Coordinator → Head driver → I2C → ESP32 → SPI eyes
   - Latency: Publish to eye update <100ms
   - Reliability: 50 expression changes without failure
   - Blinks execute smoothly without interrupting expressions

6. **Code Quality:**
   - Clean, commented code
   - Committed to `orchestrator/ros2_nodes/minimal_coordinator.py`

## Tasks / Subtasks

- [ ] **Task 1: Create minimal coordinator node** (AC: 1, 2)
  - [ ] Create `orchestrator/ros2_nodes/minimal_coordinator.py`
  - [ ] Initialize ROS2 node `/olaf/minimal_coordinator`
  - [ ] Create publisher for `/olaf/head/expression` topic
  - [ ] Create publisher for `/olaf/head/blink` topic
  - [ ] Add ROS2 node boilerplate (init, spin, destroy)

- [ ] **Task 2: Implement expression cycling logic** (AC: 3)
  - [ ] Define expression sequence: neutral, happy, curious, thinking, confused, sad, excited
  - [ ] Create 10-second timer callback for expression cycling
  - [ ] Implement cycle logic (index wrapping)
  - [ ] Add random intensity selection (2-4)
  - [ ] Publish expression message on each timer trigger

- [ ] **Task 3: Implement blink logic** (AC: 3)
  - [ ] Create separate timer for blink events
  - [ ] Randomize blink interval (3-8 seconds)
  - [ ] Publish blink trigger message (std_msgs/Empty)
  - [ ] Reset timer with new random interval after each blink

- [ ] **Task 4: Add logging and monitoring** (AC: 4)
  - [ ] Log expression change with timestamp
  - [ ] Log intensity value
  - [ ] Log blink events
  - [ ] Add startup message indicating cycle start

- [ ] **Task 5: Test end-to-end pipeline** (AC: 5)
  - [ ] Launch head_driver node (Story 1.5)
  - [ ] Launch minimal_coordinator node
  - [ ] Observe eye displays change every 10 seconds
  - [ ] Verify periodic blinks (every 3-8 seconds)
  - [ ] Measure latency from publish to visual update
  - [ ] Run 50 cycles (~8.3 minutes) without failure
  - [ ] Verify all expressions display correctly

- [ ] **Task 6: Code quality and documentation** (AC: 6)
  - [ ] Add docstrings to all functions
  - [ ] Add comments explaining expression cycle and blink logic
  - [ ] Clean up code formatting
  - [ ] Commit to repository

## Dev Notes

### Previous Story Insights
From Story 1.5 (ROS2 Head Driver Node):
- Head driver node subscribes to `/olaf/head/expression` and `/olaf/head/blink` topics
- Expects expression_type (string or enum) and intensity (1-5)
- Blink topic accepts std_msgs/Empty (any message triggers blink)
- Translates ROS2 messages to I2C register writes (0x10-0x12)
- Publishes `/olaf/head/status` at 10Hz

From Story 1.4 (Head Module ESP32 Firmware):
- Firmware processes I2C commands with <10ms latency
- Expression types: 0=neutral, 1=happy, 2=curious, 3=thinking, 4=confused, 5=sad, 6=excited
- Intensity range: 1-5
- Blink trigger: Write any value to register 0x12
- Dual eye displays update synchronously at 60 FPS

### Technology Stack
[Source: docs/architecture/tech-stack.md]

**Orchestrator:**
- **Language:** Python 3.11+
- **ROS2 Version:** Humble (LTS until 2027)
- **Logging:** Python logging (ROS2 integration)

### ROS2 Node Architecture
[Source: docs/architecture/ros2-node-architecture.md]

**High-Level Application Nodes:**
```
/olaf/personality_coordinator (Python)
• Coordinates eyes + ears + neck + beeps
• Subscribes: /olaf/ai/emotion_command
• Publishes: /olaf/head/eye_expression, etc.
```

**Note:** This minimal coordinator is a simplified version for Epic 1 validation. Full personality coordinator will be implemented in Epic 9.

### Data Models
[Source: docs/architecture/data-models.md]

**Expression Types:**
```cpp
#define EXPR_NEUTRAL  0x00
#define EXPR_HAPPY    0x01
#define EXPR_CURIOUS  0x02
#define EXPR_THINKING 0x03
#define EXPR_CONFUSED 0x04
#define EXPR_SAD      0x05
#define EXPR_EXCITED  0x06
```

**ROS2 Message Format (if using custom message):**
```python
# olaf_msgs/msg/Expression.msg
string emotion              # 'neutral', 'happy', 'curious', etc.
uint8 intensity             # 1-5
uint8 duration_ms
bool synchronize
```

**Alternative (using std_msgs):**
- Can use `std_msgs/String` with JSON payload
- Or create simple dict and serialize
- Blink uses `std_msgs/Empty`

### File Locations
[Source: docs/architecture/source-tree.md]

**Orchestrator Structure:**
```
orchestrator/
├── ros2_nodes/
│   ├── minimal_coordinator.py    # <-- THIS STORY
│   ├── hardware_drivers/
│   ├── personality/
│   ├── ai_integration/
│   └── navigation/
├── launch/
├── config/
└── README.md
```

**Key Path:**
- Node file: `orchestrator/ros2_nodes/minimal_coordinator.py`

### Coding Standards
[Source: docs/architecture/coding-standards.md#python-standards-ros2-orchestrator]

**Python Style:**
- **Classes:** `PascalCase` (e.g., `MinimalCoordinator`)
- **Functions:** `snake_case` (e.g., `cycle_expression()`)
- **Constants:** `UPPER_SNAKE_CASE` (e.g., `CYCLE_INTERVAL_SEC`)

**Type Hints:** Required for public functions

**Docstrings:** Google style

**Logging:**
- Use `self.get_logger()` for ROS2 nodes
- Levels: INFO for expression changes, DEBUG for internal state

**ROS2-Specific:**
- **Node Name:** `/olaf/minimal_coordinator`
- **Topics:** `/olaf/head/expression`, `/olaf/head/blink`

Example node structure:
```python
import rclpy
from rclpy.node import Node
from std_msgs.msg import String, Empty
import random

class MinimalCoordinator(Node):
    EXPRESSIONS = ['neutral', 'happy', 'curious', 'thinking', 'confused', 'sad', 'excited']
    CYCLE_INTERVAL_SEC = 10.0
    BLINK_MIN_INTERVAL_SEC = 3.0
    BLINK_MAX_INTERVAL_SEC = 8.0

    def __init__(self):
        super().__init__('minimal_coordinator')

        # Publishers
        self.expression_pub = self.create_publisher(String, '/olaf/head/expression', 10)
        self.blink_pub = self.create_publisher(Empty, '/olaf/head/blink', 10)

        # Timers
        self.expression_timer = self.create_timer(self.CYCLE_INTERVAL_SEC, self.expression_callback)
        self.blink_timer = self.create_timer(self._get_random_blink_interval(), self.blink_callback)

        self.expression_index = 0

        self.get_logger().info('Minimal Coordinator started')
        self.get_logger().info('Cycling expressions every 10 seconds, random blinks every 3-8 seconds')

    def _get_random_blink_interval(self) -> float:
        return random.uniform(self.BLINK_MIN_INTERVAL_SEC, self.BLINK_MAX_INTERVAL_SEC)

    def expression_callback(self):
        expression = self.EXPRESSIONS[self.expression_index]
        intensity = random.randint(2, 4)

        # Publish expression
        msg = String()
        msg.data = f"{expression}:{intensity}"  # Simple format
        self.expression_pub.publish(msg)

        self.get_logger().info(f"Expression: {expression}, Intensity: {intensity}")

        # Cycle to next expression
        self.expression_index = (self.expression_index + 1) % len(self.EXPRESSIONS)

    def blink_callback(self):
        # Publish blink trigger
        self.blink_pub.publish(Empty())
        self.get_logger().info("Blink triggered")

        # Reset timer with new random interval
        self.blink_timer.cancel()
        self.blink_timer = self.create_timer(self._get_random_blink_interval(), self.blink_callback)

def main(args=None):
    rclpy.init(args=args)
    coordinator = MinimalCoordinator()
    rclpy.spin(coordinator)
    coordinator.destroy_node()
    rclpy.shutdown()

if __name__ == '__main__':
    main()
```

### Testing

**Test Location:** `tests/unit/orchestrator/`

**Required Tests:**
- Expression cycling logic (verify correct sequence)
- Intensity randomization (verify range 2-4)
- Blink interval randomization (verify range 3-8 seconds)
- Timer callback execution
- Publisher creation

**Integration Test:**
- End-to-end pipeline validation
- Measure latency from publish to eye update
- 50-cycle reliability test
- Verify blinks don't interrupt expressions

**Manual Testing:**
1. Launch head_driver: `ros2 run olaf_drivers head_driver`
2. Launch minimal_coordinator: `ros2 run olaf_orchestrator minimal_coordinator`
3. Observe terminal logs (expression changes every 10 seconds, periodic blinks)
4. Observe eye displays (expression and blink changes)
5. Echo expression topic: `ros2 topic echo /olaf/head/expression`
6. Echo blink topic: `ros2 topic echo /olaf/head/blink`
7. Monitor status: `ros2 topic echo /olaf/head/status`

**Latency Measurement:**
- Use `ros2 topic echo /olaf/head/expression --once` and observe eye display
- Latency should be <100ms (publish → I2C write → animation update)
- Blinks should execute within <100ms

### Technical Constraints

**Performance:**
- Expression timer at 10-second intervals (not time-critical)
- Blink timer at random 3-8 second intervals
- Publishing should not block event loop

**Reliability:**
- Should run continuously without crashes
- 50+ expression cycles without failure
- Blinks should not interfere with expression rendering

**Integration:**
- Depends on head_driver node being active
- No direct I2C access (uses ROS2 abstraction layer)

## Dev Agent Record

### Agent Model Used
<!-- To be filled by dev agent -->

### Debug Log References
<!-- To be filled by dev agent -->

### Completion Notes List
<!-- To be filled by dev agent -->

### File List
<!-- To be filled by dev agent -->

## QA Results
<!-- To be filled by QA agent -->

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | v1.0 | Initial story draft | Bob (Scrum Master) |
| 2025-10-25 | v1.1 | Updated from heartbeat to expression coordinator, added blink logic | Bob (Scrum Master) |
