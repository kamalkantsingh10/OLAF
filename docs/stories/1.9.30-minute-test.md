# Story 1.9: 30-Minute Continuous Operation Test

## Status
Draft

## Story
**As a** quality assurance tester,
**I want** to run the minimal system for 30 minutes without failures,
**so that** I can validate I2C communication stability before Epic 2.

## Acceptance Criteria

1. **Test Setup:**
   - Launch: `ros2 launch orchestrator minimal_system.launch.py`
   - Battery at full charge (or stable power supply)
   - Timer set for 30 minutes

2. **Test Execution:**
   - Eyes cycle through expressions every 10 seconds (180 cycles total)
   - Monitor: Terminal logs, eye expression animations, I2C communication

3. **Success Criteria:**
   - No crashes: All nodes run 30 minutes
   - No missed updates: ~180 expression changes complete (±5% tolerance)
   - Stable latency: Expression change → eye update <100ms throughout
   - Memory stable: ESP32 free heap doesn't decrease

4. **Metrics Collected:**
   - Total runtime: 30:00 minutes
   - Total expression changes: ~180
   - I2C errors: 0
   - Average latency: <100ms (sampled 10 times)

5. **Pass/Fail:**
   - PASS: All criteria met
   - FAIL: Any crash, >10% missed updates, latency >100ms

6. **Documentation:**
   - Results: `tests/integration/epic1_30min_test_results.md`
   - Screenshot of terminal after 30 min

## Tasks / Subtasks

- [ ] **Task 1: Prepare test environment** (AC: 1)
  - [ ] Ensure ESP32 powered and firmware running
  - [ ] Ensure Raspberry Pi powered (stable power supply)
  - [ ] Source ROS2 environment
  - [ ] Clear any previous logs

- [ ] **Task 2: Execute 30-minute test** (AC: 2, 3)
  - [ ] Launch system: `ros2 launch orchestrator minimal_system.launch.py`
  - [ ] Start timer (30 minutes)
  - [ ] Monitor terminal output for errors
  - [ ] Observe eye display expressions and blinks
  - [ ] Count expression changes (should be ~180)
  - [ ] Sample latency 10 times during test

- [ ] **Task 3: Collect metrics** (AC: 4)
  - [ ] Record total runtime
  - [ ] Count expression changes from logs
  - [ ] Note any I2C errors in logs
   - [ ] Measure latency samples (timestamp difference)
  - [ ] Check ESP32 free heap before/after

- [ ] **Task 4: Analyze results** (AC: 5)
  - [ ] Determine PASS/FAIL based on criteria
  - [ ] Identify any issues or anomalies
  - [ ] Note failure points if test fails

- [ ] **Task 5: Document results** (AC: 6)
  - [ ] Create `tests/integration/epic1_30min_test_results.md`
  - [ ] Record all metrics
  - [ ] Include terminal screenshot
  - [ ] Add observations and conclusions

- [ ] **Task 6: Fix issues if test fails** (AC: 5)
  - [ ] Debug any crashes or errors
  - [ ] Fix root causes
  - [ ] Re-run test until PASS

## Dev Notes

### Test Metrics Template

**Epic 1 - 30 Minute Continuous Operation Test Results**

**Test Date:** YYYY-MM-DD
**Tester:** Name
**Hardware:** Raspberry Pi 5, ESP32-S3, GC9A01 Display

**Test Configuration:**
- Power: USB power supply (5V)
- Launch command: `ros2 launch orchestrator minimal_system.launch.py`
- Start time: HH:MM:SS
- End time: HH:MM:SS

**Results:**
- **Total Runtime:** 30:00 minutes
- **Expression Changes:** XXX / ~180 expected (XX%)
- **I2C Errors:** X
- **Average Latency:** XX ms (sampled 10 times)
- **ESP32 Free Heap (start):** XXXX bytes
- **ESP32 Free Heap (end):** XXXX bytes

**Pass/Fail Criteria:**
- [ ] No crashes (PASS/FAIL)
- [ ] Expression changes within ±5% tolerance (PASS/FAIL)
- [ ] Latency <100ms (PASS/FAIL)
- [ ] Memory stable (no significant decrease) (PASS/FAIL)

**Overall Result:** PASS / FAIL

**Observations:**
- (Note any anomalies, patterns, or issues)

**Screenshots:**
- Terminal output after 30 minutes
- Eye display photo showing expressions

### Latency Measurement Method

Use ROS2 timestamps to measure latency:
```python
# In minimal_coordinator, log publish time
self.get_logger().info(f"[{time.time()}] Publishing expression: {expression}")

# In head_driver, log I2C write time
self.get_logger().info(f"[{time.time()}] I2C write complete")

# Calculate difference
```

Or use: `ros2 topic echo /olaf/head/expression` and observe eye display change (stopwatch)

### ESP32 Memory Monitoring

Add to ESP32 firmware (optional):
```cpp
Serial.printf("[INFO] Free heap: %d bytes\n", ESP.getFreeHeap());
```

Check before test start and after 30 minutes.

## Dev Agent Record

### Agent Model Used
<!-- To be filled by dev agent -->

### Debug Log References
<!-- To be filled by dev agent -->

### Completion Notes List
<!-- To be filled by dev agent -->

### File List
<!-- To be filled by dev agent -->

## QA Results
<!-- To be filled by QA agent -->

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | v1.0 | Initial story draft | Bob (Scrum Master) |
| 2025-10-25 | v1.1 | Updated from emotions/heart to expressions/eyes | Bob (Scrum Master) |
