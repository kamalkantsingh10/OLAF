# Story 5.5: Body Module ESP32 Firmware - Heart LCD Animation

## Status
Draft

## Story
**As a** firmware developer,
**I want** ESP32 firmware rendering animated heart on ST77916 LCD with I2C control,
**so that** the orchestrator can express emotions through body display.

## Acceptance Criteria

1. **Development Environment:**
   - PlatformIO project: `firmware/body/firmware/`
   - Platform: ESP32-S3 (Arduino framework)
   - Libraries:
     - `Wire.h` (I2C slave)
     - `Adafruit_GFX.h` (graphics primitives)
     - `Adafruit_ST7789.h` (ST77916 driver, compatible with ST7789 library for round displays)
     - Custom QSPI initialization for ST77916 (may require library modification or custom driver)

2. **I2C Slave Implementation:**
   - ESP32-S3 configured as I2C slave at address **0x0A**
   - I2C receive/request handlers implemented
   - Interrupt-driven I2C communication

3. **I2C Register Map (Body Module 0x0A):**
   - `0x00`: Module ID (returns 0x0A)
   - `0x02`: Status byte (READY/BUSY/ERROR)
   - **Heart Animation Control:**
     - `0x10`: Animation mode (0=off, 1=idle-pulse, 2=excited-fast, 3=sad-slow, 4=custom)
     - `0x11`: Heart rate BPM (40-180, maps to animation speed)
     - `0x12`: Color hue (0-255, HSV color wheel for heart color)
     - `0x13`: Brightness (0-255, PWM backlight control)
   - **Display Control:**
     - `0x20`: Display on/off (0=off, 1=on)
     - `0x21`: Test pattern (write 1 to show test pattern for calibration)

4. **ST77916 QSPI Display Driver:**
   - QSPI interface initialized (GPIO10-18 from Story 5.2)
   - Display resolution: 360×360 pixels (circular mask applied for round display)
   - Frame buffer: 360×360 RGB565 (requires 259.2KB, may need PSRAM on ESP32-S3)
   - Target frame rate: 30 FPS minimum (60 FPS ideal)
   - Backlight PWM: GPIO18 controls brightness (0-100%)

5. **Heart Animation Engine:**
   - **Rendering Pipeline:**
     - Clear frame buffer (black background)
     - Draw heart shape (parametric or sprite-based)
     - Apply animation transform (scale, color pulse)
     - Transfer frame buffer to LCD via QSPI
   - **Animation Modes:**
     - **Idle Pulse (mode 1):** Gentle heartbeat (60 BPM default)
       - Scale: 90% → 100% → 90% (smooth easing)
       - Color: Solid red (#FF0000)
     - **Excited Fast (mode 2):** Rapid heartbeat (120 BPM)
       - Scale: 85% → 105% → 85% (more pronounced)
       - Color: Bright red with slight yellow tint (#FF3030)
     - **Sad Slow (mode 3):** Slow heartbeat (45 BPM)
       - Scale: 95% → 100% → 95% (subtle)
       - Color: Darker red/blue tint (#CC0044)
     - **Custom (mode 4):** BPM and color from registers 0x11, 0x12
   - **Heart Rate Calculation:**
     - BPM → Animation period (ms): `period = 60000 / BPM`
     - Example: 60 BPM = 1000ms per beat cycle

6. **Graphics Implementation:**
   - Heart shape rendered using:
     - Option A: Parametric equations (mathematical heart curve)
     - Option B: Sprite bitmap (pre-rendered heart PNG → C array)
   - Center position: (180, 180) - center of 360×360 display
   - Size: Heart fills ~60% of display diameter (216 pixels)
   - Anti-aliasing: Smooth edges (if performance allows)

7. **Performance Optimization:**
   - Use PSRAM for frame buffer (ESP32-S3 N16R8 has 8MB PSRAM)
   - DMA transfer for QSPI (minimize CPU blocking)
   - Animation loop: Non-blocking, runs independently of I2C interrupts
   - Target: <33ms per frame (30 FPS minimum)
   - Memory stable: No heap fragmentation over 30 minutes

8. **Testing:**
   - Firmware compiled and uploaded to ESP32-S3
   - Serial: "I2C Slave initialized at 0x0A - Body Module"
   - Display initializes: Backlight on, test pattern renders (concentric circles)
   - I2C scan: `sudo i2cdetect -y 1` shows device at 0x0A
   - **Animation Tests:**
     - Write mode 1 (idle pulse): Heart beats at 60 BPM, smooth animation
     - Write mode 2 (excited): Heart beats at 120 BPM, faster animation
     - Write mode 3 (sad): Heart beats at 45 BPM, slower animation
     - Custom test: Write BPM 90, hue 120 (green heart) → animates at 90 BPM in green
   - **Brightness Control:**
     - Write brightness 255: Full brightness
     - Write brightness 128: Half brightness (backlight dims)
     - Write brightness 0: Display dark (backlight off, but heart still animating)
   - Frame rate measured: Actual FPS (log to serial or count frames)

9. **Integration Testing:**
   - I2C latency: Command sent → animation mode changes <50ms
   - Combined test: Send multiple commands (mode + BPM + color) → all apply simultaneously
   - Reliability: 50 mode changes without failure or visual glitches
   - Thermal check: 30 minutes continuous animation, ESP32 <65°C, display <50°C

10. **Code Quality:**
    - Files:
      - `main.cpp`
      - `i2c_slave.cpp`
      - `st77916_driver.cpp` (QSPI display driver)
      - `heart_animation.cpp` (animation engine)
      - `heart_graphics.cpp` (heart shape rendering)
    - Comments explain QSPI initialization, animation timing, heart rate math
    - Code committed to `firmware/body/firmware/`

## Tasks / Subtasks

- [ ] **Task 1: Set up PlatformIO project** (AC: 1)
  - [ ] Create PlatformIO project: `firmware/body/`
  - [ ] Configure `platformio.ini`:
    - [ ] Platform: `espressif32`
    - [ ] Board: `esp32-s3-devkitc-1`
    - [ ] Framework: `arduino`
    - [ ] Enable PSRAM: `board_build.arduino.memory_type = qio_qspi`
  - [ ] Add libraries:
    - [ ] `Wire` (built-in)
    - [ ] `Adafruit GFX Library`
    - [ ] `Adafruit ST7735 and ST7789 Library`
  - [ ] Create `src/` directory structure
  - [ ] Verify project compiles (empty main.cpp)

- [ ] **Task 2: Implement I2C slave interface** (AC: 2, 3)
  - [ ] Create `src/i2c_slave.cpp` and `src/i2c_slave.h`
  - [ ] Configure I2C slave at address 0x0A (GPIO21=SDA, GPIO22=SCL)
  - [ ] Implement I2C receive handler:
    - [ ] Parse incoming write commands (register address + data)
    - [ ] Update internal register array
  - [ ] Implement I2C request handler:
    - [ ] Return register values on read requests
  - [ ] Define register map:
    - [ ] 0x00: Module ID (constant 0x0A)
    - [ ] 0x02: Status (READY/BUSY/ERROR)
    - [ ] 0x10-0x13: Heart animation parameters
    - [ ] 0x20-0x21: Display control
  - [ ] Test I2C with Raspberry Pi: `i2cget -y 1 0x0A 0x00` returns 0x0A

- [ ] **Task 3: Initialize ST77916 QSPI display** (AC: 4)
  - [ ] Create `src/st77916_driver.cpp` and `src/st77916_driver.h`
  - [ ] Configure QSPI pins (from Story 5.2):
    - [ ] CS → GPIO10, SCK → GPIO12
    - [ ] SDA0 → GPIO11, SDA1 → GPIO13, SDA2 → GPIO14, SDA3 → GPIO15
    - [ ] DC → GPIO16, RST → GPIO17, BL → GPIO18
  - [ ] Attempt Adafruit_ST7789 library initialization
  - [ ] If library doesn't support QSPI:
    - [ ] Write custom SPI initialization using ESP32 QSPI API
    - [ ] Reference: ESP-IDF SPI Master driver documentation
  - [ ] Allocate frame buffer in PSRAM: 360×360 RGB565 (259.2KB)
  - [ ] Test display: Fill screen with solid color (red, green, blue)
  - [ ] Implement backlight PWM control on GPIO18 (0-255 brightness)

- [ ] **Task 4: Implement heart graphics rendering** (AC: 6)
  - [ ] Create `src/heart_graphics.cpp` and `src/heart_graphics.h`
  - [ ] **Option A: Parametric heart curve:**
    - [ ] Implement heart curve equation: `x = 16*sin³(t)`, `y = 13*cos(t) - 5*cos(2t) - 2*cos(3t) - cos(4t)`
    - [ ] Scale to fit 360×360 display (~216px diameter)
    - [ ] Render filled heart using Adafruit_GFX `fillCircle` or custom fill algorithm
  - [ ] **Option B: Sprite bitmap:**
    - [ ] Create heart PNG (216×216) in image editor
    - [ ] Convert to C array using image2cpp tool
    - [ ] Render sprite to frame buffer
  - [ ] Implement HSV to RGB color conversion for hue control (register 0x12)
  - [ ] Test: Render heart at center (180, 180) in various colors

- [ ] **Task 5: Implement heart animation engine** (AC: 5)
  - [ ] Create `src/heart_animation.cpp` and `src/heart_animation.h`
  - [ ] Define animation modes (idle-pulse, excited-fast, sad-slow, custom)
  - [ ] Implement BPM to period conversion: `period_ms = 60000 / BPM`
  - [ ] Implement scale interpolation (easing functions):
    - [ ] Idle: 90% → 100% → 90% (ease-in-out)
    - [ ] Excited: 85% → 105% → 85% (faster ease)
    - [ ] Sad: 95% → 100% → 95% (subtle ease)
  - [ ] Animation loop:
    - [ ] Calculate current scale based on elapsed time and BPM
    - [ ] Clear frame buffer (black background)
    - [ ] Render heart at calculated scale and color
    - [ ] Transfer frame buffer to display via QSPI
  - [ ] Target: 30 FPS (33ms per frame)

- [ ] **Task 6: Optimize performance** (AC: 7)
  - [ ] Enable PSRAM in PlatformIO: `board_build.arduino.memory_type = qio_qspi`
  - [ ] Allocate frame buffer in PSRAM: `ps_malloc(360*360*2)`
  - [ ] Profile frame rendering time (measure with `micros()`)
  - [ ] Optimize rendering:
    - [ ] Use DMA for QSPI transfers (if supported by library)
    - [ ] Reduce rendering resolution if <30 FPS (e.g., render at 180×180, upscale)
    - [ ] Pre-calculate easing curve lookup table
  - [ ] Monitor memory: Log free heap every 10 seconds (should be stable)

- [ ] **Task 7: Testing - Animation modes** (AC: 8)
  - [ ] Upload firmware to ESP32-S3
  - [ ] Verify serial output: "I2C Slave initialized at 0x0A - Body Module"
  - [ ] Test display initialization: Backlight on, test pattern visible
  - [ ] Test I2C scan: `sudo i2cdetect -y 1` shows 0x0A
  - [ ] **Test Mode 1 (idle pulse):**
    - [ ] Write to I2C: `i2cset -y 1 0x0A 0x10 0x01` (set mode 1)
    - [ ] Observe: Heart beats at 60 BPM, smooth red animation
  - [ ] **Test Mode 2 (excited):**
    - [ ] Write: `i2cset -y 1 0x0A 0x10 0x02`
    - [ ] Observe: Heart beats at 120 BPM, faster animation
  - [ ] **Test Mode 3 (sad):**
    - [ ] Write: `i2cset -y 1 0x0A 0x10 0x03`
    - [ ] Observe: Heart beats at 45 BPM, slower, darker color
  - [ ] **Test Custom mode:**
    - [ ] Write BPM: `i2cset -y 1 0x0A 0x11 90` (90 BPM)
    - [ ] Write hue: `i2cset -y 1 0x0A 0x12 85` (green, hue ~120°)
    - [ ] Write mode: `i2cset -y 1 0x0A 0x10 0x04` (custom)
    - [ ] Observe: Green heart at 90 BPM

- [ ] **Task 8: Testing - Brightness control** (AC: 8)
  - [ ] Test full brightness: `i2cset -y 1 0x0A 0x13 255`
  - [ ] Test half brightness: `i2cset -y 1 0x0A 0x13 128`
  - [ ] Test backlight off: `i2cset -y 1 0x0A 0x13 0` (heart still animates, just dark)
  - [ ] Verify smooth brightness transitions (PWM on GPIO18)

- [ ] **Task 9: Integration testing** (AC: 9)
  - [ ] Measure I2C latency: Time from command to animation change (<50ms)
  - [ ] Test rapid commands: Send mode + BPM + color in sequence
  - [ ] Reliability test: 50 mode changes without glitches
  - [ ] Thermal test: Run 30 minutes continuous animation
    - [ ] Measure ESP32 temperature (touch test or thermocouple): <65°C
    - [ ] Measure display temperature: <50°C
  - [ ] Measure frame rate: Log FPS to serial (should be ≥30 FPS)

- [ ] **Task 10: Code quality and documentation** (AC: 10)
  - [ ] Organize code into modules:
    - [ ] `main.cpp` (setup, loop, main logic)
    - [ ] `i2c_slave.cpp` (I2C slave interface)
    - [ ] `st77916_driver.cpp` (QSPI display driver)
    - [ ] `heart_animation.cpp` (animation engine)
    - [ ] `heart_graphics.cpp` (heart rendering)
  - [ ] Add comments:
    - [ ] QSPI initialization steps
    - [ ] Animation timing formulas (BPM → period)
    - [ ] HSV to RGB conversion
  - [ ] Update `firmware/body/README.md`:
    - [ ] I2C register map table
    - [ ] Firmware build/upload instructions
    - [ ] QSPI pinout reference
  - [ ] Commit code to repository

## Dev Notes

### ST77916 QSPI Driver Challenges

**Library Compatibility:**
- Adafruit_ST7789 library primarily supports SPI, not QSPI
- May need custom driver using ESP32-S3 SPI peripheral in octal/quad mode
- Reference: ESP-IDF SPI Master documentation

**QSPI Configuration:**
- ESP32-S3 supports QSPI via SPI2 or SPI3 peripheral
- Need to configure 4 data lines (SDA0-SDA3) instead of 1 (MOSI)
- Clock speed: 40-80MHz typical for QSPI displays

**Alternative Approach:**
- If QSPI driver too complex, fall back to standard SPI initially
- Standard SPI will work but at lower frame rate (~15-20 FPS vs 60 FPS)
- Can upgrade to QSPI later for performance improvement

### Heart Shape Rendering Options

**Option A: Parametric Equations**
- **Pros:** Scalable, smooth, no memory overhead
- **Cons:** CPU-intensive, requires floating-point math
- **Equation:** Heart curve using sine/cosine functions
- **Implementation:** Calculate points, use `fillTriangle` or `drawPixel` to fill

**Option B: Sprite Bitmap**
- **Pros:** Fast rendering, pre-computed shape
- **Cons:** Fixed size, memory overhead (~93KB for 216×216 RGBA)
- **Implementation:** PNG → C array → `drawBitmap`
- **Recommendation:** Use for initial implementation (simpler, faster to develop)

### BPM to Animation Timing

**Formula:**
- Period (ms) = 60000 / BPM
- Example: 60 BPM = 60000 / 60 = 1000ms per beat
- Animation cycle: 0ms (min scale) → 500ms (max scale) → 1000ms (min scale)

**Easing Functions:**
- Linear: Simple but unnatural
- Ease-in-out: Smooth acceleration/deceleration (recommended)
- Formula: `easeInOutQuad(t) = t < 0.5 ? 2*t² : 1 - 2*(1-t)²`

### Performance Targets

**Frame Rate:**
- 30 FPS: Acceptable for smooth heartbeat animation
- 60 FPS: Ideal, requires QSPI and optimization

**Frame Budget @ 30 FPS:**
- 33ms total per frame
- Breakdown:
  - Rendering: 20ms (clear + draw heart)
  - QSPI transfer: 10ms (259.2KB @ ~25 MB/s)
  - Overhead: 3ms

**Memory:**
- Frame buffer: 259.2KB (360×360 RGB565)
- Sprite (if used): ~93KB
- Total: ~350KB (fits in 8MB PSRAM)

### I2C Register Design

**Register 0x10 (Animation Mode):**
- 0: Off (display black or static)
- 1: Idle pulse (60 BPM, red)
- 2: Excited fast (120 BPM, bright red)
- 3: Sad slow (45 BPM, dark blue)
- 4: Custom (use BPM/color from registers 0x11/0x12)

**Register 0x11 (Heart Rate BPM):**
- Range: 40-180 BPM
- Default: 60 BPM
- Used only in custom mode (mode 4)

**Register 0x12 (Color Hue):**
- Range: 0-255 (HSV hue, 0°-360° mapped to 0-255)
- Examples:
  - 0: Red
  - 85: Green
  - 170: Blue
  - 200: Purple

**Register 0x13 (Brightness):**
- Range: 0-255 (PWM duty cycle on GPIO18)
- 0: Backlight off
- 255: Full brightness

### HSV to RGB Conversion

**Why HSV:**
- Hue: Single value controls color (easier for orchestrator)
- RGB: Requires 3 values (R, G, B)

**Conversion Algorithm:**
```cpp
// Simplified HSV to RGB (full saturation, full value)
void hsvToRgb(uint8_t hue, uint8_t &r, uint8_t &g, uint8_t &b) {
    uint8_t region = hue / 43; // 0-5
    uint8_t remainder = (hue % 43) * 6;

    uint8_t p = 0, q = 255 - remainder, t = remainder;

    switch (region) {
        case 0: r = 255; g = t; b = p; break;
        case 1: r = q; g = 255; b = p; break;
        case 2: r = p; g = 255; b = t; break;
        case 3: r = p; g = q; b = 255; break;
        case 4: r = t; g = p; b = 255; break;
        default: r = 255; g = p; b = q; break;
    }
}
```

### File Locations

```
firmware/body/
├── platformio.ini             # <-- THIS STORY
├── src/
│   ├── main.cpp               # <-- THIS STORY
│   ├── i2c_slave.cpp          # <-- THIS STORY
│   ├── i2c_slave.h            # <-- THIS STORY
│   ├── st77916_driver.cpp     # <-- THIS STORY
│   ├── st77916_driver.h       # <-- THIS STORY
│   ├── heart_animation.cpp    # <-- THIS STORY
│   ├── heart_animation.h      # <-- THIS STORY
│   ├── heart_graphics.cpp     # <-- THIS STORY
│   └── heart_graphics.h       # <-- THIS STORY
└── README.md                  # <-- THIS STORY (update)
```

### Testing Commands

**I2C Read Module ID:**
```bash
sudo i2cget -y 1 0x0A 0x00  # Should return 0x0a
```

**I2C Write Animation Mode:**
```bash
sudo i2cset -y 1 0x0A 0x10 0x01  # Set mode 1 (idle pulse)
```

**I2C Write Custom Parameters:**
```bash
sudo i2cset -y 1 0x0A 0x11 90    # BPM = 90
sudo i2cset -y 1 0x0A 0x12 85    # Hue = 85 (green)
sudo i2cset -y 1 0x0A 0x10 0x04  # Mode = custom
```

**Troubleshooting:**
- **Display blank:** Check QSPI wiring, verify backlight GPIO18, check 3.3V power
- **I2C not responding:** Verify slave address 0x0A, check SDA/SCL wiring
- **Low frame rate:** Check PSRAM enabled, optimize rendering, reduce resolution
- **ESP32 overheating:** Reduce clock speed, improve ventilation, check for infinite loops

## Dependencies
- Story 5.2: Body Module hardware assembled
- Story 5.4: Raspberry Pi integrated (for I2C testing)

## Estimated Effort
10-14 hours

## Dev Agent Record

### Agent Model Used
<!-- To be filled by dev agent -->

### Debug Log References
<!-- To be filled by dev agent -->

### Completion Notes List
<!-- To be filled by dev agent -->

### File List
<!-- To be filled by dev agent -->

## QA Results
<!-- To be filled by QA agent -->

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | v1.0 | Initial story creation from Epic 5 | John (Product Manager) |
