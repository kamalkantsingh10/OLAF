# Story 5.3: Power System Assembly - Battery, BMS & Distribution

## Status
Draft

## Story
**As a** hardware builder,
**I want** complete power system assembled with battery, BMS, converters, and safety features,
**so that** Olaf can operate autonomously with safe power delivery.

## Acceptance Criteria

1. **Components Acquired:**
   - **Battery:** 36V 4.4Ah hoverboard battery pack (10S2P 18650 cells) with integrated BMS
   - **Buck Converters:**
     - 36V→12V converter (10A rated) for future motor use (ODrive in Epic 6)
     - 36V→5V converter (10A rated) for Raspberry Pi, ESP32s, servos
   - **Safety Components:**
     - Main power switch (rocker switch, 10A rated)
     - Emergency cutoff button (normally-closed push button)
     - Fuse holder + fuses: 10A for 12V rail, 10A for 5V rail
     - Voltage monitor module (displays battery voltage)
   - **Wiring:**
     - 14AWG wire (red/black) for 36V main lines
     - 16AWG wire for 12V/5V distribution
     - XT60 connectors (battery → distribution board)
     - Anderson Powerpole connectors (distribution → loads)
   - **Charging:**
     - 36V (42V max) lithium battery charger (2A recommended)
     - Barrel jack connector for charging port

2. **Battery Installation:**
   - 36V battery pack placed in `power-enclosure-base.stl`
   - Battery secured with velcro straps (prevents movement during balancing)
   - BMS wires organized: Balance leads, charge/discharge protection
   - Battery compartment lid allows ventilation (lithium safety)

3. **Power Distribution Board Assembly:**
   - Custom power distribution board (perfboard or PCB):
     ```
     [36V Battery] → [Main Switch] → [Emergency Cutoff] → [Fuse Block] → [Buck Converters]
                                                                         ↓
                                                           12V Rail (future motors)
                                                           5V Rail (Pi, ESP32s, servos)
     ```
   - All connections soldered or screw-terminal secured
   - Voltage monitor connected across battery terminals (always-on, low current draw)
   - Fuses installed in holders (not directly soldered for easy replacement)

4. **Buck Converter Configuration:**
   - **36V→12V Converter:**
     - Input: 36V from battery (post-fuse)
     - Output adjusted: 12.0V ±0.2V (measured with multimeter)
     - Load tested: 5A dummy load (resistor bank or test motor)
     - Output stable: No voltage drop under load
   - **36V→5V Converter:**
     - Input: 36V from battery (post-fuse)
     - Output adjusted: 5.0V ±0.1V (critical for Pi/ESP32 stability)
     - Load tested: 3A dummy load (simulate Pi + 2 ESP32s)
     - Ripple tested: <50mV ripple with oscilloscope (if available)

5. **Safety System Testing:**
   - **Main Power Switch:**
     - OFF: Voltage monitor shows battery voltage, all other rails dead
     - ON: All rails energized, voltage monitor displays 36V
   - **Emergency Cutoff:**
     - Button pressed: All power rails immediately disconnected
     - Button released: Power restored (normally-closed circuit)
   - **Fuse Protection:**
     - Intentional short test: Fuse blows, prevents damage
     - Fuse replacement verified

6. **Output Wiring:**
   - **5V Rail Distribution:**
     - Raspberry Pi: Anderson Powerpole connector → GPIO header 5V pins (or USB-C PD if Pi 5)
     - ESP32 Head Module: JST connector → VIN (5V)
     - ESP32 Ears+Neck Module: JST connector → VIN (5V)
     - ESP32 Body Module: JST connector → VIN (5V)
     - Servo controllers (Epic 3 ears+neck): Anderson Powerpole → 5V (separate line, high current)
   - **12V Rail:**
     - Placeholder wiring for Epic 6 (ODrive motor controller)
   - All connectors labeled with voltage rail and amperage

7. **Thermal Testing:**
   - **30-Minute Load Test:**
     - Connect all Epic 3 hardware (Pi, 3 ESP32s, 7 servos) to 5V rail
     - Run head expressions continuously (Story 3.10 test)
     - Monitor temperatures:
       - Buck converters: <60°C (measure with IR thermometer or thermocouple)
       - Battery: <40°C (lithium safety limit)
       - Wiring: No warm spots (indicates high resistance joints)
     - Voltage stability: 5V rail remains 4.9-5.1V throughout test
   - **Thermal Shutdown Test:**
     - Overload 5V rail: 12A load (exceeds 10A rating)
     - Verify buck converter thermal protection kicks in (output cuts off, no damage)
     - Converter recovers after cooling (automatic restart or manual reset)

8. **Charging System:**
   - Barrel jack charging port installed in torso back panel
   - Charger connected: BMS indicates charging (LED or voltage monitor shows 42V)
   - Charge full battery: 0% → 100% (measure time, verify BMS cutoff at 42V)
   - Charging while system powered: Verify safe (BMS allows simultaneous charge/discharge)

9. **Voltage Monitoring & Cutoff:**
   - Battery voltage displayed on voltage monitor (visible from outside torso)
   - Low voltage warning: 33V (critical: 30V shutdown to prevent over-discharge)
   - Software monitoring (Story 5.6): Pi reads battery voltage via ADC or I2C voltage sensor

10. **Cable Management:**
    - All power wiring routed through `cable-channels-torso.stl`
    - High-current wires (36V, 5V mains) separated from signal wires (I2C, USB)
    - Strain relief: All connectors secured to prevent wire pull
    - Access panel allows maintenance without full disassembly

11. **Documentation:**
    - Power system diagram: `hardware/wiring/power-distribution-diagram.png`
    - Buck converter settings noted: Output voltages, current limits
    - Safety checklist: Fuse ratings, emergency cutoff procedure
    - Battery care: Charging procedure, storage voltage (50% = ~36V)
    - Wiring photos: `hardware/wiring/power-system-assembly/`

## Tasks / Subtasks

- [ ] **Task 1: Acquire all power system components** (AC: 1)
  - [ ] Purchase 36V 4.4Ah hoverboard battery with integrated BMS
  - [ ] Purchase 36V→12V buck converter (10A rated, e.g., LM2596 or XL4015)
  - [ ] Purchase 36V→5V buck converter (10A rated)
  - [ ] Purchase main power switch (rocker, 10A)
  - [ ] Purchase emergency cutoff button (normally-closed)
  - [ ] Purchase fuse holders and 10A fast-blow fuses (2× for 12V and 5V rails)
  - [ ] Purchase voltage monitor module (digital display, 0-50V range)
  - [ ] Purchase wiring: 14AWG (36V), 16AWG (12V/5V)
  - [ ] Purchase connectors: XT60, Anderson Powerpole, JST
  - [ ] Purchase 36V lithium charger (42V max, 2A)
  - [ ] Purchase barrel jack connector for charging port
  - [ ] Verify all components specifications match requirements

- [ ] **Task 2: Install battery in power enclosure** (AC: 2)
  - [ ] Place battery in `power-enclosure-base.stl`
  - [ ] Secure battery with velcro straps (prevent movement)
  - [ ] Organize BMS balance leads (don't disconnect, keep accessible)
  - [ ] Route battery output wires (XT60 connector) to distribution board location
  - [ ] Install `power-enclosure-lid.stl` with ventilation holes clear
  - [ ] Verify battery doesn't shift when tilted/moved

- [ ] **Task 3: Build power distribution board** (AC: 3)
  - [ ] Design simple distribution board layout on paper
  - [ ] Use perfboard or custom PCB for distribution board
  - [ ] Solder/wire power flow:
    - [ ] Battery XT60 → Main switch → Emergency cutoff → Fuse block → Buck converters
  - [ ] Install main power switch in accessible location (torso side panel)
  - [ ] Install emergency cutoff button (large red button, easy access)
  - [ ] Install fuse holders (10A fuses for 12V and 5V rails)
  - [ ] Connect voltage monitor across battery terminals (always-on monitoring)
  - [ ] Mount distribution board in `power-distribution-board-mount.stl`
  - [ ] Verify all solder joints secure, no shorts

- [ ] **Task 4: Configure and test buck converters** (AC: 4)
  - [ ] Mount buck converters in `buck-converter-mount.stl`
  - [ ] **Configure 36V→12V converter:**
    - [ ] Connect input to 36V rail (post-fuse)
    - [ ] Adjust output potentiometer to 12.0V (measure with multimeter)
    - [ ] Load test with 5A resistor bank or motor
    - [ ] Verify voltage stability under load (11.9-12.1V)
  - [ ] **Configure 36V→5V converter:**
    - [ ] Connect input to 36V rail (post-fuse)
    - [ ] Adjust output potentiometer to 5.0V precisely (±0.05V)
    - [ ] Load test with 3A dummy load
    - [ ] Measure ripple with oscilloscope (<50mV acceptable)
  - [ ] Verify both converters stable, no excessive heat

- [ ] **Task 5: Test safety systems** (AC: 5)
  - [ ] **Main switch test:**
    - [ ] Switch OFF: Verify voltage monitor shows battery voltage only
    - [ ] Switch ON: Verify all rails energized
  - [ ] **Emergency cutoff test:**
    - [ ] System running, press button: All power disconnects immediately
    - [ ] Release button: Power restored
  - [ ] **Fuse protection test:**
    - [ ] Create controlled short on 5V rail (use wire resistor)
    - [ ] Verify fuse blows before converter damage
    - [ ] Replace fuse, verify system recovers
  - [ ] Document all safety tests passed

- [ ] **Task 6: Wire output distribution** (AC: 6)
  - [ ] **5V Rail wiring:**
    - [ ] Wire Anderson Powerpole connector for Raspberry Pi
    - [ ] Wire JST connectors for 3× ESP32 modules (Head, Ears+Neck, Body)
    - [ ] Wire Anderson Powerpole for servo controllers (separate high-current line)
  - [ ] **12V Rail wiring:**
    - [ ] Wire placeholder connector for Epic 6 ODrive
  - [ ] Label all connectors clearly:
    - [ ] "5V - Raspberry Pi - 3A max"
    - [ ] "5V - ESP32 Head 0x08"
    - [ ] "5V - ESP32 Ears+Neck 0x09"
    - [ ] "5V - ESP32 Body 0x0A"
    - [ ] "5V - Servos - 5A max"
    - [ ] "12V - Motors (Epic 6)"

- [ ] **Task 7: Thermal testing** (AC: 7)
  - [ ] Connect all Epic 3 hardware to 5V rail
  - [ ] Run continuous load test (head expressions, servos moving) for 30 minutes
  - [ ] Monitor temperatures every 5 minutes:
    - [ ] Buck converters with IR thermometer
    - [ ] Battery temperature (touch test or thermocouple)
    - [ ] Wiring joints (look for warm spots)
  - [ ] Monitor 5V rail voltage: Should remain 4.9-5.1V
  - [ ] Overload test: 12A on 5V rail, verify thermal protection
  - [ ] Document thermal test results

- [ ] **Task 8: Install and test charging system** (AC: 8)
  - [ ] Install barrel jack charging port in torso back panel
  - [ ] Wire barrel jack to battery BMS charging input (observe polarity!)
  - [ ] Connect charger, verify BMS indicates charging (LED or voltage increase)
  - [ ] Charge battery 0%→100%, measure time (~2 hours expected)
  - [ ] Verify BMS cuts off charging at 42V (overcharge protection)
  - [ ] Test simultaneous charge+operation (system running while charging)

- [ ] **Task 9: Voltage monitoring setup** (AC: 9)
  - [ ] Position voltage monitor for external visibility (torso back or side)
  - [ ] Verify voltage monitor displays accurate battery voltage (compare with multimeter)
  - [ ] Test voltage ranges:
    - [ ] Full charge: 41.5-42V displayed
    - [ ] 50% charge: ~36V displayed
    - [ ] Low battery: Monitor shows 33V warning threshold
  - [ ] Document voltage thresholds for software monitoring (Story 5.6)

- [ ] **Task 10: Cable management** (AC: 10)
  - [ ] Route all power wiring through `cable-channels-torso.stl`
  - [ ] Separate high-current wires from signal wires (prevent EMI)
  - [ ] Add strain relief to all connectors (zip ties, cable clips)
  - [ ] Verify access panel functionality (can access components without full disassembly)
  - [ ] Ensure no pinched wires when torso panels close

- [ ] **Task 11: Documentation** (AC: 11)
  - [ ] Draw power distribution diagram (battery→switch→cutoff→fuses→converters→loads)
  - [ ] Save diagram as `hardware/wiring/power-distribution-diagram.png`
  - [ ] Document buck converter settings (potentiometer positions, output voltages)
  - [ ] Create safety checklist document
  - [ ] Document battery care procedures (charging, storage)
  - [ ] Photograph power system assembly
  - [ ] Save photos to `hardware/wiring/power-system-assembly/`

## Dev Notes

### Lithium Battery Safety - CRITICAL

**BMS (Battery Management System):**
- Integrated BMS monitors each cell (10S configuration = 10 cells in series)
- Protections: Over-voltage (>4.2V/cell), under-voltage (<2.5V/cell), over-current, short-circuit
- Balance charging: BMS equalizes cell voltages during charging
- NEVER bypass BMS or disconnect balance leads

**Voltage Ranges:**
- Full charge: 42.0V (4.2V × 10 cells)
- Nominal: 36.0V (3.6V × 10 cells)
- Low warning: 33.0V (3.3V × 10 cells)
- Critical cutoff: 30.0V (3.0V × 10 cells) - DO NOT discharge below this!

**Safety Rules:**
- NEVER charge unattended initially (monitor first few charges)
- Use fireproof LiPo charging bag or metal container
- Charge in well-ventilated area
- Storage: Store at 50% charge (~36V) if not using for >2 weeks
- Disposal: Take to battery recycling center, never trash

### Buck Converter Selection

**LM2596 vs XL4015:**
- **LM2596:** ~3A continuous, cheaper, widely available
- **XL4015:** ~5-8A continuous, better efficiency, recommended for 5V rail
- Both have thermal shutdown protection
- Both have adjustable output via potentiometer

**Heatsinking:**
- Buck converters generate heat proportional to (Vin - Vout) × Iout
- 36V→5V @ 5A: (36-5) × 5 = 155W input, ~25W heat dissipation
- Ensure heatsink attached, airflow in power enclosure

### Wiring Gauge Calculation

**36V Main Lines (14AWG):**
- 14AWG: 5.9A continuous, 15A max (chassis wiring)
- For 10A total load: 14AWG adequate

**12V/5V Distribution (16AWG):**
- 16AWG: 3.7A continuous, 10A max (chassis wiring)
- For 5V rail @ 10A: 16AWG acceptable for short runs (<1m)

**Voltage Drop:**
- Goal: <0.2V drop on 5V rail (<4% loss)
- 16AWG, 1m length, 10A: ~0.13V drop (acceptable)

### Connector Selection

**XT60 Connectors:**
- Rated: 60A continuous
- Use: Battery → Main distribution
- Polarity: Yellow=positive, black=negative (standard)

**Anderson Powerpole:**
- Rated: 15-45A depending on size
- Use: Distribution → Raspberry Pi, servos
- Advantage: Genderless, can't reverse polarity if assembled correctly

**JST Connectors:**
- Rated: 3A continuous (JST-XH)
- Use: Distribution → ESP32 modules (low current)

### Power Budget

**Current Draw Estimates:**
- Raspberry Pi 4B: 0.8-3A @ 5V (idle to peak)
- ESP32 Head: 0.2A @ 5V
- ESP32 Ears+Neck: 0.3A @ 5V (servos add more)
- ESP32 Body: 0.2A @ 5V
- 7× Servos (SCS0009 + STS3215): 0.5-3A @ 5V (position holding to moving)
- **Total 5V Rail: 3-10A depending on activity**

**Battery Life Calculation:**
- Battery: 4.4Ah @ 36V = 158.4Wh
- Average 5V load: 5A × 5V = 25W
- Efficiency loss: ~20% (buck converter)
- Runtime: 158.4Wh / (25W / 0.8) = ~5 hours active use
- Idle: ~10-12 hours

### File Locations

```
hardware/wiring/
├── power-distribution-diagram.png     # <-- THIS STORY
├── power-system-assembly/             # <-- THIS STORY
│   ├── battery-in-enclosure.jpg
│   ├── distribution-board-closeup.jpg
│   ├── buck-converters-mounted.jpg
│   └── complete-power-system.jpg
```

### Testing

**Safety Checklist Before First Power-On:**
- [ ] All polarity correct (multimeter continuity check)
- [ ] No shorts between power and ground
- [ ] Fuses installed correctly (10A rating verified)
- [ ] Emergency cutoff wired as normally-closed
- [ ] Buck converters output voltages adjusted correctly
- [ ] Battery BMS balance leads intact

**Thermal Monitoring:**
- Use IR thermometer for non-contact measurement
- Check every 5-10 minutes during initial tests
- Acceptable temperatures: <60°C converters, <40°C battery

**Troubleshooting:**
- **5V rail voltage sag:** Increase wire gauge, check buck converter current rating
- **Buck converter overheating:** Add heatsink, improve ventilation
- **Battery not charging:** Check BMS balance leads, verify charger voltage (should be 42V)
- **Fuse blows immediately:** Check for shorts, reduce load current
- **Emergency cutoff doesn't work:** Verify normally-closed button wiring

## Dependencies
- Story 5.1: 3D printed power enclosure and mounting brackets

## Estimated Effort
10-14 hours

## Dev Agent Record

### Agent Model Used
<!-- To be filled by dev agent -->

### Debug Log References
<!-- To be filled by dev agent -->

### Completion Notes List
<!-- To be filled by dev agent -->

### File List
<!-- To be filled by dev agent -->

## QA Results
<!-- To be filled by QA agent -->

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | v1.0 | Initial story creation from Epic 5 | John (Product Manager) |
