# Story 1.3: Head Module - Eye LCD Hardware Assembly

## Status
Draft

## Story
**As a** hardware builder,
**I want** a head module with dual eye LCD displays proving I2C + SPI communication,
**so that** I can validate the architecture with emotion-driven eye expressions.

## Acceptance Criteria

1. **Components Acquired:**
   - 1× ESP32-S3-WROOM-2 (N16R8) or ESP32-WROOM-32
   - 2× GC9A01 Round TFT Display (1.28", 240×240, SPI interface)
   - Jumper wires for SPI + I2C connections
   - Breadboard for prototyping

2. **SPI Eye Display Wiring (ESP32 → 2× GC9A01):**
   - **Left Eye Display:**
     - VCC → 3.3V (ESP32)
     - GND → GND
     - SCL (CLK) → GPIO18 (ESP32 SPI SCK - shared)
     - SDA (MOSI) → GPIO23 (ESP32 SPI MOSI - shared)
     - RES (RST) → GPIO4 (ESP32 reset pin)
     - DC → GPIO2 (ESP32 data/command pin)
     - CS → GPIO5 (ESP32 chip select - Left Eye)
   - **Right Eye Display:**
     - VCC → 3.3V (ESP32 - shared)
     - GND → GND (shared)
     - SCL (CLK) → GPIO18 (ESP32 SPI SCK - shared)
     - SDA (MOSI) → GPIO23 (ESP32 SPI MOSI - shared)
     - RES (RST) → GPIO4 (ESP32 reset pin - shared)
     - DC → GPIO2 (ESP32 data/command pin - shared)
     - CS → GPIO15 (ESP32 chip select - Right Eye)

3. **I2C Wiring (Pi → ESP32):**
   - Pi GPIO2 (SDA) → ESP32 GPIO21 (I2C SDA)
   - Pi GPIO3 (SCL) → ESP32 GPIO22 (I2C SCL)
   - Pi GND → ESP32 GND (common ground)
   - Pi 5V → ESP32 VIN (power from buck converter)

4. **I2C Address Assignment:**
   - ESP32 Head module configured as I2C slave at address **0x08**

5. **Communication Tests:**
   - SPI test: Upload GC9A01 library example, both eyes display at 60 FPS
   - I2C test: `sudo i2cdetect -y 1` shows device at address `0x08`
   - Verify SPI speed: 10-20 MHz clock (smooth animation, no tearing)
   - Test independent chip select: Each eye can be addressed separately

6. **Physical Mounting:**
   - Module secured to breadboard
   - Eye displays positioned side-by-side for visibility
   - Stable wiring, no loose connections

7. **Documentation:**
   - Wiring photos: `hardware/wiring/head-eye-lcd-assembly.jpg`
   - Pin mapping documented in `modules/head/README.md`
   - BOM updated with ESP32, 2× GC9A01 displays, jumper wires

## Tasks / Subtasks

- [ ] **Task 1: Procure components** (AC: 1)
  - [ ] Purchase or verify ESP32-S3-WROOM-2 (N16R8) or ESP32-WROOM-32
  - [ ] Purchase 2× GC9A01 Round TFT Display (1.28", 240×240, SPI)
  - [ ] Gather jumper wires (male-to-male, male-to-female)
  - [ ] Obtain breadboard for prototyping
  - [ ] Verify component specifications match requirements

- [ ] **Task 2: Wire SPI display connections for both eyes** (AC: 2)
  - [ ] **Left Eye (CS: GPIO5):**
    - [ ] Connect GC9A01 VCC → ESP32 3.3V
    - [ ] Connect GC9A01 GND → ESP32 GND
    - [ ] Connect GC9A01 SCL → ESP32 GPIO18 (SPI SCK - shared)
    - [ ] Connect GC9A01 SDA → ESP32 GPIO23 (SPI MOSI - shared)
    - [ ] Connect GC9A01 RES → ESP32 GPIO4 (shared)
    - [ ] Connect GC9A01 DC → ESP32 GPIO2 (shared)
    - [ ] Connect GC9A01 CS → ESP32 GPIO5 (Left Eye CS)
  - [ ] **Right Eye (CS: GPIO15):**
    - [ ] Connect GC9A01 VCC → ESP32 3.3V (shared with left)
    - [ ] Connect GC9A01 GND → ESP32 GND (shared)
    - [ ] Connect GC9A01 SCL → ESP32 GPIO18 (shared)
    - [ ] Connect GC9A01 SDA → ESP32 GPIO23 (shared)
    - [ ] Connect GC9A01 RES → ESP32 GPIO4 (shared)
    - [ ] Connect GC9A01 DC → ESP32 GPIO2 (shared)
    - [ ] Connect GC9A01 CS → ESP32 GPIO15 (Right Eye CS)
  - [ ] Verify all SPI connections secure

- [ ] **Task 3: Wire I2C connection to Raspberry Pi** (AC: 3)
  - [ ] Connect Pi GPIO2 (SDA) → ESP32 GPIO21 (I2C SDA)
  - [ ] Connect Pi GPIO3 (SCL) → ESP32 GPIO22 (I2C SCL)
  - [ ] Connect Pi GND → ESP32 GND (common ground)
  - [ ] Optional for Epic 1: Connect Pi 5V → ESP32 VIN (or use separate USB power)
  - [ ] Verify I2C wiring with continuity tester
  - [ ] Ensure no shorts between SDA/SCL or power/ground

- [ ] **Task 4: Configure I2C address** (AC: 4)
  - [ ] Document head module I2C address: 0x08
  - [ ] Add to `modules/head/firmware/config.h`: `#define I2C_SLAVE_ADDRESS 0x08`
  - [ ] Note address for future firmware implementation (Story 1.4)

- [ ] **Task 5: Test SPI displays** (AC: 5)
  - [ ] Install Arduino IDE or PlatformIO
  - [ ] Install GC9A01 library (Adafruit_GC9A01A or TFT_eSPI)
  - [ ] Upload GC9A01 test sketch with dual CS configuration
  - [ ] Verify both displays show test patterns
  - [ ] Test each eye independently using chip select
  - [ ] Measure SPI clock speed (oscilloscope or logic analyzer, optional)
  - [ ] Target: 10-20 MHz for smooth 60 FPS animation
  - [ ] Observe for tearing or artifacts (should be smooth)

- [ ] **Task 6: Test I2C connection** (AC: 5)
  - [ ] On Raspberry Pi, run: `sudo i2cdetect -y 1`
  - [ ] Note: ESP32 must have I2C slave firmware running (may need basic test firmware)
  - [ ] Alternative: Flash minimal I2C slave sketch that responds to address 0x08
  - [ ] Verify device appears at address 0x08 in i2cdetect grid
  - [ ] If not detected, check wiring and pull-up resistors

- [ ] **Task 7: Physical mounting and cable management** (AC: 6)
  - [ ] Insert ESP32 into breadboard securely
  - [ ] Position both GC9A01 displays side-by-side for visibility
  - [ ] Route SPI wires neatly (keep short to minimize interference)
  - [ ] Route I2C wires separately from SPI (reduce crosstalk)
  - [ ] Verify no loose connections (gently tug wires)
  - [ ] Test stability: move breadboard, verify nothing disconnects

- [ ] **Task 8: Documentation** (AC: 7)
  - [ ] Photograph assembled module from multiple angles
  - [ ] Photograph wiring close-up showing pin connections for both eyes
  - [ ] Save photos to `hardware/wiring/head-eye-lcd-assembly.jpg`
  - [ ] Create or update `modules/head/README.md` with pin mapping
  - [ ] Update `hardware/bom/epic1_bom.csv` with components and costs
  - [ ] Document supplier links (AliExpress, Adafruit, Amazon)

## Dev Notes

### Previous Story Insights
From Story 1.1 (Repository Setup):
- Repository structure created with modules/head/ directory
- `shared/i2c_registers.h` created with common I2C register definitions

From Story 1.2 (Raspberry Pi ROS2 Setup):
- I2C enabled on Raspberry Pi at /dev/i2c-1
- I2C bus accessible via GPIO2 (SDA) and GPIO3 (SCL)
- User added to i2c group for permissions
- i2c-tools installed for testing (i2cdetect, i2cget, i2cset)

### Technology Stack
[Source: docs/architecture/tech-stack.md]

**Module Hardware:**
- **MCU:** ESP32-S3-WROOM-2 (N16R8) or ESP32-WROOM-32
  - ESP32-S3 preferred: Dual-core @ 240MHz, 512KB SRAM, 8MB PSRAM, 16MB Flash
  - Pin count: 45 GPIO (enough for dual SPI displays + I2C + future expansion)
- **Display:** 2× GC9A01 Round TFT Display
  - Size: 1.28" diagonal each
  - Resolution: 240×240 pixels each
  - Interface: SPI (10-20 MHz for 60 FPS)
  - Colors: 65K (RGB565)

**Communication:**
- **I2C:** 400kHz-1MHz, head module address 0x08
- **SPI:** 10-20 MHz for dual display rendering

### Component Specifications
[Source: docs/architecture/components.md#head-module]

**Head Module Hardware:**
- ESP32-S3-WROOM-2 (N16R8: 16MB Flash, 8MB PSRAM)
- 2× GC9A01 Round TFT Display (1.28", 240×240, SPI)

**I2C Address:** 0x08

**Responsibilities (deferred to Story 1.4 firmware):**
- Dual eye LCD displays with emotion-driven expressions
- 60 FPS animation rendering on both displays
- Synchronized eye animations

### Pin Assignments

**SPI Display Wiring (ESP32 → 2× GC9A01):**

**Shared Signals:**
| GC9A01 Pin | Function | ESP32 GPIO | Notes |
|------------|----------|------------|-------|
| VCC | Power | 3.3V | Both displays share power |
| GND | Ground | GND | Common ground |
| SCL (CLK) | SPI Clock | GPIO18 | Shared between both displays |
| SDA (MOSI) | SPI Data | GPIO23 | Shared between both displays |
| RES (RST) | Reset | GPIO4 | Shared - both displays reset together |
| DC | Data/Command | GPIO2 | Shared |

**Individual Chip Select (CS) Pins:**
| Display | CS Pin | ESP32 GPIO | Notes |
|---------|--------|------------|-------|
| Left Eye | CS | GPIO5 | Independently selectable |
| Right Eye | CS | GPIO15 | Independently selectable |

**I2C Wiring (Raspberry Pi → ESP32):**
| Pi Pin | Function | ESP32 GPIO | Notes |
|--------|----------|------------|-------|
| GPIO2 | I2C SDA | GPIO21 | Standardized I2C SDA |
| GPIO3 | I2C SCL | GPIO22 | Standardized I2C SCL |
| GND | Ground | GND | **Critical: Common ground required** |
| 5V (optional) | Power | VIN | Epic 1: Can use USB power instead |

**Power Options for Epic 1:**
- **Option 1:** USB power bank → ESP32 USB port (simplest for testing)
- **Option 2:** Raspberry Pi 5V pin → ESP32 VIN (shared power)
- **Option 3:** Separate bench power supply → ESP32 VIN

### I2C Address Map
[Source: docs/architecture/data-models.md]

**Epic 1 Modules:**
- **0x08:** Head module (dual eye LCDs)

**Future Modules (Epic 2+):**
- 0x09: Ears+Neck module (servos)
- 0x0A: Body module (heart LCD, projector control, LEDs)
- 0x0B: Base module (self-balancing)

### SPI Communication Details

**Dual Display Strategy:**
- Both displays share SCK, MOSI, DC, RST signals
- Each display has independent CS (Chip Select)
- Only one display active at a time (via CS pin)
- Rendering strategy: Update left eye, update right eye, repeat

**SPI Speed Considerations:**
- **10 MHz:** Conservative, guaranteed stable for dual displays
- **20 MHz:** Optimal for 60 FPS on dual 240×240 displays
- **Higher speeds:** May work but risk signal integrity issues with jumper wires

**Jumper Wire Limitations:**
- Keep SPI wires short (<15cm recommended)
- Avoid running parallel to I2C wires (crosstalk)
- Twisted pair for CLK/MOSI reduces EMI

**Frame Rate Calculation (Dual Displays):**
- 240×240 pixels = 57,600 pixels/display
- 2 displays = 115,200 pixels total/frame
- RGB565 = 2 bytes/pixel = 230,400 bytes/frame
- At 20 MHz SPI: ~87 frames/second max (60 FPS achievable)

### I2C Communication Details

**I2C Pull-up Resistors:**
- Raspberry Pi has internal 1.8kΩ pull-ups on I2C pins
- ESP32 has internal pull-ups (can be enabled in firmware)
- External 4.7kΩ pull-ups recommended for longer wires (>30cm) or multiple devices

**I2C Speed:**
- Standard mode: 100 kHz
- Fast mode: 400 kHz (recommended for Epic 1)
- Fast mode plus: 1 MHz (optional, test stability)

**Testing I2C Without Firmware:**
- ESP32 needs minimal I2C slave firmware to respond to i2cdetect
- Alternative: Test continuity and voltage levels with multimeter
- Full I2C validation deferred to Story 1.4 (firmware)

### File Locations
[Source: docs/architecture/source-tree.md]

**Documentation Paths:**
```
hardware/
├── wiring/
│   └── head-eye-lcd-assembly.jpg      # <-- THIS STORY
├── bom/
│   └── epic1_bom.csv                  # <-- THIS STORY (update)
└── photos/
    └── epic1/                         # <-- THIS STORY

modules/head/
├── README.md                          # <-- THIS STORY (create/update)
└── firmware/                          # Future: Story 1.4
```

### BOM Update Template

Add to `hardware/bom/epic1_bom.csv`:

```csv
Item,Description,Quantity,Supplier,Link,Cost (USD),Notes
ESP32-S3-WROOM-2,ESP32 dev board N16R8,1,AliExpress,https://...,4.50,16MB Flash 8MB PSRAM
GC9A01,Round TFT 1.28" 240x240,2,Adafruit,https://...,30.00,SPI interface (2 displays)
Jumper Wires,Male-to-male 20cm,30,Amazon,https://...,5.00,For breadboard (dual displays)
Breadboard,830 tie-points,1,Amazon,https://...,5.00,Full-size recommended for dual displays
USB Power Bank,5V 2A output,1,Any,N/A,10.00,Temporary power for Epic 1
```

### Testing

**SPI Display Test (AC: 5):**
1. Install GC9A01 library in Arduino IDE or PlatformIO
2. Configure library for dual CS pins (GPIO5 and GPIO15)
3. Upload test sketch that alternates between eyes
4. Observe both displays showing test patterns (lines, circles, text)
5. Test independent addressing (left eye only, right eye only, both)
6. Success: Both displays show clear graphics at 60 FPS (smooth animation)
7. Failure indicators: Blank screen, garbage pixels, flickering, only one eye working

**I2C Connection Test (AC: 5):**
1. Flash minimal I2C slave firmware to ESP32 (respond at 0x08)
2. On Raspberry Pi: `sudo i2cdetect -y 1`
3. Expected output: Grid showing "08" at row 00, column 08
4. Success: Device detected at 0x08
5. Failure: Empty grid or "UU" (indicates wiring issue or firmware not running)

**Troubleshooting:**
- **One or both displays blank:** Check VCC/GND, verify SPI wiring, check library configuration
- **One display works, other doesn't:** Verify CS pins (GPIO5 vs GPIO15), check individual display wiring
- **Displays show garbage:** Reduce SPI speed, check wire length, verify pin assignments
- **Eyes not synchronized:** Check CS logic in test firmware, verify shared signal integrity
- **I2C not detected:** Check common ground, verify SDA/SCL not swapped, check pull-ups
- **Intermittent connection:** Loose jumper wires, poor breadboard contact

### Power Constraints (Epic 1)
[Source: Epic 1 notes]

**Temporary Power Setup:**
- Raspberry Pi: Official USB-C power supply (5A recommended)
- ESP32 + 2× GC9A01: USB power bank (5V 2A) or bench power supply
- **No integrated power system in Epic 1** (full power system deferred to Epic 5)

**Current Draw Estimates:**
- ESP32-S3: ~200-300mA active, ~500mA peak
- 2× GC9A01 Displays: ~200-300mA total (backlight + logic for both)
- **Total:** ~500-600mA typical, ~800mA peak
- USB power bank (2A rated) provides adequate margin

## Dev Agent Record

### Agent Model Used
<!-- To be filled by dev agent -->

### Debug Log References
<!-- To be filled by dev agent -->

### Completion Notes List
<!-- To be filled by dev agent -->

### File List
<!-- To be filled by dev agent -->

## QA Results
<!-- To be filled by QA agent -->

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | v1.0 | Initial story draft | Bob (Scrum Master) |
| 2025-10-25 | v1.1 | Updated from heart LCD to dual eye LCDs, Head Module 0x08 | Bob (Scrum Master) |
