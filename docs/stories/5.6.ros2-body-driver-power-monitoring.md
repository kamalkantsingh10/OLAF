# Story 5.6: ROS2 Body Driver Node & Power Monitoring

## Status
Draft

## Story
**As a** software developer,
**I want** ROS2 driver node for Body Module (heart display) and power system monitoring,
**so that** the orchestrator can control body expressions and monitor battery health.

## Acceptance Criteria

1. **Node Structure:**
   - Python ROS2 node: `ros2/src/orchestrator/ros2_nodes/hardware_drivers/body_driver.py`
   - Node name: `/olaf/body_driver`
   - Uses `rclpy` and `smbus2`

2. **I2C Communication:**
   - Opens I2C bus 1: `bus = SMBus(1)`
   - Helper functions for register read/write to address **0x0A**

3. **ROS2 Subscriptions:**
   - `/olaf/body/heart_animation` (custom msg: mode, bpm, color_hue, brightness)
     - Callback writes to registers 0x10-0x13 (animation control)
   - `/olaf/body/display_power` (std_msgs/Bool)
     - Callback writes to register 0x20 (display on/off)

4. **ROS2 Publications:**
   - `/olaf/body/status` (std_msgs/String) at 10Hz
     - Reads status register 0x02, publishes "READY", "BUSY", or "ERROR"
   - `/olaf/body/current_animation` (custom msg) at 1Hz
     - Reads registers 0x10-0x13, publishes current animation state
   - `/olaf/power/battery_voltage` (std_msgs/Float32) at 1Hz
     - Reads battery voltage via ADC or I2C voltage sensor module
     - Publishes voltage in volts (e.g., 36.5V)
   - `/olaf/power/battery_percentage` (std_msgs/UInt8) at 1Hz
     - Calculates percentage: 30V=0%, 42V=100% (linear approximation)
     - Publishes 0-100%

5. **Power Monitoring Implementation:**
   - **Option A: ADC Voltage Divider:**
     - 36V battery → Voltage divider (10kΩ + 1kΩ) → Pi GPIO ADC (3.3V max)
     - Ratio: 36V → 3.27V (11:1 divider)
     - Read ADC: Convert to voltage using calibration factor
   - **Option B: I2C Voltage Sensor:**
     - INA219/INA226 current/voltage sensor module on I2C bus
     - Read voltage register (more accurate than ADC)
     - Bonus: Also reads current draw (future feature)
   - Calibration: Measure actual battery voltage with multimeter, adjust software calibration constant

6. **Battery Health Warnings:**
   - **Low Battery Warning:**
     - Voltage <33V: Publish `/olaf/warnings/low_battery` (std_msgs/String: "Low battery - 33V")
     - Trigger visual/audio warning (future: make heart pulse red rapidly)
   - **Critical Battery Shutdown:**
     - Voltage <30V: Publish `/olaf/warnings/critical_battery` (std_msgs/String: "Critical - shutdown now!")
     - Initiate graceful shutdown sequence (future Epic 13 integration)
   - **Overvoltage Warning:**
     - Voltage >43V: Publish warning (indicates charger malfunction or BMS failure)

7. **Module Health Check:**
   - On startup: Read register 0x00, verify response is 0x0A
   - If not responding: Log error, publish ERROR status
   - Periodic health check: Every 30s verify module responsive

8. **Error Handling:**
   - I2C timeout handling (module busy during animation rendering)
   - Retry logic: 3 attempts with 100ms delay
   - Persistent failure: Publish ERROR, log details
   - ADC read errors: Log warning, use last known voltage (don't crash)

9. **Testing:**
   - Node launches: `ros2 run orchestrator body_driver`
   - Topics appear: `/olaf/body/heart_animation`, `/olaf/power/battery_voltage`
   - **Heart Animation Tests:**
     - Publish mode 1 (idle pulse): Heart beats at 60 BPM
     - Publish mode 2 (excited): Heart beats faster
     - Publish custom: BPM 90, hue 180 (cyan heart) → heart animates in cyan at 90 BPM
     - Publish brightness 128: Heart dims
   - **Power Monitoring Tests:**
     - Battery at full charge (~42V): `/olaf/power/battery_voltage` publishes 42.0
     - Battery at ~50% (~36V): `/olaf/power/battery_percentage` publishes 50
     - Discharge battery below 33V: Low battery warning published
   - **Display Control:**
     - Publish display_power False: Heart LCD turns off (backlight off)
     - Publish display_power True: Heart LCD turns on

10. **Integration Testing:**
    - Combined test: Publish heart animation while monitoring battery voltage → both work simultaneously
    - Latency: Animation command → visible change <100ms
    - Reliability: 50 animation mode changes without failure

11. **Code Quality:**
    - File: `body_driver.py`
    - Message definitions:
      - `orchestrator/msg/HeartAnimation.msg`
      - Reuse or create battery messages
    - Comments explain power monitoring approach (ADC or I2C sensor)
    - Voltage calculation calibration constants documented
    - Code committed to `ros2/src/orchestrator/ros2_nodes/hardware_drivers/`

## Tasks / Subtasks

[Detailed tasks would follow the same pattern as previous stories]

## Dependencies
- Story 5.5: Body Module firmware
- Story 5.3: Power system for voltage monitoring
- Story 5.4: Raspberry Pi integration

## Estimated Effort
6-8 hours

## Dev Agent Record

### Agent Model Used
<!-- To be filled by dev agent -->

### Debug Log References
<!-- To be filled by dev agent -->

### Completion Notes List
<!-- To be filled by dev agent -->

### File List
<!-- To be filled by dev agent -->

## QA Results
<!-- To be filled by QA agent -->

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | v1.0 | Initial story creation from Epic 5 | John (Product Manager) |
