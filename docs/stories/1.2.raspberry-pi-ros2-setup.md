

# Story 1.3: Raspberry Pi ROS2 Setup (I2C Master)

## Status
Draft

## Story

**As a** robotics developer,
**I want** ROS2 Humble installed on Raspberry Pi 5 with I2C enabled,
**so that** I can run orchestrator nodes and communicate with ESP32 modules via I2C.

## Acceptance Criteria

1. **OS Installation:**
   - Raspberry Pi OS (64-bit, Debian 12 Bookworm) flashed to microSD (64GB+)
   - Pi boots successfully, SSH enabled
   - WiFi configured for cloud API access (Pi only, NOT for ESP32 communication)
   - Static IP optional but recommended

2. **ROS2 Installation:**
   - ROS2 Humble installed: `sudo apt install ros-humble-desktop`
   - Environment sourced: `source /opt/ros/humble/setup.bash` added to `.bashrc`
   - Verification: `ros2 --version` shows "humble"

3. **I2C Configuration:**
   - I2C enabled via `raspi-config`: Interface Options → I2C → Enable
   - I2C device visible: `ls /dev/i2c-*` shows `/dev/i2c-1`
   - I2C tools installed: `sudo apt install i2c-tools`
   - I2C permissions: User added to `i2c` group: `sudo usermod -a -G i2c $USER`

4. **Python I2C Library:**
   - `smbus2` installed: `pip3 install smbus2`
   - Test script can open I2C bus:
     ```python
     from smbus2 import SMBus
     bus = SMBus(1)  # I2C bus 1
     print("I2C bus opened successfully")
     ```

5. **Development Tools:**
   - Python 3.11+ (comes with Pi OS)
   - `colcon` installed: `sudo apt install python3-colcon-common-extensions`
   - Git installed and configured

6. **Repository Clone:**
   - Repo cloned to Pi: `git clone <repo_url> ~/olaf`
   - Directory structure visible

7. **Documentation:**
   - Setup script: `tools/setup/install_ros2_humble_pi.sh` automates ROS2 + I2C setup
   - README updated with Pi setup instructions
   - I2C troubleshooting notes added

## Tasks / Subtasks

### Task 1: Flash Raspberry Pi OS and initial setup (AC: 1)
- [ ] Download Raspberry Pi OS (64-bit, Debian 12 Bookworm) image
- [ ] Flash image to microSD card (64GB+ recommended) using Raspberry Pi Imager
- [ ] Configure Pi Imager pre-boot settings: hostname, SSH enable, WiFi credentials, username/password
- [ ] Insert microSD into Pi 5, connect power, boot
- [ ] SSH into Pi: `ssh username@hostname.local` or `ssh username@<ip_address>`
- [ ] Verify OS version: `cat /etc/os-release` (should show Debian 12 Bookworm)
- [ ] Update system: `sudo apt update && sudo apt upgrade -y`
- [ ] Optional: Configure static IP in `/etc/dhcpcd.conf` or via router DHCP reservation

### Task 2: Install ROS2 Humble (AC: 2)
- [ ] Add ROS2 apt repository key and source list (follow official ROS2 Humble installation guide)
- [ ] Update apt: `sudo apt update`
- [ ] Install ROS2 Humble Desktop: `sudo apt install ros-humble-desktop -y`
- [ ] Source ROS2 environment: `source /opt/ros/humble/setup.bash`
- [ ] Verify installation: `ros2 --version` (should show "ros2 doctor 0.10.x" and "humble")
- [ ] Add ROS2 environment to `.bashrc`: `echo "source /opt/ros/humble/setup.bash" >> ~/.bashrc`
- [ ] Test ROS2: `ros2 topic list` (should show `/parameter_events`, `/rosout`)

### Task 3: Enable and configure I2C (AC: 3)
- [ ] Run `sudo raspi-config`
- [ ] Navigate to "Interface Options" → "I2C" → Select "Yes" to enable
- [ ] Reboot Pi: `sudo reboot`
- [ ] After reboot, verify I2C device exists: `ls /dev/i2c-*` (expect `/dev/i2c-1`)
- [ ] Install I2C tools: `sudo apt install i2c-tools -y`
- [ ] Test I2C scan (no devices expected yet): `sudo i2cdetect -y 1`
- [ ] Add user to `i2c` group for non-root access: `sudo usermod -a -G i2c $USER`
- [ ] Log out and log back in (or reboot) for group membership to take effect
- [ ] Verify permissions: `groups` (should include `i2c`)

### Task 4: Install Python I2C library (AC: 4)
- [ ] Verify Python 3.11+ installed: `python3 --version`
- [ ] Install pip if not present: `sudo apt install python3-pip -y`
- [ ] Install smbus2: `pip3 install smbus2`
- [ ] Create test script `test_i2c_open.py` with content from AC #4
- [ ] Run test script: `python3 test_i2c_open.py`
- [ ] Verify output: "I2C bus opened successfully"
- [ ] Clean up test script (optional, can keep for troubleshooting)

### Task 5: Install development tools (AC: 5)
- [ ] Verify Python 3.11+: `python3 --version` (should be 3.11.x from Pi OS)
- [ ] Install colcon build tool: `sudo apt install python3-colcon-common-extensions -y`
- [ ] Verify colcon: `colcon --version`
- [ ] Install Git: `sudo apt install git -y` (likely already installed)
- [ ] Configure Git user: `git config --global user.name "Your Name"`
- [ ] Configure Git email: `git config --global user.email "your@email.com"`
- [ ] Optional: Install additional ROS2 dev tools: `sudo apt install ros-humble-rqt* python3-rosdep -y`

### Task 6: Clone OLAF repository (AC: 6)
- [ ] Navigate to home directory: `cd ~`
- [ ] Clone repository: `git clone <repo_url> olaf` (replace `<repo_url>` with actual GitHub URL)
- [ ] Navigate into repo: `cd olaf`
- [ ] Verify directory structure: `ls -la` (should show docs/, modules/, orchestrator/, etc.)
- [ ] Verify repo status: `git status` (should be on main branch, up to date)

### Task 7: Create automated setup script (AC: 7)
- [ ] Create `tools/setup/` directory (if not exists from Story 1.1)
- [ ] Create `tools/setup/install_ros2_humble_pi.sh` script
- [ ] Script contents: Automate tasks 2-5 (ROS2 install, I2C enable, smbus2, colcon, git)
- [ ] Add shebang: `#!/bin/bash`
- [ ] Add error handling: `set -e` (exit on error)
- [ ] Add user prompts for interactive steps (e.g., WiFi config, hostname)
- [ ] Make script executable: `chmod +x tools/setup/install_ros2_humble_pi.sh`
- [ ] Test script on fresh Pi (if possible) or verify each command manually

### Task 8: Update documentation (AC: 7)
- [ ] Update `README.md` with "Raspberry Pi Setup" section
- [ ] Document quick setup steps: Flash OS → Run setup script → Clone repo
- [ ] Add detailed setup instructions: Link to `tools/setup/README.md`
- [ ] Create `tools/setup/README.md` with setup script usage and troubleshooting
- [ ] Add I2C troubleshooting section: Common issues (permissions, device not found, scan fails)
- [ ] Document static IP configuration (optional but recommended)
- [ ] Add links to official ROS2 Humble documentation

## Dev Notes

### Raspberry Pi Platform Overview

OLAF uses **Raspberry Pi 5 8GB** as the orchestration layer, running **ROS2 Humble** on **Debian 12 Bookworm (64-bit)**. The Pi acts as the **I2C master** coordinating all ESP32 modules.

**Key Specifications:**
- **Compute:** Quad-core ARM Cortex-A76 @ 2.4GHz
- **Memory:** 8GB RAM
- **AI Accelerator:** Hailo-8L AI Kit (13 TOPS, PCIe interface)
- **Storage:** 128GB microSD card (minimum 64GB)
- **Network:** WiFi (2.4/5GHz) for cloud API access ONLY
- **I2C:** Hardware I2C bus 1 (`/dev/i2c-1`) at 400kHz-1MHz

**Why Raspberry Pi 5?**
- Sufficient compute for ROS2 orchestration + local AI inference (Hailo)
- Native I2C hardware support (reliable, low latency)
- USB 3.0 for RGBD camera, microphone array
- PCIe for Hailo AI accelerator
- Mature ROS2 support (official Humble packages for ARM64)

[Source: docs/architecture/high-level-architecture.md#platform-and-infrastructure-choice]

### ROS2 Humble Rationale

**Why ROS2 Humble?**
- **LTS Release:** Long-term support until 2027 (stable, well-tested)
- **Pi OS Compatibility:** Official ARM64 Debian packages available
- **Mature Ecosystem:** Nav2, Cartographer, rqt tools fully supported
- **Python 3.11 Support:** Matches Pi OS default Python version

**ROS2 Role in Architecture:**
- **ALL** ROS2 nodes run on Raspberry Pi (ESP32s are NOT ROS2 nodes)
- **Driver nodes** act as I2C bridges (translate ROS2 topics → I2C register writes)
- **Application nodes** handle personality coordination, AI integration, SLAM navigation
- **Communication:** Pub/sub pattern for asynchronous, decoupled node communication

[Source: docs/architecture/tech-stack.md#technology-stack-table]
[Source: docs/architecture/ros2-node-architecture.md#node-structure]

### I2C Communication Architecture

**I2C Bus Configuration:**
- **Bus:** I2C bus 1 (`/dev/i2c-1`) on Pi GPIO pins 2 (SDA) and 3 (SCL)
- **Speed:** 400kHz-1MHz (configurable in `/boot/config.txt`)
- **Topology:** Multi-master bus with Pi as master, 5 ESP32 modules as slaves
- **Addresses:** 0x08 (Head), 0x09 (Ears), 0x0A (Neck), 0x0B (Projector), 0x0C (Base)

**Why I2C-Only (No WiFi on ESP32s)?**
- **Latency:** I2C achieves 5-20ms vs 80-200ms for WiFi/ROS2
- **Deterministic:** Wired connection eliminates packet loss, jitter
- **Simplicity:** No WiFi credentials, no network stack on ESP32s
- **Power Efficiency:** I2C draws minimal power vs WiFi radio
- **Security:** No wireless attack surface on critical modules

**I2C Communication Flow:**
```
ROS2 Application Node (Python)
       ↓ publishes to topic
ROS2 Driver Node (Python + smbus2)
       ↓ writes I2C register
ESP32 Module (I2C Slave @ 0x08-0x0C)
       ↓ interrupt handler
Hardware Driver (Animation, Servo, Motor)
```

[Source: docs/architecture/high-level-architecture.md#high-level-architecture-diagram]
[Source: docs/architecture/tech-stack.md#module-communication]

### Smart Peripheral Pattern

ESP32 modules are **smart I2C slaves** containing full hardware drivers, animation engines, and real-time control loops. The Pi sends only **high-level semantic commands** (e.g., "express happy level 3", "move forward 0.5 m/s").

**Intelligence Distribution:**
| Task | Raspberry Pi | ESP32 |
|------|--------------|-------|
| AI Reasoning | ✅ Claude/GPT-4 | ❌ |
| Personality Logic | ✅ Choose emotion | ❌ |
| SLAM Navigation | ✅ Map building | ❌ |
| Animation Rendering | ❌ | ✅ Stores frames, renders pixels |
| Servo Control | ❌ | ✅ PWM generation |
| Self-Balancing PID | ❌ | ✅ 200Hz control loop |
| Sensor Polling | ❌ | ✅ mmWave, IMU |
| Display Driver | ❌ | ✅ SPI protocol |

**Benefits:**
- Offloads real-time tasks from Linux-based Pi (Linux cannot guarantee hard real-time)
- Reduces I2C traffic (send "happy", not 100 animation frames)
- Enables autonomous execution (ESP32 continues animating even if Pi crashes)

[Source: docs/architecture/ros2-node-architecture.md#intelligence-distribution]

### I2C Register Protocol

All ESP32 modules implement a **common register map** defined in `shared/i2c_registers.h` (created in Story 1.1).

**Common Registers (All Modules):**
```cpp
#define REG_MODULE_ID           0x00  // Read-only: 0x08-0x0C
#define REG_FIRMWARE_VERSION    0x01  // Read-only: Major.minor
#define REG_STATUS              0x02  // Read-only: READY/BUSY/ERROR flags
#define REG_COMMAND             0x04  // Write: Command trigger
```

**Status Flags:**
```cpp
#define STATUS_READY    0x01  // Module ready to receive commands
#define STATUS_BUSY     0x02  // Processing command/animation
#define STATUS_ERROR    0x04  // Error condition
```

**Module-Specific Registers:**
- **Head (0x08):** REG_EXPRESSION_TYPE (0x10), REG_BLINK_TRIGGER (0x12)
- **Base (0x0C):** REG_TARGET_VELOCITY (0x10), REG_BALANCE_STATE (0x20)

Full register maps documented in `docs/architecture/data-models.md`.

[Source: docs/architecture/data-models.md#i2c-register-map-standard---all-modules]

### Python smbus2 Library

`smbus2` is the Python library for I2C communication on Pi. It's a pure-Python rewrite of the original `smbus` C extension.

**Why smbus2?**
- **Pure Python:** Cross-platform, no C compilation required
- **Simple API:** `write_byte_data()`, `read_byte_data()`, `write_i2c_block_data()`
- **Widely Used:** Standard choice for Raspberry Pi I2C projects
- **Active Maintenance:** Regular updates, Python 3.11 compatible

**Basic Usage:**
```python
from smbus2 import SMBus

# Open I2C bus 1
bus = SMBus(1)

# Write to Head module (0x08), register 0x12 (blink trigger)
bus.write_byte_data(0x08, 0x12, 0x01)

# Read status from Head module
status = bus.read_byte_data(0x08, 0x02)

bus.close()
```

[Source: docs/architecture/tech-stack.md#i2c-library-pi]

### I2C Permissions Configuration

By default, I2C devices on Linux require root access (`/dev/i2c-1` owned by root:i2c, mode 0660). Adding the user to the `i2c` group enables non-root access.

**Why Non-Root Access?**
- ROS2 nodes run as user, not root (security best practice)
- Simplifies testing (no `sudo` required for every command)
- Enables systemd services running as user

**Group Membership:**
```bash
sudo usermod -a -G i2c $USER  # Add user to i2c group
groups                         # Verify membership (after logout/login)
```

**Verification:**
```bash
ls -l /dev/i2c-1
# Expected output: crw-rw---- 1 root i2c 89, 1 Oct 12 10:00 /dev/i2c-1
```

[Source: docs/prd/epic-01-foundation.md#story-13-acceptance-criteria-3]

### Raspberry Pi OS Debian 12 Bookworm

**OS Choice Rationale:**
- **Official Support:** Raspberry Pi Foundation's reference OS
- **Debian 12 Base:** Stable, well-tested, ROS2 Humble compatible
- **Python 3.11 Default:** Matches ROS2 Humble requirements
- **64-bit ARM:** Required for ROS2 Humble (no 32-bit ARM support)

**Pi OS vs Ubuntu:**
- Pi OS has better hardware support (firmware, drivers optimized by RPi Foundation)
- Ubuntu Server alternative viable, but Pi OS preferred for desktop tools (rqt)

[Source: docs/architecture/tech-stack.md#orchestrator-os]

### WiFi Usage Policy

**CRITICAL:** WiFi on Raspberry Pi is for **cloud API access ONLY** (Claude/GPT-4). ESP32 modules do NOT use WiFi.

**WiFi Purpose:**
- HTTPS requests to Anthropic Claude API
- HTTPS requests to OpenAI GPT-4 API (future)
- SSH access for development (optional, can use Ethernet)
- OTA firmware downloads (optional, can use local HTTP)

**Why NOT WiFi for ESP32 Communication?**
- Adds 80-200ms latency vs 5-20ms for I2C
- Requires network stack on ESP32 (memory overhead, complexity)
- Introduces packet loss, jitter (non-deterministic)
- Requires WiFi credentials on all modules (security risk)

[Source: docs/architecture/high-level-architecture.md#high-level-architecture-diagram]

### Development Tools Overview

**colcon:**
- ROS2 standard build tool (replaces `catkin` from ROS1)
- Builds ROS2 packages in workspace (`colcon build`)
- Sources workspace overlays (`source install/setup.bash`)

**Python 3.11:**
- Default Python version in Pi OS Debian 12 Bookworm
- ROS2 Humble requires Python 3.10+ (3.11 fully compatible)

**Git:**
- Version control for OLAF monorepo
- Essential for Story 1.6+ (cloning repo, tracking changes)

[Source: docs/architecture/tech-stack.md#build-tool-orchestrator]

### Repository Structure on Pi

After cloning, the Pi will have the full monorepo at `~/olaf/`:

```
~/olaf/
├── orchestrator/           # Pi software (ROS2 nodes)
│   ├── ros2_nodes/
│   ├── launch/
│   ├── config/
│   └── requirements.txt
├── modules/                # ESP32 firmware (compiled on dev machine, not Pi)
├── hardware/               # 3D models, wiring (reference only)
├── docs/                   # Documentation
└── tools/                  # Setup scripts, diagnostics
```

**Key Directories for Pi:**
- `orchestrator/`: All Python ROS2 code runs here
- `tools/`: Setup and diagnostic scripts
- `docs/`: Architecture and API documentation

[Source: docs/architecture/source-tree.md#orchestrator---raspberry-pi-software-pythonros2]

### Automated Setup Script Strategy

The `install_ros2_humble_pi.sh` script automates tasks 2-5 to enable rapid Pi setup.

**Script Responsibilities:**
1. Check prerequisites (Debian 12, 64-bit, internet connection)
2. Install ROS2 Humble (add apt repo, install desktop package)
3. Enable I2C (modify `/boot/config.txt`, load kernel module)
4. Install smbus2 (pip3 install)
5. Install colcon (apt install)
6. Configure user permissions (add to i2c group)
7. Update `.bashrc` (source ROS2 environment)

**Error Handling:**
- Check return codes after each command
- Print clear error messages on failure
- Prompt user for confirmation before irreversible changes

**Usage:**
```bash
cd ~/olaf
./tools/setup/install_ros2_humble_pi.sh
# Follow prompts, reboot when instructed
```

[Source: docs/prd/epic-01-foundation.md#story-13-acceptance-criteria-7]

### I2C Troubleshooting Guide

**Common Issues:**

1. **`/dev/i2c-1` not found:**
   - Cause: I2C not enabled in `raspi-config`
   - Solution: Run `sudo raspi-config` → Interface Options → I2C → Enable → Reboot

2. **Permission denied on `/dev/i2c-1`:**
   - Cause: User not in `i2c` group
   - Solution: `sudo usermod -a -G i2c $USER` → Logout/login

3. **`i2cdetect` shows no devices:**
   - Expected at this story (no ESP32s connected yet)
   - Verify with Story 1.4+ when Head module assembled

4. **`smbus2` import fails:**
   - Cause: Not installed or wrong Python version
   - Solution: `pip3 install smbus2` → Verify `python3 --version` is 3.11+

[Source: docs/prd/epic-01-foundation.md#story-13-acceptance-criteria-7]

### Project Structure Alignment

**Files Created/Modified in This Story:**
- OS: Raspberry Pi OS flashed to microSD
- Software: ROS2 Humble, smbus2, colcon installed
- Configuration: I2C enabled, user permissions configured
- Repository: Cloned to `~/olaf/`
- Documentation: `tools/setup/install_ros2_humble_pi.sh`, `tools/setup/README.md`, updated `README.md`

**Directory Structure (relevant to this story):**
```
~/olaf/
├── tools/
│   └── setup/
│       ├── install_ros2_humble_pi.sh  # NEW
│       └── README.md                  # NEW
└── README.md                          # UPDATED
```

[Source: docs/architecture/source-tree.md#tools---utilities-and-scripts]

## Testing

### Testing Standards

**Test Approach:** Manual validation of installation and configuration

**Required Test Steps:**

1. **OS Verification:**
   - Command: `cat /etc/os-release`
   - Expected: `PRETTY_NAME="Debian GNU/Linux 12 (bookworm)"`, `VARIANT="Raspberry Pi OS"`
   - Command: `uname -m`
   - Expected: `aarch64` (64-bit ARM)

2. **ROS2 Verification:**
   - Command: `ros2 --version`
   - Expected: Output includes "humble"
   - Command: `ros2 topic list`
   - Expected: `/parameter_events`, `/rosout` appear

3. **I2C Verification:**
   - Command: `ls /dev/i2c-*`
   - Expected: `/dev/i2c-1` exists
   - Command: `groups`
   - Expected: Output includes `i2c`
   - Command: `i2cdetect -y 1`
   - Expected: Grid displays (no devices expected at this story)

4. **Python I2C Library Verification:**
   - Create test script `test_i2c_open.py` with content from AC #4
   - Command: `python3 test_i2c_open.py`
   - Expected: "I2C bus opened successfully"

5. **Development Tools Verification:**
   - Command: `python3 --version`
   - Expected: `Python 3.11.x`
   - Command: `colcon --version`
   - Expected: Version output (e.g., `colcon version 0.12.x`)
   - Command: `git --version`
   - Expected: Version output

6. **Repository Clone Verification:**
   - Command: `ls ~/olaf/`
   - Expected: `docs/`, `modules/`, `orchestrator/`, `tools/`, etc.
   - Command: `cd ~/olaf && git status`
   - Expected: On branch `main`, up to date

**Pass Criteria:**
- All acceptance criteria met (AC 1-7)
- ROS2 commands execute without errors
- I2C device accessible without sudo
- smbus2 imports successfully
- Repository cloned and directory structure correct

**Test Documentation:**
- Screenshot of `ros2 --version` output
- Screenshot of `i2cdetect -y 1` output
- Note any issues encountered and resolutions

[Source: docs/architecture/coding-standards.md#testing-standards]

## Change Log

| Date       | Version | Description                          | Author          |
|------------|---------|--------------------------------------|-----------------|
| 2025-10-12 | v1.0    | Initial story draft created          | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*This section will be populated by the QA agent after story completion.*
