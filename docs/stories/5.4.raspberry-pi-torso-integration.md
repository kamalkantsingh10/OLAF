# Story 5.4: Raspberry Pi Integration & Torso Assembly

## Status
Draft

## Story
**As a** hardware builder,
**I want** Raspberry Pi mounted in torso with all connections,
**so that** the orchestrator is integrated with power and body module.

## Acceptance Criteria

1. **Component Preparation:**
   - Raspberry Pi 4B (or Pi 5) with heatsinks/fan (optional but recommended)
   - MicroSD card (64GB, ROS2 + orchestrator software from Epic 1)
   - USB cables: Conference mic+speaker (Epic 3 note: audio is USB-based)
   - I2C wiring to Body Module ESP32 (from Story 5.2)
   - I2C bus from Epic 3: Head (0x08), Ears+Neck (0x09) already connected

2. **Raspberry Pi Mounting:**
   - Pi secured to `raspberry-pi-mount.stl` with M2.5 screws and standoffs
   - Mount positioned in torso chassis (central location, accessible)
   - GPIO header accessible for I2C connections
   - USB ports facing accessible direction (for mic, speaker, peripherals)
   - Heat dissipation: Clearance for airflow, heatsinks not blocked

3. **Power Connection:**
   - 5V from power distribution board → Pi GPIO pins (5V + GND) or USB-C (Pi 5)
   - Current tested: Pi under load (ROS2 nodes running) draws <3A
   - Stable power: Pi boots successfully, no undervoltage warnings (`vcgencmd get_throttled`)

4. **I2C Bus Integration:**
   - **Existing I2C devices (Epic 3):**
     - Head Module: 0x08
     - Ears+Neck Module: 0x09
   - **New I2C device:**
     - Body Module: 0x0A (ESP32-S3 from Story 5.2)
   - **I2C Wiring:**
     - Pi GPIO2 (SDA) → I2C bus (shared with all ESP32 modules)
     - Pi GPIO3 (SCL) → I2C bus (shared with all ESP32 modules)
     - Common ground: All ESP32s + Pi share GND
     - Pull-up resistors: 4.7kΩ on SDA/SCL (verify with multimeter, may be onboard Pi)
   - **I2C Scan:**
     - Command: `sudo i2cdetect -y 1`
     - Expected output: Devices at 0x08, 0x09, 0x0A
     - No conflicts: All addresses unique

5. **USB Peripherals:**
   - USB conference microphone connected (for Epic 13 voice, placeholder now)
   - USB conference speaker connected (for Epic 13 voice, placeholder now)
   - Peripherals detected: `lsusb` shows audio devices
   - Test audio: `arecord` captures mic, `aplay` plays speaker (verify hardware functional)

6. **Network Configuration:**
   - WiFi configured (for SSH access, cloud AI API in Epic 13)
   - Static IP optional (recommended for ROS2 networking)
   - SSH enabled: Remote access for development
   - ROS2 domain ID set: Environment variable `ROS_DOMAIN_ID=42` (from tech stack)

7. **Torso Structural Assembly:**
   - `torso-front-panel.stl` (with heart LCD) attached to `torso-main-chassis.stl`
   - `torso-back-panel.stl` secured (removable for maintenance)
   - `torso-side-left.stl`, `torso-side-right.stl` attached
   - Power enclosure integrated into torso base
   - Cable routing verified: All wiring fits inside chassis without pinching
   - Structural integrity: Torso can support head assembly weight (test fit if head available)

8. **Component Organization:**
   - `component-bay-dividers.stl` installed: Separates Pi, power components, ESP32s
   - Cable management: `cable-channels-torso.stl` organizes wiring
   - Access panels clearly labeled: "Power Access", "Pi Access", "Body Module Access"

9. **Functional Testing:**
   - Pi boots from SD card (ROS2 orchestrator software from Epic 1)
   - I2C communication: Test Epic 3 head expressions work with new power system
   - Body Module responds: `i2cget -y 1 0x0A 0x00` returns module ID (0x0A)
   - Power system stable: All components powered, no voltage sag
   - Thermal check: 15 minutes continuous operation, no overheating

10. **Documentation:**
    - Photos: Complete torso assembly (multiple angles)
    - Wiring diagram: `hardware/wiring/torso-complete-wiring.png`
    - I2C bus topology: Updated with Body Module 0x0A
    - Pi configuration notes: `ros2/README.md` updated with I2C setup

## Tasks / Subtasks

- [ ] **Task 1: Prepare Raspberry Pi** (AC: 1)
  - [ ] Verify Raspberry Pi 4B or Pi 5
  - [ ] Install heatsinks on CPU, RAM (recommended)
  - [ ] Verify MicroSD card has ROS2 + orchestrator (from Epic 1)
  - [ ] Boot Pi standalone, verify ROS2 software functional
  - [ ] Prepare USB cables for mic and speaker
  - [ ] Gather M2.5 screws and standoffs for Pi mounting

- [ ] **Task 2: Mount Raspberry Pi in torso** (AC: 2)
  - [ ] Secure Pi to `raspberry-pi-mount.stl` with M2.5 screws
  - [ ] Install standoffs (creates space for GPIO header clearance)
  - [ ] Position mount in torso chassis (central, accessible location)
  - [ ] Verify GPIO header accessible
  - [ ] Verify USB ports facing outward for cable access
  - [ ] Check heatsink clearance (no obstruction to airflow)

- [ ] **Task 3: Connect power to Raspberry Pi** (AC: 3)
  - [ ] Connect 5V Anderson Powerpole from power distribution (Story 5.3)
  - [ ] **Option A (GPIO pins):** 5V → Pi GPIO pin 2 or 4, GND → GPIO pin 6
  - [ ] **Option B (USB-C, Pi 5):** Use USB-C power connector
  - [ ] Power on Pi, verify boot successful
  - [ ] Check for undervoltage warnings: `vcgencmd get_throttled`
    - [ ] Output should be `throttled=0x0` (no throttling)
  - [ ] Measure current draw with multimeter: <3A under ROS2 load

- [ ] **Task 4: Wire I2C bus integration** (AC: 4)
  - [ ] **Connect Body Module I2C (from Story 5.2):**
    - [ ] Body Module SDA (GPIO21) → Pi GPIO2 (SDA)
    - [ ] Body Module SCL (GPIO22) → Pi GPIO3 (SCL)
    - [ ] Body Module GND → Pi GND (common ground)
  - [ ] **Verify Epic 3 I2C devices still connected:**
    - [ ] Head Module 0x08: SDA/SCL to Pi GPIO2/3
    - [ ] Ears+Neck Module 0x09: SDA/SCL to Pi GPIO2/3
  - [ ] Check pull-up resistors on I2C bus (measure with multimeter: should be ~4.7kΩ)
  - [ ] Power on system, run I2C scan: `sudo i2cdetect -y 1`
  - [ ] Verify devices detected: 0x08, 0x09, 0x0A
  - [ ] Troubleshoot if any address missing

- [ ] **Task 5: Connect USB peripherals** (AC: 5)
  - [ ] Connect USB conference microphone to Pi USB port
  - [ ] Connect USB conference speaker to Pi USB port
  - [ ] Boot Pi, verify devices detected: `lsusb`
  - [ ] Test microphone: `arecord -D plughw:1,0 -d 5 test.wav` (record 5 seconds)
  - [ ] Test speaker: `aplay -D plughw:2,0 test.wav` (play recording)
  - [ ] Verify audio functional (placeholder for Epic 13)

- [ ] **Task 6: Configure network and ROS2** (AC: 6)
  - [ ] Configure WiFi credentials (via `raspi-config` or network manager)
  - [ ] Assign static IP (optional, recommended): Edit `/etc/dhcpcd.conf`
  - [ ] Enable SSH: `sudo systemctl enable ssh`
  - [ ] Test SSH access from development machine
  - [ ] Set ROS2 domain ID: Add `export ROS_DOMAIN_ID=42` to `~/.bashrc`
  - [ ] Source ROS2: Verify `ros2 topic list` works

- [ ] **Task 7: Assemble torso structure** (AC: 7)
  - [ ] Attach `torso-front-panel.stl` (with heart LCD) to `torso-main-chassis.stl`
  - [ ] Attach `torso-back-panel.stl` (ensure removable for maintenance access)
  - [ ] Attach `torso-side-left.stl` and `torso-side-right.stl`
  - [ ] Integrate power enclosure into torso base
  - [ ] Route all cables through `cable-channels-torso.stl`
  - [ ] Verify no wires pinched when panels close
  - [ ] Test structural integrity: Place weight (~1.5kg) on top, check for flex

- [ ] **Task 8: Organize components with dividers** (AC: 8)
  - [ ] Install `component-bay-dividers.stl` to separate:
    - [ ] Raspberry Pi compartment
    - [ ] ESP32 Body Module compartment
    - [ ] Power components compartment
  - [ ] Organize wiring using `cable-channels-torso.stl`
  - [ ] Label access panels:
    - [ ] "Power Access" (battery, converters)
    - [ ] "Pi Access" (Raspberry Pi, USB)
    - [ ] "Body Module Access" (ESP32-S3, heart LCD)

- [ ] **Task 9: Functional testing** (AC: 9)
  - [ ] Power on complete system (battery → power distribution → Pi + ESP32s)
  - [ ] Verify Pi boots from SD card
  - [ ] Test Epic 3 head expressions: `ros2 topic pub /olaf/head/expression ...`
  - [ ] Test Body Module I2C: `i2cget -y 1 0x0A 0x00`
    - [ ] Should return 0x0A (module ID)
  - [ ] Monitor 5V rail voltage: Should remain 4.9-5.1V
  - [ ] Run system for 15 minutes, check temperatures:
    - [ ] Pi CPU: `vcgencmd measure_temp` (<70°C)
    - [ ] Buck converters: <60°C
    - [ ] No hot spots on wiring

- [ ] **Task 10: Documentation** (AC: 10)
  - [ ] Photograph complete torso assembly:
    - [ ] Front view (heart LCD visible)
    - [ ] Back view (access panels)
    - [ ] Internal view (Pi, Body Module, power system)
  - [ ] Save photos to `hardware/wiring/torso-assembly/`
  - [ ] Create wiring diagram: `hardware/wiring/torso-complete-wiring.png`
  - [ ] Update I2C bus topology diagram with Body Module 0x0A
  - [ ] Document Pi configuration in `ros2/README.md`:
    - [ ] I2C setup procedure
    - [ ] ROS2 domain ID configuration
    - [ ] Power connection method (GPIO vs USB-C)

## Dev Notes

### Raspberry Pi Model Selection

**Pi 4B vs Pi 5:**
- **Pi 4B:** 4GB or 8GB RAM recommended for ROS2
- **Pi 5:** Faster CPU, better for future AI workloads (Epic 13)
- **Both:** Same GPIO pinout, I2C on GPIO2/3

**Power Requirements:**
- Pi 4B: 3A peak (official recommendation)
- Pi 5: 5A peak (use USB-C PD or GPIO power carefully)
- 5V rail from Story 5.3: 10A total capacity (sufficient for Pi + ESP32s + servos)

### I2C Bus Configuration

**Hardware I2C on Raspberry Pi:**
- Bus: I2C-1 (device `/dev/i2c-1`)
- Pins: GPIO2 (SDA), GPIO3 (SCL)
- Enable: `sudo raspi-config` → Interfacing → I2C → Enable

**Pull-up Resistors:**
- Raspberry Pi has onboard 1.8kΩ pull-ups (may be weak for long wires or multiple devices)
- Recommended: Add external 4.7kΩ pull-ups on SDA and SCL
- Measure with multimeter: SDA/SCL to 3.3V should show ~1-5kΩ

**I2C Frequency:**
- Default: 100kHz (standard mode)
- Can increase to 400kHz (fast mode) for lower latency
- Configure in `/boot/config.txt`: `dtparam=i2c_baudrate=400000`

**I2C Bus Topology (3 devices):**
```
Raspberry Pi GPIO2/3 (SDA/SCL)
    │
    ├─── Head Module (0x08)
    ├─── Ears+Neck Module (0x09)
    └─── Body Module (0x0A)

Pull-ups: 4.7kΩ on SDA and SCL to 3.3V
```

### Power Connection Methods

**Method A: GPIO Pins (Used in this story):**
- Pros: Simple, no additional cable
- Cons: Bypasses polyfuse protection (careful with current)
- Pins: GPIO Pin 2 or 4 (5V), Pin 6 (GND)
- Maximum current: 3A recommended

**Method B: USB-C (Pi 5 only):**
- Pros: Built-in power management, polyfuse protection
- Cons: Requires USB-C cable and connector
- Use: USB-C PD (5V 3A) from power distribution

### ROS2 Configuration

**Domain ID:**
- Purpose: Isolates ROS2 network traffic from other systems
- Range: 0-101
- OLAF uses: 42 (from tech-stack.md)
- Set in `~/.bashrc`: `export ROS_DOMAIN_ID=42`

**Workspace Setup:**
- ROS2 workspace: `~/ros2_ws` (from Epic 1)
- Source workspace: `source ~/ros2_ws/install/setup.bash` (add to `~/.bashrc`)

### USB Audio Devices

**Conference Mic+Speaker:**
- Placeholder for Epic 13 (Whisper STT + TTS)
- Test now to verify hardware functional
- Identify device indices: `arecord -l` and `aplay -l`
- Adjust ALSA defaults if needed in `~/.asoundrc`

### Torso Structural Design

**Load Bearing:**
- Torso must support head assembly (~1.5kg)
- Test with equivalent weight before Epic 7 integration
- Check for flex or creaking (indicates weak points)

**Maintenance Access:**
- Removable back panel for Pi and power access
- Side panels should allow battery removal without full disassembly

### File Locations

```
hardware/wiring/
├── torso-complete-wiring.png          # <-- THIS STORY
├── torso-assembly/                    # <-- THIS STORY
│   ├── torso-front-view.jpg
│   ├── torso-back-view.jpg
│   ├── torso-internal-components.jpg
│   └── i2c-bus-topology-updated.png

ros2/
├── README.md                          # <-- THIS STORY (update)
```

### Testing

**I2C Scan Example:**
```bash
$ sudo i2cdetect -y 1
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- -- -- -- -- 08 09 0a -- -- -- -- --
10:          -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
...
```
Expected: Addresses 0x08, 0x09, 0x0A visible

**Undervoltage Check:**
```bash
$ vcgencmd get_throttled
throttled=0x0
```
- `0x0`: No throttling (power good)
- `0x50005`: Undervoltage detected (check power supply, wiring)

**Troubleshooting:**
- **I2C device missing:** Check wiring, verify ESP32 powered, try `i2cdetect -y 1` multiple times
- **Pi undervoltage:** Use thicker wires, verify buck converter output is exactly 5.0V
- **USB devices not detected:** Check cable connections, verify Pi USB ports functional with mouse/keyboard
- **Pi won't boot:** Check SD card, try re-imaging with Raspberry Pi Imager

## Dependencies
- Story 5.1: 3D printed torso components
- Story 5.2: Body Module assembled
- Story 5.3: Power system functional
- Epic 3: Head and Ears+Neck modules (for I2C bus testing)

## Estimated Effort
6-8 hours

## Dev Agent Record

### Agent Model Used
<!-- To be filled by dev agent -->

### Debug Log References
<!-- To be filled by dev agent -->

### Completion Notes List
<!-- To be filled by dev agent -->

### File List
<!-- To be filled by dev agent -->

## QA Results
<!-- To be filled by QA agent -->

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | v1.0 | Initial story creation from Epic 5 | John (Product Manager) |
