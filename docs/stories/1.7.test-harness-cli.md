# Story 1.7: Test Harness CLI - I2C Direct Testing

## Status
Draft

## Story
**As a** developer or tester,
**I want** a command-line tool to send I2C commands directly to head module,
**so that** I can debug without running full ROS2 stack.

## Acceptance Criteria

1. **CLI Tool:**
   - Python script: `tools/diagnostics/olaf-test`
   - Executable: `chmod +x tools/diagnostics/olaf-test`
   - Uses `smbus2` for direct I2C access

2. **Commands:**
   - `olaf-test head expression <type> <intensity>` → Writes registers 0x10-0x11 to address 0x08
   - `olaf-test head status` → Reads register 0x02, prints status
   - `olaf-test head id` → Reads register 0x00, prints module ID
   - `olaf-test head blink` → Writes to register 0x12, triggers blink
   - `olaf-test scan` → Runs `i2cdetect -y 1`, shows all I2C devices

3. **Implementation:**
   ```python
   def set_expression(expression_type, intensity):
       bus = SMBus(1)
       bus.write_byte_data(0x08, 0x10, expression_type)
       bus.write_byte_data(0x08, 0x11, intensity)
       print(f"Expression set: type={expression_type}, intensity={intensity}")
   ```

4. **Usage:**
   - `./tools/diagnostics/olaf-test head expression 1 3` → Sets happy expression, intensity 3
   - `./tools/diagnostics/olaf-test head blink` → Triggers eye blink
   - `--help` shows all commands

5. **Error Handling:**
   - "I2C bus not found" if I2C not enabled
   - "No response from module 0x08" if ESP32 not responding

6. **Documentation:**
   - Usage guide: `tools/diagnostics/README.md`

## Tasks / Subtasks

- [ ] **Task 1: Create CLI script structure** (AC: 1, 4)
  - [ ] Create `tools/diagnostics/olaf-test` Python script
  - [ ] Add shebang: `#!/usr/bin/env python3`
  - [ ] Make executable: `chmod +x olaf-test`
  - [ ] Add argparse for command-line parsing
  - [ ] Implement `--help` flag

- [ ] **Task 2: Implement head module commands** (AC: 2, 3)
  - [ ] Implement `head expression <type> <intensity>` command
  - [ ] Implement `head status` command (read register 0x02)
  - [ ] Implement `head id` command (read register 0x00)
  - [ ] Implement `head blink` command (write to register 0x12)
  - [ ] Add expression name mapping (neutral=0, happy=1, etc.)

- [ ] **Task 3: Implement scan command** (AC: 2)
  - [ ] Implement `scan` command using subprocess to call `i2cdetect -y 1`
  - [ ] Parse and display I2C device addresses
  - [ ] Highlight head module address (0x08)

- [ ] **Task 4: Add error handling** (AC: 5)
  - [ ] Check if I2C bus exists (`/dev/i2c-1`)
  - [ ] Handle smbus2 IOError (device not responding)
  - [ ] Provide clear error messages with troubleshooting hints

- [ ] **Task 5: Documentation** (AC: 6)
  - [ ] Create `tools/diagnostics/README.md`
  - [ ] Document all commands with examples
  - [ ] Add troubleshooting section
  - [ ] Include permission setup (i2c group)

## Dev Notes

### Technology Stack
[Source: docs/architecture/tech-stack.md]
- **I2C Library:** smbus2 0.4.x
- **I2C Bus:** /dev/i2c-1 (Pi GPIO2/3)
- **Head Module Address:** 0x08

### Data Models
[Source: docs/architecture/data-models.md]
**Head Module Registers:**
- 0x00: Module ID (returns 0x08)
- 0x02: Status byte
- 0x10: Expression type (0-6)
- 0x11: Intensity (1-5)
- 0x12: Blink trigger

### File Locations
[Source: docs/architecture/source-tree.md]
```
tools/
├── diagnostics/
│   ├── olaf-test       # <-- THIS STORY
│   └── README.md
```

### Coding Standards
[Source: docs/architecture/coding-standards.md]
- Use argparse for CLI
- Clear error messages
- Type hints for functions
- Docstrings for main functions

## Dev Agent Record

### Agent Model Used
<!-- To be filled by dev agent -->

### Debug Log References
<!-- To be filled by dev agent -->

### Completion Notes List
<!-- To be filled by dev agent -->

### File List
<!-- To be filled by dev agent -->

## QA Results
<!-- To be filled by QA agent -->

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | v1.0 | Initial story draft | Bob (Scrum Master) |
| 2025-10-25 | v1.1 | Updated from body to head module, I2C 0x08, added blink command | Bob (Scrum Master) |
