# Story 5.2: Heart LCD Display Module - Hardware Assembly

## Status
Draft

## Story
**As a** hardware builder,
**I want** the heart LCD display physically mounted and wired to ESP32-S3,
**so that** I have working Body Module hardware ready for firmware.

## Acceptance Criteria

1. **Component Preparation:**
   - 1.53" Round TFT LCD 360×360 (ST77916 driver, QSPI interface) acquired
   - ESP32-S3-WROOM-2 (N16R8) for Body Module
   - M2.5 screws for LCD mounting
   - 15cm jumper wires for QSPI connections

2. **LCD Mounting:**
   - Heart LCD mounted in `heart-lcd-mount.stl` bracket
   - Bracket secured to `torso-front-panel.stl` with M3 screws
   - `heart-lcd-bezel.stl` decorative bezel attached (covers mounting hardware)
   - Display centered in torso front panel cutout
   - Display aligned: Vertical orientation, parallel to front panel

3. **QSPI Wiring (ESP32-S3 → ST77916 LCD):**
   - **Power:**
     - VCC → 3.3V (ESP32-S3)
     - GND → GND
   - **QSPI Interface (high-speed display):**
     - CS (Chip Select) → GPIO10
     - SCK (Clock) → GPIO12
     - SDA0 (Data 0) → GPIO11
     - SDA1 (Data 1) → GPIO13
     - SDA2 (Data 2) → GPIO14
     - SDA3 (Data 3) → GPIO15
     - DC (Data/Command) → GPIO16
     - RST (Reset) → GPIO17
     - BL (Backlight) → GPIO18 (PWM for brightness control)

4. **ESP32-S3 Mounting:**
   - ESP32-S3 secured inside torso chassis (accessible compartment)
   - USB port access maintained for firmware updates
   - QSPI wiring organized and secured (keep wires <15cm to reduce interference)
   - I2C wiring prepared (to Raspberry Pi, installed in Story 5.4):
     - SDA → GPIO21
     - SCL → GPIO22
     - I2C address configured in firmware: **0x0A** (Body Module)

5. **Power Testing:**
   - Connect ESP32 to bench 5V supply
   - ESP32 boots: Blue LED on, serial output visible
   - LCD backlight turns on (verify GPIO18 controls brightness)
   - No shorts: Multimeter check on all power rails before power-on

6. **Mechanical Fit Verification:**
   - LCD bezel flush with front panel
   - No flex or wobble in LCD mount
   - ESP32 accessible for USB firmware updates
   - Cable routing allows front panel to close without pinching wires

7. **Documentation:**
   - Wiring photos: `hardware/wiring/body-module-assembly.jpg`
   - QSPI pinout documented: `firmware/body/README.md`
   - Component locations diagram

## Tasks / Subtasks

- [ ] **Task 1: Acquire components** (AC: 1)
  - [ ] Purchase 1.53" Round TFT LCD 360×360 (ST77916 driver, QSPI interface)
  - [ ] Purchase ESP32-S3-WROOM-2 (N16R8) development board
  - [ ] Gather M2.5 screws for LCD mounting
  - [ ] Gather M3 screws for bracket mounting
  - [ ] Prepare 15cm jumper wires (female-female for breadboard testing)
  - [ ] Verify LCD specifications match ST77916 driver

- [ ] **Task 2: Mount LCD in 3D printed bracket** (AC: 2)
  - [ ] Test-fit LCD in `heart-lcd-mount.stl` bracket
  - [ ] Secure LCD with M2.5 screws (typically 4 corners)
  - [ ] Attach mount bracket to `torso-front-panel.stl` with M3 screws
  - [ ] Verify LCD centered in 40mm cutout
  - [ ] Install `heart-lcd-bezel.stl` decorative bezel
  - [ ] Check alignment: LCD parallel to front panel, vertical orientation

- [ ] **Task 3: Wire QSPI interface to ESP32-S3** (AC: 3)
  - [ ] Reference ST77916 LCD datasheet for pinout
  - [ ] Connect power:
    - [ ] LCD VCC → ESP32-S3 3.3V
    - [ ] LCD GND → ESP32-S3 GND
  - [ ] Connect QSPI data lines:
    - [ ] CS → GPIO10
    - [ ] SCK → GPIO12
    - [ ] SDA0 → GPIO11
    - [ ] SDA1 → GPIO13
    - [ ] SDA2 → GPIO14
    - [ ] SDA3 → GPIO15
  - [ ] Connect control lines:
    - [ ] DC → GPIO16
    - [ ] RST → GPIO17
    - [ ] BL → GPIO18
  - [ ] Use consistent wire colors (red=VCC, black=GND, others per convention)
  - [ ] Keep QSPI wires <15cm to minimize signal integrity issues

- [ ] **Task 4: Mount ESP32-S3 in torso chassis** (AC: 4)
  - [ ] Position ESP32-S3 in accessible compartment of torso chassis
  - [ ] Secure with standoffs or double-sided tape
  - [ ] Ensure USB port accessible for firmware uploads
  - [ ] Route QSPI wires neatly from ESP32 to LCD mount
  - [ ] Secure wiring to prevent movement (zip ties, cable clips)

- [ ] **Task 5: Prepare I2C wiring for Raspberry Pi** (AC: 4)
  - [ ] Prepare I2C wires (SDA, SCL, GND):
    - [ ] SDA wire from ESP32-S3 GPIO21 (leave free end for Pi connection in Story 5.4)
    - [ ] SCL wire from ESP32-S3 GPIO22 (leave free end for Pi connection in Story 5.4)
    - [ ] GND wire from ESP32-S3 (leave free end for common ground with Pi)
  - [ ] Label wires clearly: "Body Module 0x0A - SDA", "Body Module 0x0A - SCL"
  - [ ] Route I2C wires toward Raspberry Pi mounting location

- [ ] **Task 6: Power testing** (AC: 5)
  - [ ] Connect ESP32-S3 to bench 5V power supply
  - [ ] Verify ESP32-S3 boots (blue LED on, serial output on USB)
  - [ ] Verify LCD backlight turns on (initial brightness)
  - [ ] Use multimeter to check voltages:
    - [ ] ESP32-S3 3.3V rail: Should be 3.3V ±0.1V
    - [ ] LCD VCC: Should be 3.3V ±0.1V
    - [ ] No shorts between power and ground
  - [ ] Disconnect power

- [ ] **Task 7: Mechanical fit verification** (AC: 6)
  - [ ] Verify LCD bezel flush with torso front panel
  - [ ] Check for flex or wobble in LCD mount
  - [ ] Verify ESP32-S3 accessible for USB cable connection
  - [ ] Test-close torso front panel:
    - [ ] Ensure wiring fits without pinching
    - [ ] Panel closes smoothly
    - [ ] No strain on wires

- [ ] **Task 8: Documentation** (AC: 7)
  - [ ] Photograph wiring assembly:
    - [ ] QSPI connections (close-up showing GPIO assignments)
    - [ ] Overall Body Module assembly
    - [ ] LCD mounted in torso front panel
  - [ ] Save photos to `hardware/wiring/body-module-assembly/`
  - [ ] Document QSPI pinout in `firmware/body/README.md`:
    - [ ] Create pinout table (GPIO → LCD pin mapping)
    - [ ] Note wire color coding used
  - [ ] Create component locations diagram (sketch or digital)

## Dev Notes

### ST77916 QSPI Display Specifications

**Technical Specs:**
- Resolution: 360×360 pixels (round display with circular active area)
- Driver IC: ST77916 (similar to ST7789, but with QSPI support)
- Interface: QSPI (Quad SPI) - 4 data lines for high-speed transfer
- Power: 3.3V typical
- Backlight: LED backlight with PWM control
- Frame rate capability: Up to 60 FPS with QSPI

**QSPI vs SPI:**
- Standard SPI: 1 data line (MOSI), limited bandwidth
- QSPI: 4 data lines (SDA0-SDA3), 4× bandwidth improvement
- Required for 360×360 @ 60 FPS (259.2KB frame buffer)

### ESP32-S3 QSPI Capabilities

**ESP32-S3-WROOM-2 (N16R8) Specifications:**
- CPU: Xtensa LX7 dual-core @ 240MHz
- Flash: 16MB
- PSRAM: 8MB (CRITICAL for 360×360 frame buffer)
- GPIO: 45 GPIO pins
- QSPI support: Yes (via SPI peripheral in octal/quad mode)

**Why ESP32-S3 Required:**
- 8MB PSRAM: Needed for 259.2KB RGB565 frame buffer (360×360×2 bytes)
- Octal SPI support: Enables QSPI for high-speed display updates
- Sufficient CPU power for real-time heart animation rendering

### Wiring Best Practices

**QSPI Signal Integrity:**
- Keep wires short (<15cm) to minimize capacitance and signal degradation
- Use twisted pairs for differential signals (if possible)
- Avoid running QSPI wires parallel to power wires (EMI)
- Test with short jumper wires first, then route permanently

**Wire Gauge:**
- Power (VCC, GND): 22AWG or thicker (handles current)
- Signal lines (QSPI, I2C): 24-26AWG acceptable

**Soldering vs Jumpers:**
- Initial testing: Use jumper wires for flexibility
- Final assembly: Consider soldering for reliability (after firmware tested)

### Component Specifications

**From Epic 5 Goal:**
- **Body Module (I2C 0x0A):** ESP32-S3 + Heart LCD + I2C slave interface
- **Heart Display:** 1.53" Round TFT 360×360 for emotional expression via color+BPM

**I2C Address:**
- Body Module: **0x0A** (different from Head 0x08, Ears+Neck 0x09)

### Power Budget

**ESP32-S3 Power Draw:**
- Idle: ~80mA @ 5V
- Active (WiFi off): ~120-150mA @ 5V
- Peak (QSPI transfers): ~200mA @ 5V

**LCD Power Draw:**
- Backlight off: ~10mA @ 3.3V
- Backlight full: ~80-120mA @ 3.3V
- Total LCD: ~130mA @ 3.3V maximum

**Total Body Module Power:**
- ESP32-S3: 200mA @ 5V = 1W
- LCD (via ESP32 3.3V): 130mA @ 3.3V = 0.43W
- **Total: ~1.5W peak** (provided by 5V rail in Story 5.3)

### File Locations

```
firmware/body/
├── README.md              # <-- THIS STORY (update with QSPI pinout)
├── firmware/
│   └── (firmware in Story 5.5)

hardware/wiring/
├── body-module-assembly/  # <-- THIS STORY (photos)
│   ├── qspi-wiring-closeup.jpg
│   ├── body-module-overview.jpg
│   └── lcd-mounted-in-panel.jpg
```

### Testing

**Visual Inspection:**
- All QSPI connections secure (no loose wires)
- LCD properly seated in mount
- No exposed wire conductors (risk of shorts)

**Power Testing:**
- ESP32-S3 boots reliably
- LCD backlight illuminates (white screen if no firmware)
- No excessive heat on ESP32 or LCD (touch test after 5 minutes)

**Troubleshooting:**
- **LCD backlight doesn't turn on:** Check BL (GPIO18) connection, verify 3.3V power
- **ESP32 doesn't boot:** Check 5V power supply, verify USB serial output
- **LCD shows artifacts:** Check QSPI data line connections (SDA0-SDA3)
- **Short circuit:** Use multimeter continuity mode to check for shorts before applying power

## Dependencies
- Story 5.1: 3D printed torso components (heart LCD mount, bezel, torso panels)

## Estimated Effort
4-6 hours

## Dev Agent Record

### Agent Model Used
<!-- To be filled by dev agent -->

### Debug Log References
<!-- To be filled by dev agent -->

### Completion Notes List
<!-- To be filled by dev agent -->

### File List
<!-- To be filled by dev agent -->

## QA Results
<!-- To be filled by QA agent -->

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | v1.0 | Initial story creation from Epic 5 | John (Product Manager) |
