# Story 3.8: ROS2 Head Driver Enhancement - Presence Detection

## Status
Draft

## Story
**As a** software developer,
**I want** Epic 1 ROS2 head driver enhanced with presence detection topic publication,
**so that** the orchestrator can react to human presence.

## Acceptance Criteria

1. **Existing Driver Base:**
   - Start from Epic 1 `ros2_nodes/hardware_drivers/head_driver.py`
   - Existing expression and blink topics remain functional
   - I2C communication to address 0x08 working

2. **New ROS2 Message Definition:**
   - Create `PresenceData.msg`:
     ```
     bool detected           # True if presence currently detected
     uint8 duration          # Seconds of continuous presence (0-255)
     uint8 event_count       # Total presence events since boot
     ```

3. **New ROS2 Publications:**
   - `/olaf/head/presence` (PresenceData msg) at 10Hz
     - Reads registers 0x20-0x22 (presence status, duration, events)
     - Publishes current presence data
   - `/olaf/events/presence_detected` (std_msgs/Empty)
     - Publishes event when presence detected (rising edge: False → True)
     - Enables orchestrator to react immediately without polling

4. **Presence Event Detection:**
   - Track previous `detected` state
   - Detect rising edge: `detected` changes False → True
   - Publish to `/olaf/events/presence_detected` on rising edge
   - Log event: "Presence detected!" at INFO level

5. **Testing:**
   - Node launches: Existing head driver functionality works
   - New topic appears: `/olaf/head/presence`
   - Event topic appears: `/olaf/events/presence_detected`
   - No presence: Topic publishes `detected=False, duration=0`
   - Approach sensor: Topic publishes `detected=True, duration` increments
   - Leave sensor: `detected=False`, event_count incremented
   - Rising edge test: Approach sensor → `/olaf/events/presence_detected` published

6. **Integration Testing:**
   - Combined test: Send expression command while presence detected → both work
   - Latency: Presence detection → ROS2 topic publish <100ms
   - No interference with Epic 1 expression functionality

7. **Code Quality:**
   - File: `head_driver.py` updated with presence logic
   - Message definition: `orchestrator/msg/PresenceData.msg`
   - Comments explain presence polling and event detection
   - Code committed to `ros2/src/orchestrator/`

## Tasks / Subtasks

- [ ] **Task 1: Create PresenceData message** (AC: 2)
  - [ ] Create file: `orchestrator/msg/PresenceData.msg`
  - [ ] Define fields:
    ```
    bool detected
    uint8 duration
    uint8 event_count
    ```
  - [ ] Build messages: `colcon build --packages-select orchestrator`
  - [ ] Verify message: `ros2 interface show orchestrator/msg/PresenceData`

- [ ] **Task 2: Update head_driver to read presence registers** (AC: 3)
  - [ ] Import PresenceData message type
  - [ ] Add presence register constants:
    - [ ] `REG_PRESENCE_STATUS = 0x20`
    - [ ] `REG_PRESENCE_DURATION = 0x21`
    - [ ] `REG_PRESENCE_EVENT_COUNT = 0x22`
  - [ ] Add function: `read_presence_data()`
    - [ ] Read registers 0x20, 0x21, 0x22
    - [ ] Return PresenceData object

- [ ] **Task 3: Create presence publication** (AC: 3)
  - [ ] Create publisher: `/olaf/head/presence` (PresenceData)
  - [ ] Create timer: 10Hz (100ms interval)
  - [ ] Timer callback:
    - [ ] Call `read_presence_data()`
    - [ ] Populate PresenceData message
    - [ ] Publish message

- [ ] **Task 4: Implement presence event detection** (AC: 4)
  - [ ] Add state variable: `self.prev_presence_detected = False`
  - [ ] Create publisher: `/olaf/events/presence_detected` (Empty)
  - [ ] In presence timer callback:
    - [ ] Check rising edge: `current.detected and not self.prev_presence_detected`
    - [ ] If rising edge:
      - [ ] Publish Empty message to events topic
      - [ ] Log: "Presence detected!"
    - [ ] Update: `self.prev_presence_detected = current.detected`

- [ ] **Task 5: Backward compatibility testing** (AC: 1, 6)
  - [ ] Verify Epic 1 functionality intact:
    - [ ] `/olaf/head/expression` subscription works
    - [ ] `/olaf/head/blink` subscription works
    - [ ] `/olaf/head/status` publication works
    - [ ] Expression changes latency <100ms
  - [ ] New presence topics don't interfere with eye rendering

- [ ] **Task 6: Presence detection testing** (AC: 5)
  - [ ] Launch node: `ros2 run orchestrator head_driver`
  - [ ] Monitor presence topic:
    ```bash
    ros2 topic echo /olaf/head/presence
    ```
  - [ ] Test no presence: Verify `detected=false, duration=0`
  - [ ] Test presence detected:
    - [ ] Approach sensor
    - [ ] Verify `detected=true`
    - [ ] Verify duration increments each second
  - [ ] Test event publication:
    ```bash
    ros2 topic echo /olaf/events/presence_detected
    ```
    - [ ] Approach sensor → event published
    - [ ] Leave and re-approach → event published again

- [ ] **Task 7: Integration testing** (AC: 6)
  - [ ] Combined test:
    - [ ] Send expression command while presence detected
    - [ ] Verify both work simultaneously (no blocking)
  - [ ] Latency test:
    - [ ] Measure time from physical presence to ROS2 event
    - [ ] Should be <100ms (firmware 20Hz poll + ROS2 10Hz publish)

- [ ] **Task 8: Documentation** (AC: 7)
  - [ ] Add docstrings to new functions
  - [ ] Add inline comments for presence logic
  - [ ] Update `ros2_nodes/README.md`:
    - [ ] New topics: `/olaf/head/presence`, `/olaf/events/presence_detected`
    - [ ] PresenceData message fields
    - [ ] Example: Subscribe to presence events
  - [ ] Commit code to repository

## Dev Notes

### Prerequisites
From Epic 1 Story 1.5 (ROS2 Head Driver):
- head_driver.py implemented with expression and blink topics
- I2C communication to Head Module (address 0x08) functional

From Story 3.6 (Head Firmware Presence Sensor):
- Presence sensor integrated in firmware
- I2C registers 0x20-0x22 implemented (status, duration, event_count)

### Presence Data Flow

```
DFRobot SEN0395 (mmWave sensor)
  ↓ (GPIO16)
ESP32 Head Module (Firmware - Story 3.6)
  ↓ (I2C 0x08, registers 0x20-0x22)
ROS2 Head Driver (This story)
  ↓ (ROS2 topics)
Orchestrator / Other nodes
```

### PresenceData Message Design

**Fields:**
- `bool detected`: Current presence state (true/false)
  - Debounced in firmware (200ms stable)
  - Reflects real-time presence
- `uint8 duration`: Seconds of continuous presence
  - Resets to 0 when presence lost
  - Caps at 255 seconds (4+ minutes)
- `uint8 event_count`: Total presence events since boot
  - Increments on rising edge (firmware side)
  - Wraps around at 255

**Usage Examples:**
- **Greeting behavior:** Subscribe to `/olaf/events/presence_detected`, trigger "hello" on event
- **Attention tracking:** Monitor `duration` field, if >60s person is "engaging" with robot
- **Activity monitoring:** Track `event_count` delta over time periods

### ROS2 Event Topic Pattern

**Why use separate event topic?**
- Enables event-driven architecture (reactive instead of polling)
- Nodes can subscribe to event topic without polling presence at 10Hz
- Clear semantic: "Something happened" vs "Current state"

**Event Topic Design:**
- Topic: `/olaf/events/presence_detected`
- Message type: `std_msgs/Empty` (no data, just signal)
- Published only on rising edge (not on every presence poll)

**Alternative: Use PresenceData with stamped header**
- Could add `std_msgs/Header` to PresenceData
- Use `header.stamp` to determine event timing
- Trade-off: More complex message, but timestamp available

### Implementation Example

```python
from std_msgs.msg import Empty
from orchestrator.msg import PresenceData

class HeadDriver(Node):
    def __init__(self):
        super().__init__('head_driver')

        # Existing Epic 1 publishers/subscribers
        # ...

        # New presence publishers
        self.presence_pub = self.create_publisher(
            PresenceData,
            '/olaf/head/presence',
            10
        )
        self.presence_event_pub = self.create_publisher(
            Empty,
            '/olaf/events/presence_detected',
            10
        )

        # Presence polling timer
        self.presence_timer = self.create_timer(
            0.1,  # 10Hz
            self.presence_callback
        )

        # State tracking
        self.prev_presence_detected = False

    def presence_callback(self):
        # Read I2C registers
        detected = self.bus.read_byte_data(HEAD_ADDR, 0x20) == 1
        duration = self.bus.read_byte_data(HEAD_ADDR, 0x21)
        event_count = self.bus.read_byte_data(HEAD_ADDR, 0x22)

        # Publish presence data
        msg = PresenceData()
        msg.detected = detected
        msg.duration = duration
        msg.event_count = event_count
        self.presence_pub.publish(msg)

        # Detect rising edge and publish event
        if detected and not self.prev_presence_detected:
            self.presence_event_pub.publish(Empty())
            self.get_logger().info("Presence detected!")

        self.prev_presence_detected = detected
```

### Testing Commands

**Monitor Presence Data:**
```bash
ros2 topic echo /olaf/head/presence
```

**Monitor Presence Events:**
```bash
ros2 topic echo /olaf/events/presence_detected
```

**Check Topic Rate:**
```bash
ros2 topic hz /olaf/head/presence
# Expected: ~10 Hz
```

**Test Simultaneous Operations:**
```bash
# In one terminal: Monitor presence
ros2 topic echo /olaf/head/presence

# In another terminal: Change expression while presence detected
ros2 topic pub --once /olaf/head/expression orchestrator/msg/Expression \
  "{expression_type: 1, intensity: 3}"
```

### Integration with Coordinated Expression (Story 3.9)

**Use Case: Presence-Aware Behavior**
- Story 3.9 (Coordinated Expression) will subscribe to `/olaf/events/presence_detected`
- When event received: Trigger "curious" expression automatically
- This creates "awareness" behavior: Olaf looks at person entering room

**Preparation for Story 3.9:**
- This story provides the event topic that Story 3.9 will consume
- Clean event-driven interface: Story 3.9 doesn't need to know I2C details

### Performance Considerations

**Polling Rate:**
- 10Hz presence polling = 100ms update interval
- Firmware polls sensor at 20Hz (50ms)
- Total latency: 50ms (firmware) + 100ms (ROS2) = 150ms max

**I2C Bus Load:**
- 3 register reads × 10Hz = 30 reads/second
- Existing expression commands: Variable (on-demand)
- Total I2C traffic: <100 operations/second (well within I2C capacity)

### Troubleshooting

**Presence topic shows all zeros:**
- Check firmware running: Verify Story 3.6 firmware uploaded
- Check I2C connection: `sudo i2cget -y 1 0x08 0x20`
- Check sensor wiring: Verify GPIO16 connected to SEN0395

**Event topic never publishes:**
- Check rising edge detection logic
- Verify `prev_presence_detected` initialization
- Check sensor detection range (approach close enough)

**Latency >200ms:**
- Reduce ROS2 poll rate to 20Hz (match firmware rate)
- Check I2C bus speed (should be 400kHz fast mode)

**Interference with eye rendering:**
- Verify I2C reads are non-blocking
- Check for exception handling (errors shouldn't crash node)

### File Locations

```
ros2/src/orchestrator/
├── msg/
│   └── PresenceData.msg                  # <-- THIS STORY (new)
├── ros2_nodes/
│   └── hardware_drivers/
│       └── head_driver.py                # <-- THIS STORY (update)
└── README.md                             # <-- THIS STORY (update)
```

## Dev Agent Record

### Agent Model Used
<!-- To be filled by dev agent -->

### Debug Log References
<!-- To be filled by dev agent -->

### Completion Notes List
<!-- To be filled by dev agent -->

### File List
<!-- To be filled by dev agent -->

## QA Results
<!-- To be filled by QA agent -->

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-08 | v1.0 | Initial story creation from Epic 3 | Sarah (Product Owner) |
