# Story 1.6: Minimal Orchestrator - Expression Coordinator

## Status
In Progress

## Story
**As a** software developer,
**I want** a minimal orchestrator node that sends expression commands via ROS2,
**so that** I can prove the full pipeline (Orchestrator → ROS2 → I2C → ESP32 → SPI eye displays) works.

## Acceptance Criteria

1. **Orchestrator Node:**
   - Python ROS2 node: `ros2/src/orchestrator/ros2_nodes/minimal_coordinator.py`
   - Node name: `/olaf/minimal_coordinator`

2. **Publisher:**
   - Publishes to `/olaf/head/expression`

3. **Expression Cycle:**
   - Timer cycles through expressions every 10 seconds:
     - Neutral → Happy → Curious → Thinking → Confused → Sad → Excited → repeat
   - Intensity randomly varies between 2-4
   - Note: Blinks are handled autonomously by ESP32 firmware (no orchestrator control needed)

4. **Execution:**
   - Launch: `ros2 run orchestrator minimal_coordinator`
   - Every 10 seconds: Logs expression change, eye displays update
   - Autonomous blinks occur independently (handled by firmware)

5. **End-to-End Validation:**
   - Full chain: Coordinator → Head driver → I2C → ESP32 → SPI eyes
   - Latency: Publish to eye update <100ms
   - Reliability: 50 expression changes without failure
   - Firmware-controlled blinks work smoothly alongside expression changes

6. **Code Quality:**
   - Clean, commented code
   - Committed to `ros2/src/orchestrator/ros2_nodes/minimal_coordinator.py`

## Tasks / Subtasks

- [x] **Task 1: Create minimal coordinator node** (AC: 1, 2)
  - [x] Create `ros2/src/orchestrator/ros2_nodes/minimal_coordinator.py`
  - [x] Initialize ROS2 node `/olaf/minimal_coordinator`
  - [x] Create publisher for `/olaf/head/expression` topic
  - [x] Add ROS2 node boilerplate (init, spin, destroy)

- [x] **Task 2: Implement expression cycling logic** (AC: 3)
  - [x] Define expression sequence: neutral, happy, curious, thinking, confused, sad, excited
  - [x] Create 10-second timer callback for expression cycling
  - [x] Implement cycle logic (index wrapping)
  - [x] Add random intensity selection (2-4)
  - [x] Publish expression message on each timer trigger

- [x] **Task 3: Add logging and monitoring** (AC: 4)
  - [x] Log expression change with timestamp
  - [x] Log intensity value
  - [x] Add startup message indicating cycle start

- [ ] **Task 4: Test end-to-end pipeline** (AC: 5)
  - [ ] Launch head_driver node (Story 1.5)
  - [ ] Launch minimal_coordinator node
  - [ ] Observe eye displays change every 10 seconds
  - [ ] Verify autonomous firmware blinks work alongside expressions
  - [ ] Measure latency from publish to visual update
  - [ ] Run 50 cycles (~8.3 minutes) without failure
  - [ ] Verify all expressions display correctly

- [ ] **Task 5: Code quality and documentation** (AC: 6)
  - [ ] Add docstrings to all functions
  - [ ] Add comments explaining expression cycle and blink logic
  - [ ] Clean up code formatting
  - [ ] Commit to repository

## Dev Notes

### Previous Story Insights
From Story 1.5 (ROS2 Head Driver Node):
- Head driver node subscribes to `/olaf/head/expression` topic
- Expects expression_type (string) and intensity (1-5) in format "emotion:intensity"
- Blink animations are handled autonomously by ESP32 firmware (no ROS2 topic needed)
- Translates ROS2 messages to I2C register writes (0x10-0x11)
- Publishes `/olaf/head/status` at 10Hz

From Story 1.4 (Head Module ESP32 Firmware):
- Firmware processes I2C commands with <10ms latency
- Expression types: 0=neutral, 1=happy, 2=curious, 3=thinking, 4=confused, 5=sad, 6=excited
- Intensity range: 1-5
- Blink animations: Handled autonomously by firmware animation engine (no external trigger needed)
- Dual eye displays update synchronously at 60 FPS

### Technology Stack
[Source: docs/architecture/tech-stack.md]

**Orchestrator:**
- **Language:** Python 3.11+
- **ROS2 Version:** Humble (LTS until 2027)
- **Logging:** Python logging (ROS2 integration)

### ROS2 Node Architecture
[Source: docs/architecture/ros2-node-architecture.md]

**High-Level Application Nodes:**
```
/olaf/personality_coordinator (Python)
• Coordinates eyes + ears + neck + beeps
• Subscribes: /olaf/ai/emotion_command
• Publishes: /olaf/head/eye_expression, etc.
```

**Note:** This minimal coordinator is a simplified version for Epic 1 validation. Full personality coordinator will be implemented in Epic 9.

### Data Models
[Source: docs/architecture/data-models.md]

**Expression Types:**
```cpp
#define EXPR_NEUTRAL  0x00
#define EXPR_HAPPY    0x01
#define EXPR_CURIOUS  0x02
#define EXPR_THINKING 0x03
#define EXPR_CONFUSED 0x04
#define EXPR_SAD      0x05
#define EXPR_EXCITED  0x06
```

**ROS2 Message Format (if using custom message):**
```python
# interfaces/msg/Expression.msg
string emotion              # 'neutral', 'happy', 'curious', etc.
uint8 intensity             # 1-5
uint8 duration_ms
bool synchronize
```

**Alternative (using std_msgs):**
- Use `std_msgs/String` with simple format: "emotion:intensity"
- Example: "happy:4" or "curious:2"

### File Locations
[Source: docs/architecture/source-tree.md]

**Orchestrator Structure:**
```
orchestrator/
├── ros2_nodes/
│   ├── minimal_coordinator.py    # <-- THIS STORY
│   ├── hardware_drivers/
│   ├── personality/
│   ├── ai_integration/
│   └── navigation/
├── launch/
├── config/
└── README.md
```

**Key Path:**
- Node file: `ros2/src/orchestrator/ros2_nodes/minimal_coordinator.py`

### Coding Standards
[Source: docs/architecture/coding-standards.md#python-standards-ros2-orchestrator]

**Python Style:**
- **Classes:** `PascalCase` (e.g., `MinimalCoordinator`)
- **Functions:** `snake_case` (e.g., `cycle_expression()`)
- **Constants:** `UPPER_SNAKE_CASE` (e.g., `CYCLE_INTERVAL_SEC`)

**Type Hints:** Required for public functions

**Docstrings:** Google style

**Logging:**
- Use `self.get_logger()` for ROS2 nodes
- Levels: INFO for expression changes, DEBUG for internal state

**ROS2-Specific:**
- **Node Name:** `/olaf/minimal_coordinator`
- **Topics:** `/olaf/head/expression` (publishes only)

Example node structure:
```python
import rclpy
from rclpy.node import Node
from std_msgs.msg import String
import random

class MinimalCoordinator(Node):
    EXPRESSIONS = ['neutral', 'happy', 'curious', 'thinking', 'confused', 'sad', 'excited']
    CYCLE_INTERVAL_SEC = 10.0

    def __init__(self):
        super().__init__('minimal_coordinator')

        # Publisher
        self.expression_pub = self.create_publisher(String, '/olaf/head/expression', 10)

        # Timer for expression cycling
        self.expression_timer = self.create_timer(self.CYCLE_INTERVAL_SEC, self.expression_callback)

        self.expression_index = 0

        self.get_logger().info('Minimal Coordinator started')
        self.get_logger().info('Cycling expressions every 10 seconds')
        self.get_logger().info('Blinks handled autonomously by firmware')

    def expression_callback(self):
        expression = self.EXPRESSIONS[self.expression_index]
        intensity = random.randint(2, 4)

        # Publish expression
        msg = String()
        msg.data = f"{expression}:{intensity}"
        self.expression_pub.publish(msg)

        self.get_logger().info(f"Expression: {expression}, Intensity: {intensity}")

        # Cycle to next expression
        self.expression_index = (self.expression_index + 1) % len(self.EXPRESSIONS)

def main(args=None):
    rclpy.init(args=args)
    coordinator = MinimalCoordinator()
    rclpy.spin(coordinator)
    coordinator.destroy_node()
    rclpy.shutdown()

if __name__ == '__main__':
    main()
```

### Testing

**Test Location:** `tests/unit/orchestrator/`

**Required Tests:**
- Expression cycling logic (verify correct sequence)
- Intensity randomization (verify range 2-4)
- Timer callback execution
- Publisher creation

**Integration Test:**
- End-to-end pipeline validation
- Measure latency from publish to eye update
- 50-cycle reliability test
- Verify autonomous firmware blinks work alongside expressions

**Manual Testing:**
1. Launch head_driver: `ros2 run orchestrator head_driver`
2. Launch minimal_coordinator: `ros2 run orchestrator minimal_coordinator`
3. Observe terminal logs (expression changes every 10 seconds)
4. Observe eye displays (expression changes and autonomous blinks)
5. Echo expression topic: `ros2 topic echo /olaf/head/expression`
6. Monitor status: `ros2 topic echo /olaf/head/status`

**Latency Measurement:**
- Use `ros2 topic echo /olaf/head/expression --once` and observe eye display
- Latency should be <100ms (publish → I2C write → animation update)
- Autonomous blinks should not interfere with expression latency

### Technical Constraints

**Performance:**
- Expression timer at 10-second intervals (not time-critical)
- Publishing should not block event loop
- No blink timer needed (handled by firmware)

**Reliability:**
- Should run continuously without crashes
- 50+ expression cycles without failure
- Firmware blinks should not interfere with expression rendering

**Integration:**
- Depends on head_driver node being active
- No direct I2C access (uses ROS2 abstraction layer)

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
- None - implementation completed without issues

### Completion Notes List
- Identified discrepancy between story requirements (blink topic) and actual implementation (firmware-controlled blinks)
- Updated story v1.2 to remove all blink-related requirements
- Removed blink publisher, blink timer, and blink logging from all tasks and acceptance criteria
- Clarified that blinks are handled autonomously by ESP32 firmware
- Created simplified minimal_coordinator node focusing only on expression cycling
- Successfully built and integrated node into ROS2 package

### File List
**Created:**
- `ros2/src/orchestrator/orchestrator/ros2_nodes/minimal_coordinator.py` - Main coordinator node
- `ros2/src/orchestrator/orchestrator/ros2_nodes/__init__.py` - Package init file

**Modified:**
- `ros2/src/orchestrator/setup.py` - Added minimal_coordinator entry point and ros2_nodes to packages
- `docs/stories/1.6.minimal-orchestrator.md` - Updated to v1.2, removed blink requirements, marked tasks 1-3 complete

## QA Results
<!-- To be filled by QA agent -->

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | v1.0 | Initial story draft | Bob (Scrum Master) |
| 2025-10-25 | v1.1 | Updated from heartbeat to expression coordinator, added blink logic | Bob (Scrum Master) |
| 2025-11-01 | v1.2 | Removed blink topic requirements - blinks handled autonomously by firmware | Claude Code (Dev) |
