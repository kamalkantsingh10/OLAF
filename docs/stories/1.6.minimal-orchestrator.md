# Story 1.6: Minimal Orchestrator - Heartbeat Coordinator

## Status
Draft

## Story
**As a** software developer,
**I want** a minimal orchestrator node that sends emotion commands via ROS2,
**so that** I can prove the full pipeline (Orchestrator → ROS2 → I2C → ESP32 → SPI heart display) works.

## Acceptance Criteria

1. **Orchestrator Node:**
   - Python ROS2 node: `orchestrator/ros2_nodes/minimal_coordinator.py`
   - Node name: `/olaf/minimal_coordinator`

2. **Publisher:**
   - Publishes to `/olaf/body/emotion`

3. **Emotion Cycle:**
   - Timer cycles through emotions every 10 seconds:
     - Neutral → Happy → Excited → Sad → Curious → Thinking → Confused → repeat
   - Intensity randomly varies between 2-4

4. **Execution:**
   - Launch: `ros2 run olaf_orchestrator minimal_coordinator`
   - Every 10 seconds: Logs emotion change, heart display updates

5. **End-to-End Validation:**
   - Full chain: Coordinator → Body driver → I2C → ESP32 → SPI heart
   - Latency: Publish to heart update <100ms
   - Reliability: 50 emotion changes without failure

6. **Code Quality:**
   - Clean, commented code
   - Committed to `orchestrator/ros2_nodes/minimal_coordinator.py`

## Tasks / Subtasks

- [ ] **Task 1: Create minimal coordinator node** (AC: 1, 2)
  - [ ] Create `orchestrator/ros2_nodes/minimal_coordinator.py`
  - [ ] Initialize ROS2 node `/olaf/minimal_coordinator`
  - [ ] Create publisher for `/olaf/body/emotion` topic
  - [ ] Add ROS2 node boilerplate (init, spin, destroy)

- [ ] **Task 2: Implement emotion cycling logic** (AC: 3)
  - [ ] Define emotion sequence: neutral, happy, excited, sad, curious, thinking, confused
  - [ ] Create 10-second timer callback
  - [ ] Implement cycle logic (index wrapping)
  - [ ] Add random intensity selection (2-4)
  - [ ] Publish emotion message on each timer trigger

- [ ] **Task 3: Add logging and monitoring** (AC: 4)
  - [ ] Log emotion change with timestamp
  - [ ] Log intensity value
  - [ ] Add startup message indicating cycle start

- [ ] **Task 4: Test end-to-end pipeline** (AC: 5)
  - [ ] Launch body_driver node (Story 1.5)
  - [ ] Launch minimal_coordinator node
  - [ ] Observe heart display changes every 10 seconds
  - [ ] Measure latency from publish to visual update
  - [ ] Run 50 cycles (~8.3 minutes) without failure
  - [ ] Verify all emotions display correctly

- [ ] **Task 5: Code quality and documentation** (AC: 6)
  - [ ] Add docstrings to all functions
  - [ ] Add comments explaining emotion cycle logic
  - [ ] Clean up code formatting
  - [ ] Commit to repository

## Dev Notes

### Previous Story Insights
From Story 1.5 (ROS2 Body Driver Node):
- Body driver node subscribes to `/olaf/body/emotion` topic
- Expects emotion_type (string or enum) and intensity (1-5)
- Translates ROS2 messages to I2C register writes (0x10-0x11)
- Publishes `/olaf/body/status` at 10Hz

From Story 1.4 (Body Module ESP32 Firmware):
- Firmware processes I2C commands with <10ms latency
- Emotion types: 0=neutral, 1=happy, 2=excited, 3=sad, 4=curious, 5=thinking, 6=confused
- Intensity range: 1-5
- Heart animation updates BPM and scale based on emotion/intensity

### Technology Stack
[Source: docs/architecture/tech-stack.md]

**Orchestrator:**
- **Language:** Python 3.11+
- **ROS2 Version:** Humble (LTS until 2027)
- **Logging:** Python logging (ROS2 integration)

### ROS2 Node Architecture
[Source: docs/architecture/ros2-node-architecture.md]

**High-Level Application Nodes:**
```
/olaf/personality_coordinator (Python)
• Coordinates eyes + ears + neck + beeps
• Subscribes: /olaf/ai/emotion_command
• Publishes: /olaf/head/eye_expression, etc.
```

**Note:** This minimal coordinator is a simplified version for Epic 1 validation. Full personality coordinator will be implemented in Epic 3.

### Data Models
[Source: docs/architecture/data-models.md]

**Expression Types:**
```cpp
#define EXPR_NEUTRAL  0x00
#define EXPR_HAPPY    0x01
#define EXPR_EXCITED  0x02
#define EXPR_SAD      0x03
#define EXPR_CURIOUS  0x04
#define EXPR_THINKING 0x05
#define EXPR_CONFUSED 0x06
```

**ROS2 Message Format (if using custom message):**
```python
# olaf_msgs/msg/Expression.msg
string emotion              # 'neutral', 'happy', 'excited', etc.
uint8 intensity             # 1-5
uint8 duration_ms
bool synchronize
```

**Alternative (using std_msgs):**
- Can use `std_msgs/String` with JSON payload
- Or create simple dict and serialize

### File Locations
[Source: docs/architecture/source-tree.md]

**Orchestrator Structure:**
```
orchestrator/
├── ros2_nodes/
│   ├── minimal_coordinator.py    # <-- THIS STORY
│   ├── hardware_drivers/
│   ├── personality/
│   ├── ai_integration/
│   └── navigation/
├── launch/
├── config/
└── README.md
```

**Key Path:**
- Node file: `orchestrator/ros2_nodes/minimal_coordinator.py`

### Coding Standards
[Source: docs/architecture/coding-standards.md#python-standards-ros2-orchestrator]

**Python Style:**
- **Classes:** `PascalCase` (e.g., `MinimalCoordinator`)
- **Functions:** `snake_case` (e.g., `cycle_emotion()`)
- **Constants:** `UPPER_SNAKE_CASE` (e.g., `CYCLE_INTERVAL_SEC`)

**Type Hints:** Required for public functions

**Docstrings:** Google style

**Logging:**
- Use `self.get_logger()` for ROS2 nodes
- Levels: INFO for emotion changes, DEBUG for internal state

**ROS2-Specific:**
- **Node Name:** `/olaf/minimal_coordinator`
- **Topic:** `/olaf/body/emotion`

Example node structure:
```python
import rclpy
from rclpy.node import Node
from std_msgs.msg import String
import random

class MinimalCoordinator(Node):
    EMOTIONS = ['neutral', 'happy', 'excited', 'sad', 'curious', 'thinking', 'confused']
    CYCLE_INTERVAL_SEC = 10.0

    def __init__(self):
        super().__init__('minimal_coordinator')

        self.publisher_ = self.create_publisher(String, '/olaf/body/emotion', 10)
        self.timer = self.create_timer(self.CYCLE_INTERVAL_SEC, self.timer_callback)
        self.emotion_index = 0

        self.get_logger().info('Minimal Coordinator started, cycling emotions every 10 seconds')

    def timer_callback(self):
        emotion = self.EMOTIONS[self.emotion_index]
        intensity = random.randint(2, 4)

        # Publish emotion (format depends on message type)
        msg = String()
        msg.data = f"{emotion}:{intensity}"  # Simple format
        self.publisher_.publish(msg)

        self.get_logger().info(f"Emotion: {emotion}, Intensity: {intensity}")

        # Cycle to next emotion
        self.emotion_index = (self.emotion_index + 1) % len(self.EMOTIONS)

def main(args=None):
    rclpy.init(args=args)
    coordinator = MinimalCoordinator()
    rclpy.spin(coordinator)
    coordinator.destroy_node()
    rclpy.shutdown()

if __name__ == '__main__':
    main()
```

### Testing

**Test Location:** `tests/unit/orchestrator/`

**Required Tests:**
- Emotion cycling logic (verify correct sequence)
- Intensity randomization (verify range 2-4)
- Timer callback execution
- Publisher creation

**Integration Test:**
- End-to-end pipeline validation
- Measure latency from publish to heart update
- 50-cycle reliability test

**Manual Testing:**
1. Launch body_driver: `ros2 run olaf_drivers body_driver`
2. Launch minimal_coordinator: `ros2 run olaf_orchestrator minimal_coordinator`
3. Observe terminal logs (emotion changes every 10 seconds)
4. Observe heart display (BPM and color changes)
5. Echo topic: `ros2 topic echo /olaf/body/emotion`
6. Monitor status: `ros2 topic echo /olaf/body/status`

**Latency Measurement:**
- Use `ros2 topic echo /olaf/body/emotion --once` and observe heart display
- Latency should be <100ms (publish → I2C write → animation update)

### Technical Constraints

**Performance:**
- Timer at 10-second intervals (not time-critical)
- Publishing should not block event loop

**Reliability:**
- Should run continuously without crashes
- 50+ emotion cycles without failure

**Integration:**
- Depends on body_driver node being active
- No direct I2C access (uses ROS2 abstraction layer)

## Dev Agent Record

### Agent Model Used
<!-- To be filled by dev agent -->

### Debug Log References
<!-- To be filled by dev agent -->

### Completion Notes List
<!-- To be filled by dev agent -->

### File List
<!-- To be filled by dev agent -->

## QA Results
<!-- To be filled by QA agent -->

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | v1.0 | Initial story draft | Bob (Scrum Master) |
