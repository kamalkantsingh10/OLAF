# Story 1.2: Power System Assembly & Validation

## Status
Draft

## Story

**As a** robot builder,
**I want** a reliable 36V hoverboard power system with buck converters,
**so that** all modules receive stable 5V and 12V power for operation.

## Acceptance Criteria

1. **Battery Selection:**
   - Hoverboard battery salvaged (36V nominal, 4-10Ah capacity)
   - Voltage measured: 36-42V (confirms healthy cells)
   - BMS retained for safe charging

2. **Buck Converter Installation:**
   - 36V → 12V buck converter (10A) installed for Raspberry Pi power
   - 36V → 5V buck converter (10A) installed for ESP32s + servos
   - Output voltages measured under no-load: 12V ±0.2V, 5V ±0.1V

3. **Load Testing:**
   - 12V rail tested with 3A load (simulates Pi): voltage stable
   - 5V rail tested with 2A load (simulates ESP32 + servo): voltage stable
   - Both converters loaded simultaneously: no voltage sag >5%

4. **Safety:**
   - Fuse/circuit breaker on battery main output (30-40A)
   - Emergency power switch accessible
   - Proper wire gauge: 18 AWG minimum for power rails
   - Secure connectors (XT60, JST-XH, or screw terminals)

5. **Physical Mounting:**
   - Battery, converters, and connections mounted securely
   - System can be moved without cables disconnecting
   - No risk of shorts (insulated terminals)

6. **Documentation:**
   - Wiring diagram saved: `hardware/wiring/power-system-v1.jpg`
   - BOM updated with battery source, converters, connectors, costs
   - Power distribution schematic documented

**Note:** ODrive will handle battery monitoring in future epics, so no ADC voltage sensing needed in Epic 1.

## Tasks / Subtasks

### Task 1: Source and validate hoverboard battery (AC: 1)
- [ ] Salvage hoverboard battery or purchase 36V lithium battery (4-10Ah capacity)
- [ ] Verify BMS is intact and functional (charge protection, discharge protection, cell balancing)
- [ ] Measure voltage with multimeter: expect 36-42V (healthy cells)
- [ ] Document battery specifications: voltage, capacity (Ah), connector type, dimensions
- [ ] Test charge cycle: confirm BMS accepts charge and balances cells

### Task 2: Procure buck converters and safety components (AC: 2, 4)
- [ ] Purchase 36V → 12V buck converter (10A rated, adjustable output)
- [ ] Purchase 36V → 5V buck converter (10A rated, adjustable output)
- [ ] Purchase 30-40A fuse or circuit breaker for main battery output
- [ ] Purchase emergency power switch (toggle or push-button, rated 40A+)
- [ ] Purchase 18 AWG (or thicker) wire for power rails
- [ ] Purchase connectors: XT60 (battery), JST-XH or screw terminals (buck outputs)
- [ ] Verify all components rated for 36-42V input range

### Task 3: Install and configure buck converters (AC: 2)
- [ ] Mount 12V buck converter securely (heat dissipation considered)
- [ ] Mount 5V buck converter securely (heat dissipation considered)
- [ ] Connect battery to buck converters via fuse/breaker and emergency switch
- [ ] Adjust 12V buck output to 12.0V ±0.1V (use multimeter, no load)
- [ ] Adjust 5V buck output to 5.0V ±0.1V (use multimeter, no load)
- [ ] Verify output voltage stability for 5 minutes (no drift)

### Task 4: Implement safety measures (AC: 4)
- [ ] Install 30-40A fuse or circuit breaker on battery main output
- [ ] Install emergency power switch in accessible location
- [ ] Verify wire gauge: 18 AWG minimum for all power rails
- [ ] Install proper connectors: XT60 for battery, secure terminals for outputs
- [ ] Insulate all exposed terminals (heat shrink, electrical tape, terminal covers)
- [ ] Test emergency switch: verify it cuts power to entire system

### Task 5: Load testing (AC: 3)
- [ ] Create 3A test load for 12V rail (resistors or power supply electronic load)
- [ ] Apply 3A load to 12V rail, measure voltage: expect 12V ±0.3V (stable)
- [ ] Monitor buck converter temperature: should not exceed 60°C
- [ ] Create 2A test load for 5V rail (resistors or electronic load)
- [ ] Apply 2A load to 5V rail, measure voltage: expect 5V ±0.2V (stable)
- [ ] Apply both loads simultaneously: verify no voltage sag >5%
- [ ] Document load test results: voltage under load, temperature, stability

### Task 6: Physical mounting and cable management (AC: 5)
- [ ] Select mounting location for battery (low center of gravity preferred)
- [ ] Mount battery securely (Velcro straps, brackets, or enclosure)
- [ ] Mount buck converters near battery (minimize wire length)
- [ ] Route power cables away from signal wires (reduce EMI)
- [ ] Secure all cables with zip ties or cable clips
- [ ] Test system by moving/shaking: verify nothing disconnects or shorts
- [ ] Verify no risk of shorts: insulation on all connections, no exposed wires

### Task 7: Documentation and BOM update (AC: 6)
- [ ] Create wiring diagram showing battery → fuse → switch → buck converters → outputs
- [ ] Photograph assembled power system from multiple angles
- [ ] Save wiring diagram as `hardware/wiring/power-system-v1.jpg`
- [ ] Update `hardware/bom/full-olaf-bom.csv` with battery specs, converters, connectors
- [ ] Document buck converter settings (trim pot positions for 12V/5V outputs)
- [ ] Create power distribution schematic showing voltage rails and current ratings
- [ ] Add troubleshooting section: "No output voltage" → check fuse, switch, input voltage

## Dev Notes

### Power System Architecture

OLAF uses a **36V hoverboard battery** as the primary power source, with **buck converters** stepping down to 12V (Raspberry Pi) and 5V (ESP32 modules, servos).

**Key Design Decisions:**
- **Why 36V Hoverboard Battery?**
  - Salvageable from broken hoverboards (cost-effective: $0-50)
  - High capacity: 4-10Ah typical (supports 2-4 hours operation)
  - Built-in BMS: charge protection, discharge protection, cell balancing
  - Proven reliable in robotics applications
- **Why Buck Converters vs Linear Regulators?**
  - Efficiency: 85-95% (vs 30-50% for linear regulators)
  - Reduced heat: critical for enclosed robot chassis
  - Current capacity: 10A+ available for both rails

[Source: docs/prd/epic-01-foundation.md#story-12-power-system-assembly--validation]

### Power Distribution Specifications

**Voltage Rails:**
- **36V Primary:** Direct from battery (ODrive motors, future high-power peripherals)
- **12V Secondary:** Raspberry Pi 5 (5A official power supply draws ~3A typical, 5A peak)
- **5V Secondary:** ESP32 modules (5×, ~500mA each = 2.5A) + servos (varies)

**Current Budget (Typical Operation):**
| Component | Voltage | Current (Typical) | Current (Peak) |
|-----------|---------|-------------------|----------------|
| Raspberry Pi 5 | 12V | 3A | 5A |
| ESP32-S3 × 5 | 5V | 2.5A | 3A |
| Servos (idle) | 5V | 0.5A | Variable |
| **Total 12V** | - | **3A** | **5A** |
| **Total 5V** | - | **3A** | **5-8A (peak)** |

**Buck Converter Sizing:**
- 12V Rail: 10A converter provides 2× safety margin (5A peak / 10A rated = 50%)
- 5V Rail: 10A converter handles typical load + servo spikes (8A peak / 10A rated = 80%)

[Source: docs/architecture/components.md#orchestration-layer-raspberry-pi]

### Safety-Critical Requirements

OLAF is a **safety-critical system** with motors and lithium batteries. The power system MUST implement multiple layers of protection.

**Required Safety Measures:**
1. **Overcurrent Protection:** 30-40A fuse/breaker on battery main output
   - Prevents battery overdraw (BMS typically limits to 30-50A)
   - Protects wiring from fire risk
2. **Emergency Cutoff:** Accessible power switch
   - Allows immediate power-off during testing or malfunction
   - Should cut ALL power (not just control logic)
3. **Over-Discharge Protection:** BMS in hoverboard battery
   - Automatically disconnects load at ~30V (prevents cell damage)
   - No additional circuitry needed in Epic 1 (ODrive will monitor in Epic 2)
4. **Wire Gauge:** 18 AWG minimum for power rails
   - 18 AWG rated for 10A (matches buck converter capacity)
   - Prevents resistive heating and voltage drop
5. **Connector Ratings:** XT60 (60A rated), JST-XH or screw terminals
   - XT60 standard for lithium battery connections (prevents reverse polarity)
   - Screw terminals preferred for buck outputs (easy adjustment during testing)

**Coding Standards Reference:**
> "Safety First - Prevent hardware damage, battery over-discharge, unstable balancing, and motor control failures"
> "Battery Protection: Voltage monitoring (shutdown at 30V cutoff)"

[Source: docs/architecture/coding-standards.md#core-values]
[Source: docs/architecture/coding-standards.md#safety-critical-code]

### Buck Converter Configuration

**Adjustment Procedure:**
1. **Pre-Power Verification:** Verify buck input/output polarity BEFORE connecting battery
2. **No-Load Adjustment:**
   - Connect multimeter to buck output (no load connected)
   - Apply input power (36V battery)
   - Rotate trim potentiometer until output reads target voltage (12.0V or 5.0V)
   - Allow 5 minutes settling time, re-check voltage (thermal drift)
3. **Load Testing:** Apply test loads per Task 5, verify voltage stability
4. **Document Settings:** Mark trim pot position with permanent marker

**Common Issues:**
- **Output voltage drifts under load:** Insufficient input capacitance (add 100-220uF capacitor)
- **Buck converter overheats:** Insufficient heatsinking or overloaded (check current draw)
- **No output voltage:** Check input fuse, emergency switch, input polarity

### Wiring Best Practices

**EMI Reduction:**
- Route power cables away from I2C signal wires (minimum 2" separation)
- Twist positive/negative pairs together (reduces loop antenna effect)
- Use shielded cables for long runs (optional, but recommended for 36V lines)

**Cable Management:**
- Secure cables with zip ties every 6-8 inches
- Leave service loops at connections (allows adjustment without re-routing)
- Label all power rails: "36V MAIN", "12V PI", "5V LOGIC"

**Connector Strategy:**
- XT60 for battery: keyed connector prevents reverse polarity (critical for lithium)
- Screw terminals for buck outputs: easy to adjust/replace during prototyping
- JST-XH for final connections: compact, secure, removable

[Source: docs/architecture/coding-standards.md#safety-critical-code]

### Battery Monitoring (Future Work)

**Epic 1 Scope:** Basic power system assembly with no ADC voltage sensing
**Future Epics:** ODrive motor controller will monitor battery voltage via analog input
- Low battery warning at 32V (Pi voice: "I'm getting tired, please charge me")
- Auto-shutdown at 30V cutoff (prevents over-discharge damage)

This story focuses on **stable, safe power delivery**. Monitoring features deferred to Epic 2.

[Source: docs/prd/epic-01-foundation.md#story-12-note]

### Documentation Requirements

**Wiring Diagram Contents:**
- Battery symbol with voltage/capacity labels
- Fuse/breaker symbol on main output
- Emergency switch symbol
- Buck converters with input/output voltages
- Load symbols (Raspberry Pi, ESP32s, servos)
- Wire gauge annotations (18 AWG)
- Connector types (XT60, JST-XH, screw terminals)

**BOM Update Fields:**
| Component | Qty | Supplier | Unit Price | Total | Notes |
|-----------|-----|----------|------------|-------|-------|
| Hoverboard Battery (36V, 4-10Ah) | 1 | Salvage/eBay | $0-50 | $0-50 | Include BMS |
| 36V→12V Buck (10A) | 1 | AliExpress | $8-15 | $8-15 | Adjustable |
| 36V→5V Buck (10A) | 1 | AliExpress | $8-15 | $8-15 | Adjustable |
| 40A Fuse/Breaker | 1 | Amazon | $5-10 | $5-10 | Automotive type |
| Emergency Switch (40A) | 1 | Amazon | $5-10 | $5-10 | Toggle/push |
| XT60 Connectors | 2-4 | Amazon | $1/pair | $2-4 | Male/female |
| 18 AWG Wire (Red/Black) | 10ft | Amazon | $0.50/ft | $5 | Silicone insulation |

[Source: docs/architecture/source-tree.md#hardware-physical-design-files]

### Project Structure Alignment

**Hardware Documentation Paths:**
- Wiring diagram: `hardware/wiring/power-system-v1.jpg` (per AC #6)
- BOM update: `hardware/bom/full-olaf-bom.csv`
- Alternative: Module-specific BOM: `hardware/bom/module-specific/epic1-bom.csv`

**Directory Structure (from Story 1.1):**
```
hardware/
├── 3d-models/
├── wiring/                # ← Wiring diagrams go here
│   └── power-system-v1.jpg
└── bom/                   # ← BOM updates go here
    └── full-olaf-bom.csv
```

[Source: docs/architecture/source-tree.md#hardware-physical-design-files]

### Testing Standards

**Framework:** Manual hardware testing with multimeter and electronic loads

**Validation Approach:**
1. **Visual Inspection:** Verify all connections secure, no exposed wires, correct polarity
2. **No-Load Testing:** Measure output voltages with multimeter (no loads connected)
3. **Load Testing:** Apply resistive loads or electronic load, verify voltage stability
4. **Temperature Monitoring:** IR thermometer or touch test (should not exceed 60°C)
5. **Stress Testing:** Apply both loads simultaneously for 10 minutes, check for voltage sag or overheating
6. **Movement Testing:** Shake/move system to verify cable security

**Success Criteria:**
- All AC items met (battery validated, converters configured, load tests passed, safety measures implemented)
- Output voltages stable within specified tolerances (12V ±0.3V, 5V ±0.2V under load)
- No component overheating (< 60°C under 10-minute load test)
- Emergency switch functional (cuts power to entire system)
- Documentation complete (wiring diagram, BOM, photos)

**Test Equipment Required:**
- Multimeter (voltage measurement, continuity check)
- Electronic load OR resistors (3A @ 12V = 4Ω/36W, 2A @ 5V = 2.5Ω/10W)
- IR thermometer (optional, but recommended for thermal monitoring)

**Safety During Testing:**
- Always connect multimeter BEFORE applying power (check for shorts)
- Never adjust buck converters under load (disconnect outputs first)
- Wear safety glasses when working with lithium batteries
- Have fire extinguisher accessible (lithium battery precaution)

[Source: docs/architecture/coding-standards.md#testing-standards]

## Testing

### Testing Standards

**Test Approach:** Manual hardware validation with electrical measurements

**Required Test Equipment:**
- Digital multimeter (voltage, current, continuity)
- Electronic load (3A @ 12V, 2A @ 5V) OR equivalent resistive loads
- IR thermometer (thermal monitoring)
- Load timer (10-minute stress test)

**Test Procedure:**
1. **Pre-Power Inspection:** Visual check for shorts, correct polarity, secure connections
2. **No-Load Voltage Test:** Measure buck outputs with multimeter, verify 12V ±0.1V and 5V ±0.1V
3. **12V Load Test:** Apply 3A load, measure voltage, verify 12V ±0.3V and < 60°C temperature
4. **5V Load Test:** Apply 2A load, measure voltage, verify 5V ±0.2V and < 60°C temperature
5. **Combined Load Test:** Apply both loads for 10 minutes, verify no voltage sag >5%
6. **Emergency Switch Test:** Verify switch cuts power to all rails
7. **Movement Test:** Shake/move system, verify no disconnections or shorts

**Pass Criteria:**
- All acceptance criteria met (AC 1-6)
- Output voltages within tolerance under load
- No component overheating (< 60°C)
- Emergency switch functional
- Documentation complete

**Test Documentation:**
- Record voltage measurements (no-load, under load, after 10 minutes)
- Record buck converter temperatures (IR thermometer)
- Photograph assembled system (multiple angles)
- Save wiring diagram and update BOM

[Source: docs/architecture/coding-standards.md#hardware-in-the-loop]

## Change Log

| Date       | Version | Description                          | Author          |
|------------|---------|--------------------------------------|-----------------|
| 2025-10-12 | v1.0    | Initial story draft created          | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*This section will be populated by the QA agent after story completion.*
