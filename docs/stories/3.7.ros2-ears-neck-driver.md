# Story 3.7: ROS2 Ears+Neck Driver Node

## Status
Draft

## Story
**As a** software developer,
**I want** a ROS2 driver node translating ROS2 topics into I2C commands for the Ears+Neck Module,
**so that** the orchestrator can control upper-body articulation without I2C details.

## Acceptance Criteria

1. **Node Structure:**
   - Python ROS2 node: `ros2/src/orchestrator/ros2_nodes/hardware_drivers/ears_neck_driver.py`
   - Node name: `/olaf/ears_neck_driver`
   - Uses `rclpy` and `smbus2`

2. **I2C Communication:**
   - Opens I2C bus 1: `bus = SMBus(1)`
   - Helper functions for register read/write to address **0x09**

3. **ROS2 Subscriptions:**
   - `/olaf/ears/position` (custom msg: left_h, left_v, right_h, right_v)
     - Callback writes to registers 0x10-0x13 (ear positions)
   - `/olaf/neck/position` (custom msg: pan, tilt, roll)
     - Callback writes to registers 0x20-0x22 (neck positions)
   - `/olaf/gesture` (custom msg: gesture_id, speed)
     - Callback writes to registers 0x30-0x32 (coordinated gesture)

4. **ROS2 Publications:**
   - `/olaf/ears_neck/status` (std_msgs/String) at 10Hz
     - Reads status register 0x02, publishes "READY", "BUSY", or "ERROR"
   - `/olaf/ears_neck/current_position` (custom msg) at 5Hz
     - Reads registers 0x10-0x13, 0x20-0x22, publishes current positions

5. **Module Health Check:**
   - On startup: Read register 0x00, verify response is 0x09
   - If not responding: Log error, publish ERROR status
   - Periodic health check: Every 30s verify module responsive

6. **Error Handling:**
   - I2C timeout handling (module busy during gesture execution)
   - Retry logic: 3 attempts with 100ms delay
   - Persistent failure: Publish ERROR, log details

7. **Testing:**
   - Node launches: `ros2 run orchestrator ears_neck_driver`
   - Topics appear: `/olaf/ears/position`, `/olaf/neck/position`, `/olaf/gesture`
   - Manual test: Publish ear position → ears move
   - Manual test: Publish neck position → head pans/tilts/rolls
   - Manual test: Publish gesture 1 → look-left gesture executes

## Tasks / Subtasks

- [ ] **Task 1: Create ROS2 message definitions** (AC: 3, 4)
  - [ ] Create `orchestrator/msg/EarsPosition.msg`:
    ```
    uint8 left_horizontal    # 0-180 (maps to -60° to +60°)
    uint8 left_vertical      # 0-180 (maps to -45° to +45°)
    uint8 right_horizontal   # 0-180
    uint8 right_vertical     # 0-180
    ```
  - [ ] Create `orchestrator/msg/NeckPosition.msg`:
    ```
    uint8 pan   # 0-180 (maps to -90° to +90°)
    uint8 tilt  # 0-180 (maps to -45° to +45°)
    uint8 roll  # 0-180 (maps to -30° to +30°)
    ```
  - [ ] Create `orchestrator/msg/Gesture.msg`:
    ```
    uint8 gesture_id  # 0-6
    uint8 speed       # 1-5 (1=slow, 5=fast)
    ```
  - [ ] Create `orchestrator/msg/EarsNeckCurrentPosition.msg`:
    ```
    EarsPosition ears
    NeckPosition neck
    ```
  - [ ] Build messages: `colcon build --packages-select orchestrator`

- [ ] **Task 2: Create ears_neck_driver node** (AC: 1, 2)
  - [ ] Create file: `ros2_nodes/hardware_drivers/ears_neck_driver.py`
  - [ ] Import dependencies: rclpy, smbus2, message types
  - [ ] Define class: `EarsNeckDriver(Node)`
  - [ ] Initialize I2C: `self.bus = SMBus(1)`
  - [ ] I2C address: `EARS_NECK_ADDR = 0x09`
  - [ ] Helper functions:
    - [ ] `write_register(reg, value)` with error handling
    - [ ] `read_register(reg)` with error handling

- [ ] **Task 3: Implement module health check** (AC: 5)
  - [ ] On startup: Read register 0x00
  - [ ] Verify response == 0x09
  - [ ] If mismatch or timeout: Log error, set error state
  - [ ] Create timer: Periodic health check every 30s
  - [ ] Health check function: Read status register 0x02

- [ ] **Task 4: Implement ear position subscription** (AC: 3)
  - [ ] Subscribe to `/olaf/ears/position` (EarsPosition msg)
  - [ ] Callback function:
    - [ ] Extract: left_h, left_v, right_h, right_v
    - [ ] Write I2C registers:
      - [ ] 0x10 ← left_h
      - [ ] 0x11 ← left_v
      - [ ] 0x12 ← right_h
      - [ ] 0x13 ← right_v
    - [ ] Handle I2C errors (retry logic)

- [ ] **Task 5: Implement neck position subscription** (AC: 3)
  - [ ] Subscribe to `/olaf/neck/position` (NeckPosition msg)
  - [ ] Callback function:
    - [ ] Extract: pan, tilt, roll
    - [ ] Write I2C registers:
      - [ ] 0x20 ← pan
      - [ ] 0x21 ← tilt
      - [ ] 0x22 ← roll
    - [ ] Handle I2C errors

- [ ] **Task 6: Implement gesture subscription** (AC: 3)
  - [ ] Subscribe to `/olaf/gesture` (Gesture msg)
  - [ ] Callback function:
    - [ ] Extract: gesture_id, speed
    - [ ] Write I2C registers:
      - [ ] 0x30 ← gesture_id
      - [ ] 0x31 ← speed
      - [ ] 0x32 ← 1 (trigger)
    - [ ] Handle I2C errors

- [ ] **Task 7: Implement status publication** (AC: 4)
  - [ ] Create publisher: `/olaf/ears_neck/status` (String)
  - [ ] Create timer: 10Hz (100ms interval)
  - [ ] Timer callback:
    - [ ] Read register 0x02 (status byte)
    - [ ] Decode status:
      - [ ] 0x01 → "READY"
      - [ ] 0x02 → "BUSY"
      - [ ] 0x04 → "ERROR"
    - [ ] Publish status string

- [ ] **Task 8: Implement current position publication** (AC: 4)
  - [ ] Create publisher: `/olaf/ears_neck/current_position` (EarsNeckCurrentPosition)
  - [ ] Create timer: 5Hz (200ms interval)
  - [ ] Timer callback:
    - [ ] Read ear registers 0x10-0x13
    - [ ] Read neck registers 0x20-0x22
    - [ ] Populate EarsNeckCurrentPosition message
    - [ ] Publish message

- [ ] **Task 9: Implement error handling** (AC: 6)
  - [ ] I2C timeout exception handling
  - [ ] Retry logic: 3 attempts with 100ms delay
  - [ ] Persistent failure logging
  - [ ] Publish "ERROR" status on failure

- [ ] **Task 10: Create launch file entry** (AC: 7)
  - [ ] Update `launch/olaf_full.launch.py`:
    - [ ] Add ears_neck_driver node
    - [ ] Set node name: `/olaf/ears_neck_driver`
  - [ ] Or create separate launch file for testing

- [ ] **Task 11: Manual testing** (AC: 7)
  - [ ] Launch node: `ros2 run orchestrator ears_neck_driver`
  - [ ] Verify topics appear: `ros2 topic list`
  - [ ] Test ear position:
    ```bash
    ros2 topic pub /olaf/ears/position orchestrator/msg/EarsPosition \
      "{left_horizontal: 120, left_vertical: 100, right_horizontal: 70, right_vertical: 90}"
    ```
  - [ ] Verify ears move to commanded positions
  - [ ] Test neck position:
    ```bash
    ros2 topic pub /olaf/neck/position orchestrator/msg/NeckPosition \
      "{pan: 30, tilt: 90, roll: 90}"
    ```
  - [ ] Verify head pans left
  - [ ] Test gesture:
    ```bash
    ros2 topic pub /olaf/gesture orchestrator/msg/Gesture \
      "{gesture_id: 1, speed: 3}"
    ```
  - [ ] Verify look-left gesture executes

- [ ] **Task 12: Code cleanup and documentation** (AC: 7)
  - [ ] Add docstrings to all functions
  - [ ] Add inline comments
  - [ ] Update `ros2_nodes/README.md`:
    - [ ] Ears+Neck driver usage
    - [ ] Topic reference
    - [ ] I2C register mapping
    - [ ] Example commands
  - [ ] Commit code to repository

## Dev Notes

### Prerequisites
From Story 3.5 (Ears+Neck ESP32 Firmware):
- Firmware running on Ears+Neck Module (I2C address 0x09)
- I2C register map implemented (0x10-0x32)
- 7 servos (4 ears + 3 neck) responding to I2C commands

From Epic 1 Story 1.5 (ROS2 Head Driver):
- Pattern for ROS2 I2C driver established
- I2C helper functions (write_register, read_register)
- Error handling and retry logic

### I2C Register Map Reference

**From Story 3.5 Firmware:**

**Ear Control:**
| Register | Range | Description |
|----------|-------|-------------|
| 0x10 | 0-180 | Left ear horizontal (-60° to +60°) |
| 0x11 | 0-180 | Left ear vertical (-45° to +45°) |
| 0x12 | 0-180 | Right ear horizontal |
| 0x13 | 0-180 | Right ear vertical |

**Neck Control:**
| Register | Range | Description |
|----------|-------|-------------|
| 0x20 | 0-180 | Neck pan (-90° to +90°) |
| 0x21 | 0-180 | Neck tilt (-45° to +45°) |
| 0x22 | 0-180 | Neck roll (-30° to +30°) |

**Gesture Control:**
| Register | Range | Description |
|----------|-------|-------------|
| 0x30 | 0-6 | Gesture ID |
| 0x31 | 1-5 | Gesture speed |
| 0x32 | any | Trigger (write to start) |

### ROS2 Message Design

**Angle Mapping:**
- ROS2 messages use 0-180 range (uint8)
- Firmware maps to servo-specific ranges
- Example: 90 = center, 0 = min, 180 = max

**Why not use float/degrees?**
- Integer values faster over I2C
- Reduced message size
- Firmware handles angle conversion

**Alternative: Use degrees directly**
- If preferred, change message types to `int8` and use -90 to +90 range
- Update driver to convert to 0-180 before I2C write

### Error Handling Strategy

**I2C Timeout:**
```python
def write_register_with_retry(self, reg, value, retries=3):
    for attempt in range(retries):
        try:
            self.bus.write_byte_data(EARS_NECK_ADDR, reg, value)
            return True
        except IOError as e:
            self.get_logger().warn(f"I2C write failed (attempt {attempt+1}/{retries}): {e}")
            time.sleep(0.1)
    self.get_logger().error(f"I2C write to 0x{reg:02x} failed after {retries} attempts")
    return False
```

**Module BUSY State:**
- During gesture execution, module status = BUSY (0x02)
- I2C writes may be queued or ignored
- Solution: Check status before sending commands (optional)
- Or: Rely on firmware to buffer commands

### ROS2 Topic Architecture

**Topic Hierarchy:**
```
/olaf/
├── ears/
│   └── position (EarsPosition) [subscription]
├── neck/
│   └── position (NeckPosition) [subscription]
├── gesture (Gesture) [subscription]
└── ears_neck/
    ├── status (String) [publication]
    └── current_position (EarsNeckCurrentPosition) [publication]
```

**Topic Rates:**
- Position commands: On-demand (no fixed rate)
- Status publication: 10Hz (monitors READY/BUSY state)
- Current position: 5Hz (feedback for state monitoring)

### Testing Commands

**Ear Position Test:**
```bash
# Alert position (ears forward and up)
ros2 topic pub --once /olaf/ears/position orchestrator/msg/EarsPosition \
  "{left_horizontal: 120, left_vertical: 120, right_horizontal: 120, right_vertical: 120}"

# Relaxed position (ears back and level)
ros2 topic pub --once /olaf/ears/position orchestrator/msg/EarsPosition \
  "{left_horizontal: 60, left_vertical: 90, right_horizontal: 60, right_vertical: 90}"
```

**Neck Position Test:**
```bash
# Look left
ros2 topic pub --once /olaf/neck/position orchestrator/msg/NeckPosition \
  "{pan: 30, tilt: 90, roll: 90}"

# Look right
ros2 topic pub --once /olaf/neck/position orchestrator/msg/NeckPosition \
  "{pan: 150, tilt: 90, roll: 90}"

# Tilt head curious
ros2 topic pub --once /olaf/neck/position orchestrator/msg/NeckPosition \
  "{pan: 70, tilt: 110, roll: 105}"
```

**Gesture Test:**
```bash
# Look-left gesture (fast)
ros2 topic pub --once /olaf/gesture orchestrator/msg/Gesture \
  "{gesture_id: 1, speed: 5}"

# Nod-yes gesture (medium speed)
ros2 topic pub --once /olaf/gesture orchestrator/msg/Gesture \
  "{gesture_id: 3, speed: 3}"
```

**Monitor Status:**
```bash
ros2 topic echo /olaf/ears_neck/status
```

**Monitor Current Position:**
```bash
ros2 topic echo /olaf/ears_neck/current_position
```

### Performance Considerations

**I2C Bus Sharing:**
- Head Module (0x08) and Ears+Neck Module (0x09) share I2C bus
- Ensure sequential access (not simultaneous writes)
- ROS2 driver handles this via single SMBus instance

**Latency:**
- I2C write: <5ms
- Servo movement: 500ms-2s (depending on gesture speed)
- Total latency: Command to visible movement <10ms + servo time

### Troubleshooting

**Topics don't appear:**
- Check node running: `ros2 node list`
- Check message build: `colcon build --packages-select orchestrator`
- Source workspace: `source install/setup.bash`

**I2C errors:**
- Verify module at 0x09: `sudo i2cdetect -y 1`
- Check I2C permissions: User in `i2c` group
- Check wiring: SDA/SCL, GND connection to Pi

**Ears/neck don't move:**
- Check status: Should be "READY" not "ERROR"
- Verify servos powered (5V to servo controllers)
- Check firmware running: Serial monitor shows I2C commands received

**Gesture doesn't execute:**
- Check BUSY status (gesture may be executing)
- Verify trigger write (register 0x32)
- Check firmware gesture definitions (Story 3.5)

### File Locations

```
ros2/src/orchestrator/
├── msg/
│   ├── EarsPosition.msg                  # <-- THIS STORY (new)
│   ├── NeckPosition.msg                  # <-- THIS STORY (new)
│   ├── Gesture.msg                       # <-- THIS STORY (new)
│   └── EarsNeckCurrentPosition.msg       # <-- THIS STORY (new)
├── ros2_nodes/
│   └── hardware_drivers/
│       └── ears_neck_driver.py           # <-- THIS STORY (new)
├── launch/
│   └── olaf_full.launch.py               # <-- THIS STORY (update)
└── README.md                             # <-- THIS STORY (update)
```

## Dev Agent Record

### Agent Model Used
<!-- To be filled by dev agent -->

### Debug Log References
<!-- To be filled by dev agent -->

### Completion Notes List
<!-- To be filled by dev agent -->

### File List
<!-- To be filled by dev agent -->

## QA Results
<!-- To be filled by QA agent -->

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-08 | v1.0 | Initial story creation from Epic 3 | Sarah (Product Owner) |
