# Story 3.10: Complete Head Assembly Integration & Testing

## Status
Draft

## Story
**As a** quality assurance tester,
**I want** the complete head assembly tested as an integrated system with 30-minute stability validation,
**so that** Epic 3 is production-ready before Epic 5 (torso integration).

## Acceptance Criteria

1. **System Integration Checklist:**
   - [ ] Head Module (ESP32 0x08): Eyes + presence sensor functional
   - [ ] Ears+Neck Module (ESP32 0x09): 7 servos responsive
   - [ ] ROS2 drivers: head_driver, ears_neck_driver both running
   - [ ] Coordinated expression node running
   - [ ] All I2C devices detected: `sudo i2cdetect -y 1` shows 0x08, 0x09
   - [ ] Power system stable: 5V supply for ESP32s + servo controllers

2. **Functional Testing:**
   - **Eyes:** All 7 expressions render correctly at 60 FPS
   - **Ears:** All 4 servos move through full range, smooth motion
   - **Neck:** All 3 axes (pan/tilt/roll) move through full range, head stable
   - **Presence Sensor:** Detects presence within 2 meters, publishes to ROS2
   - **Coordinated Expressions:** All 7 emotions display correctly across eyes+ears+neck

3. **Gesture Testing:**
   - Execute all predefined gestures:
     - neutral, look-left, look-right, nod-yes, shake-no, tilt-curious, alert-ears-up
   - Verify smooth coordinated movement
   - No mechanical binding or servo stalling

4. **Presence-Aware Behavior Testing:**
   - Autonomous mode enabled
   - Approach Olaf: Automatically transitions to "curious" expression
   - Leave: Returns to "neutral" after 5 seconds
   - Verify presence event counting accurate

5. **30-Minute Continuous Operation Test:**
   - **Test Setup:**
     - Launch all nodes: `ros2 launch orchestrator head_system.launch.py`
     - Power system stable (bench supply or battery)
     - Timer set for 30 minutes
   - **Test Execution:**
     - Cycle through all 7 emotions every 30 seconds (60 cycles total)
     - Include random gestures every 2 minutes (15 gestures total)
     - Simulate presence events: Approach/leave 10 times during test
   - **Success Criteria:**
     - No crashes: All nodes run 30 minutes
     - No missed updates: All 60 emotion cycles complete
     - Stable latency: Expression command → visible change <200ms
     - Memory stable: ESP32 free heap doesn't decrease
     - No servo overheating: Thermal check post-test
     - No mechanical wear: Gears, brackets remain secure

6. **Metrics Collected:**
   - Total runtime: 30:00 minutes
   - Total emotion changes: 60
   - Total gestures executed: 15
   - Presence events: 10
   - I2C errors: 0
   - Average expression latency: <200ms (sampled 10 times)
   - Peak current draw: <5A

7. **Pass/Fail Criteria:**
   - PASS: All criteria met, no failures, smooth operation
   - FAIL: Any crash, >5% missed updates, latency >300ms, servo failure

8. **Documentation:**
   - Results: `tests/integration/epic3_30min_test_results.md`
   - Video: 30-second clip showing coordinated expressions
   - Photos: Full head assembly from multiple angles

## Tasks / Subtasks

- [ ] **Task 1: Pre-test system verification** (AC: 1)
  - [ ] Power on all components
  - [ ] Verify ESP32s boot (serial monitor or LED indicators)
  - [ ] Check I2C devices: `sudo i2cdetect -y 1`
    - [ ] Verify 0x08 (Head Module) present
    - [ ] Verify 0x09 (Ears+Neck Module) present
  - [ ] Launch ROS2 drivers:
    - [ ] `ros2 run orchestrator head_driver`
    - [ ] `ros2 run orchestrator ears_neck_driver`
  - [ ] Launch coordinated expression:
    - [ ] `ros2 run orchestrator coordinated_expression`
  - [ ] Verify all topics appear: `ros2 topic list`

- [ ] **Task 2: Functional component testing** (AC: 2)
  - [ ] **Test Eyes:**
    - [ ] Cycle through 7 expressions (neutral, happy, curious, thinking, confused, sad, excited)
    - [ ] Verify each expression visually distinct
    - [ ] Check 60 FPS maintained (no stuttering)
  - [ ] **Test Ears:**
    - [ ] Move each ear through full range (4 servos)
    - [ ] Verify smooth motion, no binding
    - [ ] Test asymmetric positions (left forward, right back)
  - [ ] **Test Neck:**
    - [ ] Pan: -90° to +90°
    - [ ] Tilt: -45° to +45°
    - [ ] Roll: -30° to +30°
    - [ ] Combined movements (all axes simultaneously)
  - [ ] **Test Presence Sensor:**
    - [ ] Approach from 3 meters → verify detection
    - [ ] Leave → verify detection clears
    - [ ] Check ROS2 topic: `ros2 topic echo /olaf/head/presence`

- [ ] **Task 3: Coordinated expression testing** (AC: 2)
  - [ ] Test all 7 emotions via coordinated_expression:
    ```bash
    ros2 topic pub --once /olaf/expression/set orchestrator/msg/SetExpression \
      "{emotion_type: 'happy', intensity: 4}"
    ```
  - [ ] For each emotion, verify:
    - [ ] Eyes change expression
    - [ ] Ears move to coordinated position
    - [ ] Neck adjusts pan/tilt/roll
    - [ ] All movements start simultaneously
    - [ ] Movement smooth, no stuttering

- [ ] **Task 4: Gesture testing** (AC: 3)
  - [ ] Test gestures via direct I2C or ROS2:
    - [ ] neutral
    - [ ] look-left
    - [ ] look-right
    - [ ] nod-yes
    - [ ] shake-no
    - [ ] tilt-curious
    - [ ] alert-ears-up
  - [ ] For each gesture, verify:
    - [ ] Smooth coordinated movement
    - [ ] Completes in expected time (500ms-2s depending on speed)
    - [ ] No mechanical binding or stalling

- [ ] **Task 5: Presence-aware behavior testing** (AC: 4)
  - [ ] Enable autonomous reactions (verify parameter)
  - [ ] Approach test:
    - [ ] Start at 5+ meters away
    - [ ] Approach to 2 meters
    - [ ] Verify Olaf shows "curious" expression
    - [ ] Verify eyes, ears, neck all coordinate
  - [ ] Leave test:
    - [ ] Move away >3 meters
    - [ ] Wait 5 seconds
    - [ ] Verify Olaf returns to "neutral"
  - [ ] Repeat 5 times, verify consistent behavior
  - [ ] Check event count: `ros2 topic echo /olaf/head/presence`

- [ ] **Task 6: Prepare 30-minute stability test** (AC: 5)
  - [ ] Create test script: `tests/integration/epic3_stability_test.py`
  - [ ] Script logic:
    - [ ] Loop for 30 minutes:
      - [ ] Every 30 seconds: Cycle through emotions (neutral, happy, curious, thinking, confused, sad, excited)
      - [ ] Every 2 minutes: Execute random gesture
      - [ ] Random times: Simulate presence (publish to event topic or physical approach)
    - [ ] Log all commands sent
    - [ ] Monitor for errors or failures
  - [ ] Alternative: Manual execution with checklist

- [ ] **Task 7: Execute 30-minute stability test** (AC: 5)
  - [ ] Start power system (bench supply or battery)
  - [ ] Launch all ROS2 nodes
  - [ ] Start test script or manual checklist
  - [ ] Start timer: 30:00 minutes
  - [ ] Monitor:
    - [ ] Serial outputs (ESP32 logs)
    - [ ] ROS2 logs
    - [ ] Visual observation (every 5 minutes)
  - [ ] Do NOT interrupt test unless critical failure
  - [ ] At 30 minutes: Stop test, record metrics

- [ ] **Task 8: Collect metrics** (AC: 6)
  - [ ] Total runtime: 30:00 (verify timer)
  - [ ] Emotion changes: Count from logs (should be 60)
  - [ ] Gestures executed: Count from logs (should be ~15)
  - [ ] Presence events: Count from logs (should be 10)
  - [ ] I2C errors: Check ROS2 logs (grep for "error")
  - [ ] Expression latency: Sample 10 times during test
    - [ ] Timestamp command sent
    - [ ] Timestamp visible movement
    - [ ] Calculate delta (<200ms)
  - [ ] Current draw: Measure peak current (multimeter or power supply readout)
  - [ ] Servo thermal check: Touch servos, verify not overheating (should be warm, not hot)

- [ ] **Task 9: Pass/fail evaluation** (AC: 7)
  - [ ] Check pass criteria:
    - [ ] All nodes ran 30 minutes without crash
    - [ ] ≥95% emotion cycles completed (57+ out of 60)
    - [ ] Average latency <200ms
    - [ ] No I2C communication errors
    - [ ] No servo overheating
    - [ ] No mechanical failures (loose screws, stripped gears)
  - [ ] If FAIL: Document failures, diagnose root cause, fix, retest
  - [ ] If PASS: Proceed to documentation

- [ ] **Task 10: Document results** (AC: 8)
  - [ ] Create file: `tests/integration/epic3_30min_test_results.md`
  - [ ] Include:
    - [ ] Test date and time
    - [ ] Hardware configuration (components, power supply)
    - [ ] Software versions (firmware, ROS2 node commits)
    - [ ] Test execution summary
    - [ ] Metrics collected (runtime, cycles, latency, errors)
    - [ ] Pass/fail determination
    - [ ] Observations (any issues, notes)
    - [ ] Photos: Before test, during test, after test
  - [ ] Record video: 30-second clip showing coordinated expressions
  - [ ] Save photos: Multiple angles of full head assembly

## Dev Notes

### Prerequisites
All Epic 3 stories (3.1-3.9) must be complete:
- Story 3.1: 3D printed components
- Story 3.2: Head Module PCB assembled
- Story 3.3: Ear servos assembled
- Story 3.4: Neck gimbal + Ears+Neck PCB assembled
- Story 3.5: Ears+Neck firmware
- Story 3.6: Head firmware (presence sensor)
- Story 3.7: ROS2 ears_neck_driver
- Story 3.8: ROS2 head_driver (presence)
- Story 3.9: Coordinated expression system

### Test Environment Setup

**Power System:**
- Option 1: Bench power supply (5V 5A, 12V 3A for neck servos)
- Option 2: Battery pack (ensure sufficient capacity for 30+ minutes)
- Verify voltage stable under load (no sag during servo movement)

**ROS2 Setup:**
- Raspberry Pi (in separate location, temporary I2C connection)
- Or: Development laptop running ROS2 (temporary setup for Epic 3)
- Permanent Pi integration happens in Epic 7

**Monitoring Setup:**
- Terminal 1: head_driver logs
- Terminal 2: ears_neck_driver logs
- Terminal 3: coordinated_expression logs
- Terminal 4: Test script execution
- Optional: Oscilloscope on power supply (monitor current draw)

### Test Metrics Definitions

**Emotion Cycle:**
- One complete loop: neutral → happy → curious → thinking → confused → sad → excited
- Duration: 30 seconds (30 sec / 7 emotions = ~4 sec per emotion)
- Total cycles in 30 min: 60 cycles

**Gesture:**
- Random gesture executed every 2 minutes
- 30 min / 2 min = 15 gestures
- Gestures selected from: look-left, look-right, nod-yes, shake-no, tilt-curious, alert-ears-up

**Presence Events:**
- Manual simulation: 10 approach/leave cycles during test
- Spread evenly: ~1 event every 3 minutes
- Or: Automated using ROS2 topic publish (simulate events)

**Latency Measurement:**
- Sample 10 times during test (every 3 minutes)
- Measure: ROS2 command timestamp → first visible servo movement
- Use high-speed camera or manual stopwatch
- Expected: <200ms (ROS2 overhead + I2C + servo reaction time)

**I2C Errors:**
- Check ROS2 logs for exceptions: "I2C timeout", "OSError", "IOError"
- Count total errors
- Acceptable: 0 errors (reliable communication required)

### Pass/Fail Criteria Details

**PASS Criteria:**
1. System uptime: 30:00 minutes (no crashes, no restarts)
2. Emotion cycles: ≥57 completed (≥95% of 60 target)
3. Gestures: ≥14 completed (≥93% of 15 target)
4. Presence events: ≥9 detected (≥90% of 10 simulated)
5. I2C errors: 0 (100% reliability)
6. Latency: Average <200ms (sampled 10 times)
7. Thermal: Servos warm but not hot (<60°C)
8. Mechanical: No loose screws, no stripped gears, no wobble

**FAIL Criteria (any one triggers FAIL):**
- Node crash or hang (requires restart)
- <95% completion rate (too many missed commands)
- Latency >300ms (unacceptable delay)
- I2C errors >5 (communication unreliable)
- Servo overheating (>70°C, risk of damage)
- Mechanical failure (gear stripping, screw loss, servo stall)

### Common Failure Modes & Diagnosis

**Node Crashes:**
- Check ROS2 logs for exceptions
- Check ESP32 serial output (firmware crash?)
- Verify I2C bus stable (loose wire?)

**Missed Commands:**
- Check BUSY status (module may be executing gesture)
- Verify I2C timing (commands sent too fast?)
- Check servo power (voltage sag causing stalls?)

**High Latency:**
- Check I2C bus speed (should be 400kHz)
- Verify ROS2 node CPU usage (high load?)
- Check servo response time (mechanical binding?)

**Servo Overheating:**
- Reduce continuous movement rate
- Check servo torque load (head too heavy?)
- Improve cooling (airflow, heatsinks)

**Mechanical Failures:**
- Tighten screws (use Loctite for vibration resistance)
- Check servo horn secure (stripped output shaft?)
- Verify cable routing (no pinching causing servo stall)

### Example Test Script (Python)

```python
import rclpy
from rclpy.node import Node
from orchestrator.msg import SetExpression
import time

class Epic3StabilityTest(Node):
    def __init__(self):
        super().__init__('epic3_stability_test')
        self.publisher = self.create_publisher(SetExpression, '/olaf/expression/set', 10)
        self.emotions = ['neutral', 'happy', 'curious', 'thinking', 'confused', 'sad', 'excited']
        self.emotion_index = 0
        self.test_start = time.time()
        self.cycle_count = 0

        # 30 second timer for emotion cycles
        self.emotion_timer = self.create_timer(30.0 / 7, self.emotion_callback)

    def emotion_callback(self):
        elapsed = time.time() - self.test_start
        if elapsed >= 30 * 60:  # 30 minutes
            self.get_logger().info("Test complete!")
            self.destroy_node()
            return

        emotion = self.emotions[self.emotion_index]
        msg = SetExpression()
        msg.emotion_type = emotion
        msg.intensity = 3
        self.publisher.publish(msg)
        self.get_logger().info(f"Cycle {self.cycle_count}: {emotion}")

        self.emotion_index = (self.emotion_index + 1) % len(self.emotions)
        if self.emotion_index == 0:
            self.cycle_count += 1

def main():
    rclpy.init()
    node = Epic3StabilityTest()
    rclpy.spin(node)
    rclpy.shutdown()

if __name__ == '__main__':
    main()
```

### Video/Photo Documentation

**Video Requirements:**
- Duration: 30 seconds
- Content: Cycle through all 7 emotions (4 sec each)
- Camera angle: 3/4 view showing eyes, ears, neck
- Lighting: Good visibility of all components
- Focus: Clear eyes, ear positions, neck movements

**Photo Requirements:**
- Angles: Front, side, 3/4 view, back
- Close-ups: Eyes (both), ears (left and right), neck gimbal
- Show: Complete assembly, cable routing, PCB mounting
- Resolution: High enough for documentation (1080p minimum)

### File Locations

```
tests/integration/
├── epic3_stability_test.py             # <-- THIS STORY (test script)
├── epic3_30min_test_results.md         # <-- THIS STORY (results doc)
└── epic3_test_photos/                  # <-- THIS STORY (photos/videos)
    ├── before_test_front.jpg
    ├── before_test_side.jpg
    ├── during_test_expressions.mp4
    └── after_test_thermal.jpg
```

## Dev Agent Record

### Agent Model Used
<!-- To be filled by dev agent -->

### Debug Log References
<!-- To be filled by dev agent -->

### Completion Notes List
<!-- To be filled by dev agent -->

### File List
<!-- To be filled by dev agent -->

## QA Results
<!-- To be filled by QA agent -->

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-08 | v1.0 | Initial story creation from Epic 3 | Sarah (Product Owner) |
