# Story 1.3: Head Module - Eye LCD Hardware Assembly

## Status
Draft

## Story
**As a** hardware builder,
**I want** a head module with dual eye LCD displays proving I2C + SPI communication,
**so that** I can validate the architecture with emotion-driven eye expressions.

## Acceptance Criteria

1. **Components Acquired:**
   - 1× ESP32-S3-WROOM-2 (N16R8) or ESP32-WROOM-32
   - 2× GC9A01 Round TFT Display (1.28", 240×240, SPI interface)
   - Jumper wires for SPI + I2C connections
   - Breadboard for prototyping

2. **SPI Eye Display Wiring (ESP32-S3 → 2× GC9A01):**
   - **Left Eye Display:**
     - VCC → 3.3V (ESP32-S3)
     - GND → GND
     - SCL (CLK) → GPIO12 (ESP32-S3 SPI SCK - shared)
     - SDA (MOSI) → GPIO11 (ESP32-S3 SPI MOSI - shared)
     - RES (RST) → GPIO4 (ESP32-S3 reset pin)
     - DC (or A0) → GPIO2 (ESP32-S3 data/command pin) *Note: A0 and DC are the same signal*
     - CS → GPIO5 (ESP32-S3 chip select - Left Eye)
     - LED (optional) → GPIO10 (ESP32-S3 backlight PWM control)
   - **Right Eye Display:**
     - VCC → 3.3V (ESP32-S3 - shared)
     - GND → GND (shared)
     - SCL (CLK) → GPIO12 (ESP32-S3 SPI SCK - shared)
     - SDA (MOSI) → GPIO11 (ESP32-S3 SPI MOSI - shared)
     - RES (RST) → GPIO4 (ESP32-S3 reset pin - shared)
     - DC (or A0) → GPIO2 (ESP32-S3 data/command pin - shared)
     - CS → GPIO15 (ESP32-S3 chip select - Right Eye)
     - LED (optional) → GPIO10 (shared backlight control or separate GPIO if independent control desired)

3. **I2C Wiring (Pi → ESP32-S3):**
   - Pi GPIO2 (SDA) → ESP32-S3 GPIO8 (I2C SDA)
   - Pi GPIO3 (SCL) → ESP32-S3 GPIO9 (I2C SCL)
   - Pi GND → ESP32-S3 GND (common ground)
   - Pi 5V → ESP32-S3 VIN (power from buck converter)

4. **I2C Address Assignment:**
   - ESP32 Head module configured as I2C slave at address **0x08**

5. **Communication Tests:**
   - SPI test: Upload GC9A01 library example, both eyes display at 60 FPS
   - I2C test: `sudo i2cdetect -y 1` shows device at address `0x08`
   - Verify SPI speed: 10-20 MHz clock (smooth animation, no tearing)
   - Test independent chip select: Each eye can be addressed separately

6. **Physical Mounting:**
   - Module secured to breadboard
   - Eye displays positioned side-by-side for visibility
   - Stable wiring, no loose connections

7. **Documentation:**
   - Wiring photos: `hardware/wiring/head-eye-lcd-assembly.jpg`
   - Pin mapping documented in `modules/head/README.md`
   - BOM updated with ESP32, 2× GC9A01 displays, jumper wires

## Tasks / Subtasks

- [x] **Task 1: Procure components** (AC: 1)
  - [x] Purchase or verify ESP32-S3-WROOM-2 (N16R8) or ESP32-WROOM-32
  - [x] Purchase 2× GC9A01 Round TFT Display (1.28", 240×240, SPI)
  - [x] Gather jumper wires (male-to-male, male-to-female)
  - [x] Obtain breadboard for prototyping
  - [x] Verify component specifications match requirements

- [x] **Task 2: Wire SPI display connections for both eyes** (AC: 2)
  - [x] **Left Eye (CS: GPIO5):**
    - [x] Connect GC9A01 VCC → ESP32-S3 3.3V
    - [x] Connect GC9A01 GND → ESP32-S3 GND
    - [x] Connect GC9A01 SCL (CLK) → ESP32-S3 GPIO12 (SPI SCK - shared)
    - [x] Connect GC9A01 SDA (MOSI) → ESP32-S3 GPIO11 (SPI MOSI - shared)
    - [x] Connect GC9A01 RES (RST) → ESP32-S3 GPIO4 (shared)
    - [x] Connect GC9A01 DC (or A0) → ESP32-S3 GPIO2 (shared)
    - [x] Connect GC9A01 CS → ESP32-S3 GPIO5 (Left Eye CS)
    - [x] Optional: Connect GC9A01 LED → ESP32-S3 GPIO10 (backlight control)
  - [x] **Right Eye (CS: GPIO15):**
    - [x] Connect GC9A01 VCC → ESP32-S3 3.3V (shared with left)
    - [x] Connect GC9A01 GND → ESP32-S3 GND (shared)
    - [x] Connect GC9A01 SCL (CLK) → ESP32-S3 GPIO12 (shared)
    - [x] Connect GC9A01 SDA (MOSI) → ESP32-S3 GPIO11 (shared)
    - [x] Connect GC9A01 RES (RST) → ESP32-S3 GPIO4 (shared)
    - [x] Connect GC9A01 DC (or A0) → ESP32-S3 GPIO2 (shared)
    - [x] Connect GC9A01 CS → ESP32-S3 GPIO15 (Right Eye CS)
    - [x] Optional: Connect GC9A01 LED → ESP32-S3 GPIO10 (shared or separate GPIO)
  - [x] Verify all SPI connections secure

- [x] **Task 3: Wire I2C connection to Raspberry Pi** (AC: 3)
  - [x] Connect Pi GPIO2 (SDA) → ESP32-S3 GPIO8 (I2C SDA)
  - [x] Connect Pi GPIO3 (SCL) → ESP32-S3 GPIO9 (I2C SCL)
  - [x] Connect Pi GND → ESP32-S3 GND (common ground)
  - [x] Optional for Epic 1: Connect Pi 5V → ESP32-S3 VIN (or use separate USB power)
  - [x] Verify I2C wiring with continuity tester
  - [x] Ensure no shorts between SDA/SCL or power/ground

- [x] **Task 4: Configure I2C address** (AC: 4)
  - [x] Document head module I2C address: 0x08
  - [x] Add to `modules/head/firmware/config.h`: `#define I2C_SLAVE_ADDRESS 0x08`
  - [x] Note address for future firmware implementation (Story 1.4)

- [x] **Task 5: Test SPI displays** (AC: 5)
  - [x] Install Arduino IDE or PlatformIO
  - [x] Install GC9A01 library (Adafruit_GC9A01A or TFT_eSPI)
  - [x] Upload GC9A01 test sketch with dual CS configuration
  - [x] Verify both displays show test patterns
  - [x] Test each eye independently using chip select
  - [x] Measure SPI clock speed (oscilloscope or logic analyzer, optional)
  - [x] Target: 10-20 MHz for smooth 60 FPS animation
  - [x] Observe for tearing or artifacts (should be smooth)

- [x] **Task 6: Test I2C connection** (AC: 5)
  - [x] On Raspberry Pi, run: `sudo i2cdetect -y 1`
  - [x] Note: ESP32 must have I2C slave firmware running (may need basic test firmware)
  - [x] Alternative: Flash minimal I2C slave sketch that responds to address 0x08
  - [x] Verify device appears at address 0x08 in i2cdetect grid
  - [x] If not detected, check wiring and pull-up resistors

- [x] **Task 7: Physical mounting and cable management** (AC: 6)
  - [x] Insert ESP32 into breadboard securely
  - [x] Position both GC9A01 displays side-by-side for visibility
  - [x] Route SPI wires neatly (keep short to minimize interference)
  - [x] Route I2C wires separately from SPI (reduce crosstalk)
  - [x] Verify no loose connections (gently tug wires)
  - [x] Test stability: move breadboard, verify nothing disconnects

- [x] **Task 8: Documentation** (AC: 7)
  - [x] Photograph assembled module from multiple angles
  - [x] Photograph wiring close-up showing pin connections for both eyes
  - [x] Save photos to `hardware/media/head-module/` (3 photos: IMG_2244-2246.HEIC)
  - [ ] Create or update `modules/head/README.md` with pin mapping (pending user approval)
  - [x] Update `hardware/bom/epic1_bom.csv` with components and costs
  - [x] Document supplier links (AliExpress, Digitec)

## Dev Notes

### Previous Story Insights
From Story 1.1 (Repository Setup):
- Repository structure created with modules/head/ directory
- `shared/i2c_registers.h` created with common I2C register definitions

From Story 1.2 (Raspberry Pi ROS2 Setup):
- I2C enabled on Raspberry Pi at /dev/i2c-1
- I2C bus accessible via GPIO2 (SDA) and GPIO3 (SCL)
- User added to i2c group for permissions
- i2c-tools installed for testing (i2cdetect, i2cget, i2cset)

### Technology Stack
[Source: docs/architecture/tech-stack.md]

**Module Hardware:**
- **MCU:** ESP32-S3-WROOM-2 (N16R8) or ESP32-WROOM-32
  - ESP32-S3 preferred: Dual-core @ 240MHz, 512KB SRAM, 8MB PSRAM, 16MB Flash
  - Pin count: 45 GPIO (enough for dual SPI displays + I2C + future expansion)
- **Display:** 2× GC9A01 Round TFT Display
  - Size: 1.28" diagonal each
  - Resolution: 240×240 pixels each
  - Interface: SPI (10-20 MHz for 60 FPS)
  - Colors: 65K (RGB565)

**Communication:**
- **I2C:** 400kHz-1MHz, head module address 0x08
- **SPI:** 10-20 MHz for dual display rendering

### Component Specifications
[Source: docs/architecture/components.md#head-module]

**Head Module Hardware:**
- ESP32-S3-WROOM-2 (N16R8: 16MB Flash, 8MB PSRAM)
- 2× GC9A01 Round TFT Display (1.28", 240×240, SPI)

**I2C Address:** 0x08

**Responsibilities (deferred to Story 1.4 firmware):**
- Dual eye LCD displays with emotion-driven expressions
- 60 FPS animation rendering on both displays
- Synchronized eye animations

### Pin Assignments

**SPI Display Wiring (ESP32-S3 → 2× GC9A01):**

**Shared Signals:**
| GC9A01 Pin | Function | ESP32-S3 GPIO | Notes |
|------------|----------|---------------|-------|
| VCC | Power | 3.3V | Both displays share power |
| GND | Ground | GND | Common ground |
| SCL (CLK) | SPI Clock | GPIO12 | Shared between both displays (ESP32-S3 default SPI SCK) |
| SDA (MOSI) | SPI Data | GPIO11 | Shared between both displays (ESP32-S3 default SPI MOSI) |
| RES (RST) | Reset | GPIO4 | Shared - both displays reset together |
| DC (or A0) | Data/Command | GPIO2 | Shared (A0 and DC are the same signal on some GC9A01 boards) |
| LED (optional) | Backlight PWM | GPIO10 | Optional brightness control via PWM |

**Individual Chip Select (CS) Pins:**
| Display | CS Pin | ESP32-S3 GPIO | Notes |
|---------|--------|---------------|-------|
| Left Eye | CS | GPIO5 | Independently selectable |
| Right Eye | CS | GPIO15 | Independently selectable |

**I2C Wiring (Raspberry Pi → ESP32-S3):**
| Pi Pin | Function | ESP32-S3 GPIO | Notes |
|--------|----------|---------------|-------|
| GPIO2 | I2C SDA | GPIO8 | I2C SDA (flexible GPIO mapping on ESP32-S3) |
| GPIO3 | I2C SCL | GPIO9 | I2C SCL (flexible GPIO mapping on ESP32-S3) |
| GND | Ground | GND | **Critical: Common ground required** |
| 5V (optional) | Power | VIN | Epic 1: Can use USB power instead |

**Power Options for Epic 1:**
- **Option 1:** USB power bank → ESP32 USB port (simplest for testing)
- **Option 2:** Raspberry Pi 5V pin → ESP32 VIN (shared power)
- **Option 3:** Separate bench power supply → ESP32 VIN

### I2C Address Map
[Source: docs/architecture/data-models.md]

**Epic 1 Modules:**
- **0x08:** Head module (dual eye LCDs)

**Future Modules (Epic 2+):**
- 0x09: Ears+Neck module (servos)
- 0x0A: Body module (heart LCD, projector control, LEDs)
- 0x0B: Base module (self-balancing)

### SPI Communication Details

**GC9A01 Pin Variations:**
- **DC vs A0:** Some GC9A01 boards label the Data/Command pin as "A0" instead of "DC" - they are electrically identical
- **LED Pin:** Optional backlight control pin (present on some boards, not all)
  - If present: Connect to GPIO10 for PWM brightness control
  - If absent: Backlight is always on (internally connected to VCC)
  - Can leave disconnected for testing (backlight will be at full brightness)

**Dual Display Strategy:**
- Both displays share SCK, MOSI, DC, RST signals
- Each display has independent CS (Chip Select)
- Only one display active at a time (via CS pin)
- Rendering strategy: Update left eye, update right eye, repeat

**SPI Speed Considerations:**
- **10 MHz:** Conservative, guaranteed stable for dual displays
- **20 MHz:** Optimal for 60 FPS on dual 240×240 displays
- **Higher speeds:** May work but risk signal integrity issues with jumper wires

**Jumper Wire Limitations:**
- Keep SPI wires short (<15cm recommended)
- Avoid running parallel to I2C wires (crosstalk)
- Twisted pair for CLK/MOSI reduces EMI

**Frame Rate Calculation (Dual Displays):**
- 240×240 pixels = 57,600 pixels/display
- 2 displays = 115,200 pixels total/frame
- RGB565 = 2 bytes/pixel = 230,400 bytes/frame
- At 20 MHz SPI: ~87 frames/second max (60 FPS achievable)

### I2C Communication Details

**I2C Pull-up Resistors:**
- Raspberry Pi has internal 1.8kΩ pull-ups on I2C pins
- ESP32 has internal pull-ups (can be enabled in firmware)
- External 4.7kΩ pull-ups recommended for longer wires (>30cm) or multiple devices

**I2C Speed:**
- Standard mode: 100 kHz
- Fast mode: 400 kHz (recommended for Epic 1)
- Fast mode plus: 1 MHz (optional, test stability)

**Testing I2C Without Firmware:**
- ESP32 needs minimal I2C slave firmware to respond to i2cdetect
- Alternative: Test continuity and voltage levels with multimeter
- Full I2C validation deferred to Story 1.4 (firmware)

### File Locations
[Source: docs/architecture/source-tree.md]

**Documentation Paths:**
```
hardware/
├── wiring/
│   └── head-eye-lcd-assembly.jpg      # <-- THIS STORY
├── bom/
│   └── epic1_bom.csv                  # <-- THIS STORY (update)
└── photos/
    └── epic1/                         # <-- THIS STORY

modules/head/
├── README.md                          # <-- THIS STORY (create/update)
└── firmware/                          # Future: Story 1.4
```

### BOM Update Template

Add to `hardware/bom/epic1_bom.csv`:

```csv
Item,Description,Quantity,Supplier,Link,Cost (USD),Notes
ESP32-S3-WROOM-2,ESP32 dev board N16R8,1,AliExpress,https://...,4.50,16MB Flash 8MB PSRAM
GC9A01,Round TFT 1.28" 240x240,2,Adafruit,https://...,30.00,SPI interface (2 displays)
Jumper Wires,Male-to-male 20cm,30,Amazon,https://...,5.00,For breadboard (dual displays)
Breadboard,830 tie-points,1,Amazon,https://...,5.00,Full-size recommended for dual displays
USB Power Bank,5V 2A output,1,Any,N/A,10.00,Temporary power for Epic 1
```

### Testing

**SPI Display Test (AC: 5):**
1. Install GC9A01 library in Arduino IDE or PlatformIO
2. Configure library for dual CS pins (GPIO5 and GPIO15)
3. Upload test sketch that alternates between eyes
4. Observe both displays showing test patterns (lines, circles, text)
5. Test independent addressing (left eye only, right eye only, both)
6. Success: Both displays show clear graphics at 60 FPS (smooth animation)
7. Failure indicators: Blank screen, garbage pixels, flickering, only one eye working

**I2C Connection Test (AC: 5):**
1. Flash minimal I2C slave firmware to ESP32 (respond at 0x08)
2. On Raspberry Pi: `sudo i2cdetect -y 1`
3. Expected output: Grid showing "08" at row 00, column 08
4. Success: Device detected at 0x08
5. Failure: Empty grid or "UU" (indicates wiring issue or firmware not running)

**Troubleshooting:**
- **One or both displays blank:** Check VCC/GND, verify SPI wiring, check library configuration
- **One display works, other doesn't:** Verify CS pins (GPIO5 vs GPIO15), check individual display wiring
- **Displays show garbage:** Reduce SPI speed, check wire length, verify pin assignments
- **Eyes not synchronized:** Check CS logic in test firmware, verify shared signal integrity
- **I2C not detected:** Check common ground, verify SDA/SCL not swapped, check pull-ups
- **Intermittent connection:** Loose jumper wires, poor breadboard contact

### Power Constraints (Epic 1)
[Source: Epic 1 notes]

**Temporary Power Setup:**
- Raspberry Pi: Official USB-C power supply (5A recommended)
- ESP32 + 2× GC9A01: USB power bank (5V 2A) or bench power supply
- **No integrated power system in Epic 1** (full power system deferred to Epic 5)

**Current Draw Estimates:**
- ESP32-S3: ~200-300mA active, ~500mA peak
- 2× GC9A01 Displays: ~200-300mA total (backlight + logic for both)
- **Total:** ~500-600mA typical, ~800mA peak
- USB power bank (2A rated) provides adequate margin

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (claude-sonnet-4-5-20250929) - "James" Dev Agent

### Debug Log References
- Build log: `buildlogs/2025-10-26.md` - Documented ESP32-S3 crash fix (USE_HSPI_PORT)
- Commit: `4f75025` - feat(story-1.3): complete dual display and I2C communication testing

### Completion Notes List
1. **ESP32-S3 Crash Fix:** Required `USE_HSPI_PORT` define for espressif32 platform >= 6.7.0
2. **I2C Initialization:** Fixed `Wire.begin()` parameter order - use `Wire.setPins()` then `Wire.begin(address)`
3. **TFT_eSPI Configuration:** Moved all settings to platformio.ini build flags (survives `pio clean`)
4. **Dual Display Control:** Commented out `TFT_CS` in config to enable manual CS control (GPIO5, GPIO15)
5. **I2C Testing:** Verified with `sudo i2cdetect -y 1` (shows device 0x08)
6. **Text Display Test:** Successfully sent text via I2C using `i2ctransfer`

### File List
**Modified:**
- `modules/head/platformio.ini` - Added TFT_eSPI build flags, include path for firmware/
- `modules/head/src/main.cpp` - Fixed I2C initialization, added dual display support

**Created:**
- `modules/head/firmware/config.h` - Pin assignments and constants
- `hardware/bom/epic1_bom.csv` - Bill of materials with costs (98.21 CHF total)
- `hardware/media/head-module/` - Photos (IMG_2244.HEIC, IMG_2245.HEIC, IMG_2246.HEIC)

**Configuration (external library):**
- `.pio/libdeps/esp32-s3-devkitc-1/TFT_eSPI/User_Setup.h` - Manually configured for testing (replaced by platformio.ini build flags)

## QA Results
<!-- To be filled by QA agent -->

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | v1.0 | Initial story draft | Bob (Scrum Master) |
| 2025-10-25 | v1.1 | Updated from heart LCD to dual eye LCDs, Head Module 0x08 | Bob (Scrum Master) |
| 2025-10-26 | v1.2 | Corrected ESP32-S3 SPI pins (GPIO12/11 not GPIO18/23), added A0/LED pin documentation | James (Dev Agent) |
| 2025-10-26 | v1.3 | Updated I2C pins to GPIO8/GPIO9 (validated available on ESP32-S3) | James (Dev Agent) |
