# Story 3.2: Head Module PCB Assembly - Eyes & Presence Sensor Integration

## Status
Draft

## Story
**As a** hardware builder,
**I want** a soldered Head Module PCB integrating dual eyes and presence sensor into the 3D-printed head housing,
**so that** I have a robust, permanent head assembly with reliable connections.

## Acceptance Criteria

1. **Component Preparation:**
   - ESP32-S3-WROOM-2 (N16R8) module
   - 2× GC9A01 Round TFT displays (1.28", 240×240, from Epic 1)
   - DFRobot SEN0395 mmWave presence sensor acquired
   - General purpose PCB (perfboard, double-sided recommended)
   - Soldering supplies: solder, flux, helping hands
   - M3 screws/standoffs for PCB and display mounting
   - I2C cable (4-wire: SDA, SCL, GND, 3.3V) to route through neck to torso

2. **PCB Layout & Soldering:**
   - PCB designed to fit in head housing rear compartment
   - ESP32-S3 soldered to PCB with header pins or direct mount
   - SPI connections soldered: Both GC9A01 displays to ESP32 (shared SCK, MOSI, DC, RST; individual CS pins)
   - Presence sensor connections soldered: VCC, GND, OUT to ESP32 GPIO16
   - I2C header/connector soldered: SDA (GPIO8), SCL (GPIO9), GND, 3.3V
   - Power input: USB or external 5V input to ESP32 VIN
   - All solder joints inspected (no cold joints, bridges, or shorts)

3. **Eye Display Mounting:**
   - Left GC9A01 display mounted in `eye-mount-left` bracket
   - Right GC9A01 display mounted in `eye-mount-right` bracket
   - SPI cables from PCB to displays (ribbon cable or individual wires)
   - Eye mounts secured to `head-front-panel.stl` with M3 screws
   - Displays aligned: Both eyes level, centered in cutouts, parallel to each other

4. **Presence Sensor Integration:**
   - DFRobot SEN0395 mounted in `presence-sensor-mount.stl` bracket
   - Sensor positioned: Forward-facing, centered above/between eyes
   - Sensor wired to PCB (3-4 wire cable: VCC, GND, OUT, optional TX/RX)
   - Sensor bracket secured to head housing

5. **PCB Mounting & Cable Routing:**
   - Head Module PCB secured inside head housing rear compartment (standoffs or adhesive)
   - USB port accessible for firmware updates
   - I2C cable routed through neck cable channel (exits bottom of head, ready for neck gimbal routing)
   - Cable management: Organized, secured with cable ties, no loose wires
   - Cable strain relief at PCB connections

6. **Head Housing Assembly:**
   - `head-front-panel.stl` attached to `head-housing-main.stl`
   - `head-housing-back.stl` secured (removable for maintenance)
   - All cable routing channels clear
   - Structural integrity: No flex, all panels secure

7. **Functional Testing:**
   - Power on: ESP32 boots (via USB or external 5V)
   - Epic 1 firmware test: Both eyes display neutral expression
   - Presence sensor: Digital output toggles when presence detected (verify with multimeter or serial monitor)
   - **Temporary I2C test:** Connect I2C cable to Raspberry Pi (in separate location), run `sudo i2cdetect -y 1`, verify device at 0x08
   - Expression test: `olaf-test head expression 1 3` → eyes show happy expression
   - **Note:** Permanent I2C connection to Pi in torso happens in Epic 7

8. **Documentation:**
   - PCB schematic/layout sketch: `hardware/pcb/head-module-pcb-layout.jpg`
   - Wiring photos: `hardware/wiring/head-module-pcb-assembled.jpg`
   - Pin assignments documented in `firmware/head/README.md`
   - I2C cable pinout documented for Epic 7 integration

## Tasks / Subtasks

- [ ] **Task 1: Acquire components and PCB materials** (AC: 1)
  - [ ] Verify ESP32-S3-WROOM-2 (N16R8) available
  - [ ] Verify 2× GC9A01 displays from Epic 1
  - [ ] Acquire DFRobot SEN0395 mmWave presence sensor
  - [ ] Purchase general purpose PCB (perfboard, ~5×7cm or larger)
  - [ ] Gather soldering supplies: solder, flux, wire, header pins
  - [ ] Prepare I2C cable (4-conductor, 50-100cm length for routing through neck)

- [ ] **Task 2: Design PCB layout** (AC: 2)
  - [ ] Measure head housing rear compartment dimensions
  - [ ] Sketch PCB layout on paper:
    - [ ] ESP32-S3 position (center or edge for USB access)
    - [ ] SPI header for left eye (6 pins: VCC, GND, SCK, MOSI, DC, CS)
    - [ ] SPI header for right eye (6 pins: VCC, GND, SCK, MOSI, DC, CS)
    - [ ] Presence sensor header (4 pins: VCC, GND, OUT, optional RX/TX)
    - [ ] I2C output header (4 pins: SDA, SCL, GND, 3.3V)
    - [ ] Power input (USB or external 5V)
  - [ ] Mark trace routing on PCB layout
  - [ ] Verify no overlapping traces (use jumper wires if needed)

- [ ] **Task 3: Solder ESP32 to PCB** (AC: 2)
  - [ ] Solder header pins to ESP32 (if using headers)
  - [ ] OR solder ESP32 directly to PCB (more permanent)
  - [ ] Verify USB port accessible
  - [ ] Test boot: Connect USB, verify ESP32 powers on

- [ ] **Task 4: Solder SPI connections for dual eyes** (AC: 2)
  - [ ] Solder shared SPI signals:
    - [ ] ESP32 GPIO12 (SCK) → shared trace
    - [ ] ESP32 GPIO11 (MOSI) → shared trace
    - [ ] ESP32 GPIO2 (DC) → shared trace
    - [ ] ESP32 GPIO4 (RST) → shared trace
    - [ ] ESP32 3.3V → shared VCC trace
    - [ ] ESP32 GND → shared GND trace
  - [ ] Solder individual CS pins:
    - [ ] ESP32 GPIO5 → Left eye CS
    - [ ] ESP32 GPIO15 → Right eye CS
  - [ ] Solder header pins or wire pads for both eye connections
  - [ ] Continuity test: Verify no shorts between traces

- [ ] **Task 5: Solder presence sensor connections** (AC: 2)
  - [ ] Solder presence sensor header:
    - [ ] ESP32 3.3V → VCC
    - [ ] ESP32 GND → GND
    - [ ] ESP32 GPIO16 → OUT
    - [ ] Optional: GPIO17/18 → RX/TX
  - [ ] Continuity test: Verify connections

- [ ] **Task 6: Solder I2C output header** (AC: 2)
  - [ ] Solder 4-pin I2C header:
    - [ ] ESP32 GPIO8 → SDA
    - [ ] ESP32 GPIO9 → SCL
    - [ ] ESP32 GND → GND
    - [ ] ESP32 3.3V → 3.3V (for Pi pull-ups if needed)
  - [ ] Attach I2C cable to header (solder or connector)
  - [ ] Label cable: SDA, SCL, GND, 3.3V

- [ ] **Task 7: PCB quality inspection** (AC: 2)
  - [ ] Visual inspection: All solder joints shiny, no cold joints
  - [ ] Continuity test: Verify all intended connections
  - [ ] Short check: Verify no shorts between VCC/GND or signal traces
  - [ ] Upload Epic 1 firmware, verify ESP32 boots and eyes display test pattern

- [ ] **Task 8: Mount eye displays** (AC: 3)
  - [ ] Solder wire connections to left GC9A01 (6 wires: VCC, GND, SCK, MOSI, DC, CS)
  - [ ] Solder wire connections to right GC9A01 (6 wires: VCC, GND, SCK, MOSI, DC, CS)
  - [ ] Mount left display in `eye-mount-left` bracket
  - [ ] Mount right display in `eye-mount-right` bracket
  - [ ] Connect display wires to PCB headers
  - [ ] Attach eye mounts to `head-front-panel.stl` with M3 screws
  - [ ] Verify displays level and parallel

- [ ] **Task 9: Install presence sensor** (AC: 4)
  - [ ] Solder wires to DFRobot SEN0395 (4 wires: VCC, GND, OUT, optional TX/RX)
  - [ ] Mount sensor in `presence-sensor-mount.stl` bracket
  - [ ] Connect sensor wires to PCB header
  - [ ] Secure sensor bracket to head housing (above eyes, forward-facing)

- [ ] **Task 10: Install PCB and route cables** (AC: 5)
  - [ ] Mount Head Module PCB in rear compartment (M3 standoffs or adhesive)
  - [ ] Verify USB port accessible
  - [ ] Route I2C cable through neck cable channel (exits bottom of head)
  - [ ] Organize internal wiring with cable ties
  - [ ] Add strain relief at PCB connections (hot glue or zip ties)

- [ ] **Task 11: Assemble head housing** (AC: 6)
  - [ ] Attach `head-front-panel.stl` to `head-housing-main.stl`
  - [ ] Verify I2C cable routed through cable channel
  - [ ] Secure `head-housing-back.stl` (removable for access)
  - [ ] Check structural integrity (no flex, tight fit)

- [ ] **Task 12: Functional testing** (AC: 7)
  - [ ] Power on via USB or external 5V
  - [ ] Verify Epic 1 firmware boots (eyes show neutral expression)
  - [ ] Test presence sensor:
    - [ ] Read GPIO16 with multimeter or serial monitor
    - [ ] Verify output toggles when presence detected
  - [ ] **Temporary I2C test:**
    - [ ] Connect I2C cable to Raspberry Pi (temporary setup)
    - [ ] Run `sudo i2cdetect -y 1`, verify device at 0x08
    - [ ] Run `olaf-test head expression 1 3`, verify happy expression
  - [ ] Test all 7 Epic 1 expressions
  - [ ] Disconnect temporary I2C (permanent connection in Epic 7)

- [ ] **Task 13: Documentation** (AC: 8)
  - [ ] Sketch PCB layout: `hardware/pcb/head-module-pcb-layout.jpg`
  - [ ] Photograph assembled PCB
  - [ ] Photograph head assembly (internal and external)
  - [ ] Save photos to `hardware/wiring/head-module-pcb-assembled.jpg`
  - [ ] Update `firmware/head/README.md`:
    - [ ] Add presence sensor GPIO16 pinout
    - [ ] Document I2C cable pinout (SDA, SCL, GND, 3.3V)
    - [ ] Note I2C cable routes through neck to torso Pi (Epic 7)

## Dev Notes

### Prerequisites
From Story 3.1 (3D Printing):
- Head housing components printed: front panel, main housing, back panel
- Eye mounts and presence sensor mount ready

From Epic 1 Story 1.3 & 1.4:
- Epic 1 validated dual GC9A01 eyes with breadboard prototype
- Firmware renders 7 emotions at 60 FPS
- I2C communication at address 0x08 functional

### Architecture: Pi Location
**CRITICAL NOTE:** Raspberry Pi is located in the **torso** (Epic 5), NOT in the head.

**I2C Routing:**
- Head Module I2C cable exits bottom of head housing
- Routes through neck gimbal (Story 3.4)
- Continues down through torso mounting (Epic 7)
- Connects to Raspberry Pi in torso

**Testing Strategy:**
- Epic 3: Temporary I2C connection to Pi (for validation)
- Epic 7: Permanent I2C connection through full robot assembly

### PCB Design Considerations

**PCB Size:**
- Measure head housing rear compartment before purchasing PCB
- Estimate: 5×7cm perfboard should fit (verify with housing dimensions)
- Leave clearance for USB access and cable routing

**Perfboard Type:**
- **Single-sided:** Simpler, requires more jumper wires for traces
- **Double-sided:** Better for complex routing, ground plane possible
- Hole spacing: 2.54mm (0.1") standard for breadboard-compatible components

**Component Placement:**
- ESP32 near USB access point
- SPI headers near eye cable routing
- I2C header near neck cable exit
- Presence sensor header near sensor mounting location

**Trace Routing Tips:**
- Keep VCC and GND traces wide (power distribution)
- Minimize trace length for SPI signals (signal integrity)
- Separate I2C traces from noisy SPI signals
- Use jumper wires for crossovers (on single-sided PCB)

### Pin Assignments (Head Module PCB)

**ESP32-S3 GPIO Mapping:**
| Function | GPIO | Destination | Notes |
|----------|------|-------------|-------|
| SPI SCK | GPIO12 | Both eyes (shared) | 10-20 MHz |
| SPI MOSI | GPIO11 | Both eyes (shared) | |
| SPI DC | GPIO2 | Both eyes (shared) | Data/Command |
| SPI RST | GPIO4 | Both eyes (shared) | Reset |
| SPI CS Left | GPIO5 | Left eye only | Chip select |
| SPI CS Right | GPIO15 | Right eye only | Chip select |
| Presence OUT | GPIO16 | DFRobot SEN0395 | Digital presence signal |
| I2C SDA | GPIO8 | To torso Pi | I2C data |
| I2C SCL | GPIO9 | To torso Pi | I2C clock |

**I2C Cable Pinout (to torso):**
| Wire Color | Signal | ESP32 Pin | Pi Pin (Epic 7) |
|------------|--------|-----------|-----------------|
| Red | 3.3V | 3.3V | 3.3V (optional for pull-ups) |
| Black | GND | GND | GND |
| Yellow | SDA | GPIO8 | GPIO2 (SDA) |
| Green | SCL | GPIO9 | GPIO3 (SCL) |

### Soldering Best Practices

**Preparation:**
- Clean PCB with isopropyl alcohol
- Pre-tin pads and component leads
- Use flux for easier soldering

**Technique:**
- Heat pad and component lead simultaneously
- Apply solder to junction (not iron tip)
- Remove solder, then iron (in that order)
- Inspect: Shiny, concave fillet = good joint

**Quality Checks:**
- Visual: No cold joints (dull, grainy appearance)
- Visual: No solder bridges between pads
- Continuity: Test all intended connections with multimeter
- Shorts: Verify no shorts between VCC/GND, adjacent signal pins

**Rework:**
- Use solder wick or desoldering pump for mistakes
- Add flux before reworking joints

### Cable Management

**Display Cables:**
- 6 wires per display × 2 displays = 12 wires
- Use ribbon cable or bundle individual wires with heat shrink
- Keep SPI cables <15cm for signal integrity
- Label left vs right eye cables

**Presence Sensor Cable:**
- 3-4 wires (VCC, GND, OUT, optional RX/TX)
- Route along housing interior wall
- Avoid crossing SPI cables (minimize crosstalk)

**I2C Cable:**
- 4-conductor cable, 50-100cm length
- Exits bottom of head housing
- Must route through neck gimbal (Story 3.4 cable channel design)
- Strain relief at PCB connection critical (cable will flex with neck movement)

### Testing

**PCB Functional Test (before assembly):**
- Upload Epic 1 firmware
- Connect displays to PCB via headers
- Verify both eyes display test patterns
- Test all 7 expressions

**Presence Sensor Test:**
- Power sensor (3.3V)
- Approach sensor from 1-3 meters
- Verify GPIO16 output toggles HIGH/LOW
- Serial monitor: Print presence status

**I2C Temporary Test:**
- Connect I2C cable to Pi (temporary, not through neck yet)
- Run i2cdetect, verify 0x08 detected
- Test expressions via olaf-test CLI
- Disconnect for final assembly

**Troubleshooting:**
- **Eyes not working:** Check SPI solder joints, verify CS pins not swapped
- **One eye works:** Check individual CS connection (GPIO5 vs GPIO15)
- **I2C not detected:** Verify SDA/SCL not swapped, check GND connection
- **Presence sensor always HIGH/LOW:** Check VCC/GND, verify sensor orientation

### File Locations

```
hardware/
├── pcb/
│   └── head-module-pcb-layout.jpg    # <-- THIS STORY (PCB sketch)
├── wiring/
│   └── head-module-pcb-assembled.jpg # <-- THIS STORY (photos)

firmware/head/
└── README.md                         # <-- THIS STORY (update pin assignments)
```

## Dev Agent Record

### Agent Model Used
<!-- To be filled by dev agent -->

### Debug Log References
<!-- To be filled by dev agent -->

### Completion Notes List
<!-- To be filled by dev agent -->

### File List
<!-- To be filled by dev agent -->

## QA Results
<!-- To be filled by QA agent -->

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-08 | v1.0 | Initial story creation from Epic 3 with PCB soldering approach | Sarah (Product Owner) |
