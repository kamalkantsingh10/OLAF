# Story 1.1.1: Refactor Repository Structure for 4-Module Architecture

## Status
Review

## Story

**As a** developer building OLAF firmware,
**I want** the repository module structure to match the current 4-module I2C architecture,
**so that** I can develop modules without confusion about which directories to use and what I2C addresses to reference.

## Acceptance Criteria

1. Module directories updated to reflect 4-module architecture:
   ```
   firmware/
   ├── head/                   # I2C 0x08 (unchanged)
   ├── ears-neck/              # I2C 0x09 (consolidates old ears + neck)
   ├── body/                   # I2C 0x0A (consolidates old projector + body indicators)
   └── base/                   # I2C 0x0B (unchanged, was 0x0C)
   ```

2. `shared/i2c_registers.h` updated with correct module I2C addresses and descriptions:
   - Module ID definitions: `MODULE_ID_HEAD (0x08)`, `MODULE_ID_EARS_NECK (0x09)`, `MODULE_ID_BODY (0x0A)`, `MODULE_ID_BASE (0x0B)`
   - Comments document each module's responsibilities

3. Architecture documentation updated:
   - `docs/architecture/source-tree.md` updated to show 4-module structure with correct I2C addresses
   - Remove references to old 5-module structure (separate ears/neck/projector/body)

4. Configuration files updated:
   - `ros2/src/orchestrator/config/module_i2c_addresses.yaml` created with correct module mapping (if doesn't exist)
   - Any references to old module names or addresses removed

5. All changes committed with message: "refactor: update repository structure to 4-module I2C architecture"

## Tasks / Subtasks

### Task 1: Reorganize module directories (AC: 1)
- [ ] Create `firmware/ears-neck/` directory
- [ ] Move any existing `firmware/ears/` content to `firmware/ears-neck/` (if exists)
- [ ] Create `firmware/ears-neck/firmware/` subdirectory
- [ ] Create `firmware/ears-neck/platformio.ini` placeholder
- [ ] Create `firmware/ears-neck/README.md` documenting 7-servo unified control (ears 4× SCS0009 + neck 3× STS3215)
- [ ] Remove old `firmware/neck/` directory (if exists)
- [ ] Remove old `firmware/projector/` directory (if exists)
- [ ] Verify `firmware/head/` exists (should already exist from Story 1.1)
- [ ] Verify `firmware/body/` exists (should already exist from Story 1.1)
- [ ] Verify `firmware/base/` exists (should already exist from Story 1.1)

### Task 2: Update shared I2C register definitions (AC: 2)
- [ ] Read current `shared/i2c_registers.h`
- [ ] Add module ID constant definitions:
  ```cpp
  // Module I2C Addresses
  #define MODULE_ID_HEAD        0x08
  #define MODULE_ID_EARS_NECK   0x09
  #define MODULE_ID_BODY        0x0A
  #define MODULE_ID_BASE        0x0B
  ```
- [ ] Add comprehensive comments documenting each module's hardware responsibilities
- [ ] Update any comments that reference old 5-module structure or incorrect addresses
- [ ] Ensure consistency with `docs/architecture/data-models.md` and `docs/architecture/components.md`

### Task 3: Update architecture documentation (AC: 3)
- [ ] Read `docs/architecture/source-tree.md`
- [ ] Update `/firmware/` section (lines 110-164) to show 4-module structure
- [ ] Update I2C address references throughout document (0x08, 0x09, 0x0A, 0x0B)
- [ ] Update module descriptions to match `docs/architecture/components.md`
- [ ] Remove references to separate ears/neck/projector modules
- [ ] Update file naming examples to use correct module names

### Task 4: Create/update module configuration (AC: 4)
- [ ] Check if `ros2/src/orchestrator/config/module_i2c_addresses.yaml` exists
- [ ] If not exists, create with correct 4-module mapping:
  ```yaml
  modules:
    head:
      i2c_address: 0x08
      description: "Eyes (2× GC9A01), mmWave sensor, I2S mics, speaker"
    ears_neck:
      i2c_address: 0x09
      description: "Ears 4× servos + Neck 3× servos (2 UART controllers)"
    body:
      i2c_address: 0x0A
      description: "Heart LCD (GC9A01), projector relay, WS2812B LEDs"
    base:
      i2c_address: 0x0B
      description: "Self-balancing (MPU6050, ODrive, kickstand servo)"
  ```
- [ ] Update any orchestrator code that references old module names/addresses (if any exists)
- [ ] Search codebase for hardcoded addresses (0x0C) and update to 0x0B

### Task 5: Commit changes (AC: 5)
- [ ] Stage all modified files
- [ ] Verify no unintended changes included
- [ ] Create commit: "refactor: update repository structure to 4-module I2C architecture"
- [ ] Push to repository

## Dev Notes

### Architecture Context

This story aligns the repository structure with the **current 4-module architecture** as defined in the architecture documents. The consolidation was driven by:

1. **Ears + Neck Unification (I2C 0x09):** Both use UART serial bus servo controllers, sharing a single ESP32 reduces hardware cost and simplifies upper-body coordination
2. **Body Module Creation (I2C 0x0A):** Groups heart LCD, projector power relay, and status LEDs under single ESP32 for body-mounted indicators
3. **Base Address Change (0x0B):** Adjusted from old 0x0C to fill address gap after consolidation

[Source: docs/architecture/components.md#ears--neck-module-shared-esp32]
[Source: docs/architecture/components.md#body-module-heart-display--projector-control--leds]

### Current Module Definitions

**From Architecture (docs/architecture/components.md):**

1. **Head Module (I2C 0x08)**
   - ESP32-S3-WROOM-2 (N16R8)
   - 2× GC9A01 Round TFT (240×240 eyes)
   - DFRobot SEN0395 mmWave sensor
   - 2× INMP441 I2S microphones
   - PAM8403 amplifier + speaker
   - 60 FPS animation rendering
   [Source: docs/architecture/components.md#head-module]

2. **Ears + Neck Module (I2C 0x09)**
   - ESP32-S3-WROOM-2 (N16R8)
   - Controller A (UART1): 4× Feetech SCS0009 servos (ears, 2-DOF × 2)
   - Controller B (UART2): 3× Feetech STS3215 servos (neck pan/tilt/roll)
   - Unified upper-body control with coordinated gestures
   [Source: docs/architecture/components.md#ears--neck-module-shared-esp32]

3. **Body Module (I2C 0x0A)**
   - ESP32-S3-WROOM-2 (N16R8)
   - 1× GC9A01 Round TFT (heart animation)
   - Relay module (12V projector power)
   - WS2812B RGB LED strip (5-10 LEDs)
   - 60 FPS heart animation with emotion-driven BPM (50-120)
   [Source: docs/architecture/components.md#body-module-heart-display--projector-control--leds]

4. **Base Module (I2C 0x0B)**
   - ESP32-S3-WROOM-2 (N16R8)
   - MPU6050 IMU (200Hz PID balancing)
   - ODrive v3.6 motor controller (UART1)
   - 2× Hoverboard hub motors (350W each)
   - 1× Feetech STS3215 kickstand servo (UART2)
   - 200Hz real-time balancing with fall detection
   [Source: docs/architecture/components.md#base-module-self-balancing--kickstand]

### I2C Register Map Standards

The shared register protocol (0x00-0x0F) remains consistent across all modules:

```cpp
// Common registers (all modules)
#define REG_MODULE_ID           0x00  // Read-only: Module identification
#define REG_FIRMWARE_VERSION    0x01  // Read-only: Firmware version
#define REG_STATUS              0x02  // Read-only: Module status byte
#define REG_ERROR_CODE          0x03  // Read-only: Last error code
#define REG_COMMAND             0x04  // Write: Command trigger
#define REG_COMMAND_ARG1        0x05  // Write: Command arguments
#define REG_COMMAND_ARG2        0x06
#define REG_COMMAND_ARG3        0x07
#define REG_COMMAND_ARG4        0x08

// Status byte flags
#define STATUS_READY            0x01
#define STATUS_BUSY             0x02
#define STATUS_ERROR            0x04
#define STATUS_OTA_MODE         0x08
#define STATUS_CALIBRATING      0x10
```

[Source: docs/architecture/data-models.md#i2c-register-map-standard---all-modules]

### Repository Structure Standards

**Monorepo Organization (MECE Principle):**
- Each directory owns its domain exclusively (no overlap)
- Module directories follow pattern: `firmware/<module-name>/`
- Each module contains: `firmware/`, `platformio.ini`, `README.md`, `test/`

**File Naming Conventions:**
- Module directories: `kebab-case` (e.g., `ears-neck`, not `ears_neck`)
- Python files: `snake_case.py`
- C++ files: `snake_case.cpp`, `snake_case.h`
- Arduino sketches: `<module>_controller.ino`

[Source: docs/architecture/source-tree.md#file-naming-conventions]

### Previous Story Context (Story 1.1)

Story 1.1 created the initial repository structure but used an **outdated 5-module layout**:
- Old structure: head/, ears/, neck/, projector/, base/ (5 separate modules)
- Old I2C addresses: 0x08-0x0C

The architecture was subsequently consolidated to 4 modules, but the file system and documentation were not updated to reflect this change. This story corrects that misalignment.

[Source: docs/stories/1.1.repository-setup.md#completion-notes]

### Module README Requirements

Each module's README.md should document:
1. **Hardware specifications** (ESP32 variant, sensors, actuators)
2. **I2C API** (module-specific registers beyond common 0x00-0x0F)
3. **Firmware architecture** (main controller, drivers, control loops)
4. **Setup instructions** (PlatformIO upload, pin connections)
5. **Standalone testing** (how to test without orchestrator)
6. **Troubleshooting** (common issues, debug steps)

[Source: docs/architecture/source-tree.md#modules---esp32-firmware-cc]

### Architecture Documentation Sources

**Primary references for this refactoring:**
- Module definitions: `docs/architecture/components.md`
- I2C register maps: `docs/architecture/data-models.md`
- Repository structure: `docs/architecture/source-tree.md`
- Coding standards: `docs/architecture/coding-standards.md`

**Outdated sections requiring updates:**
- `docs/architecture/source-tree.md` lines 110-164 (still shows 5-module structure)

## Testing

### Testing Standards

**Framework:** Manual verification (no automated tests for directory refactoring)

**Validation Steps:**

1. **Directory Structure Verification:**
   - Use `tree firmware/` or `ls -la firmware/` to verify 4-module layout
   - Confirm directories: `head/`, `ears-neck/`, `body/`, `base/`
   - Confirm subdirectories: `firmware/` under each module
   - Verify old directories removed: no `ears/`, `neck/`, `projector/` (unless user had custom content)

2. **I2C Register Header Verification:**
   - Read `shared/i2c_registers.h`
   - Verify module ID constants: `MODULE_ID_HEAD (0x08)`, `MODULE_ID_EARS_NECK (0x09)`, `MODULE_ID_BODY (0x0A)`, `MODULE_ID_BASE (0x0B)`
   - Verify comments describe module responsibilities accurately

3. **Architecture Documentation Verification:**
   - Read `docs/architecture/source-tree.md`
   - Verify `/firmware/` section shows 4 modules with correct I2C addresses
   - Verify no references to old 5-module structure

4. **Configuration File Verification:**
   - Check `ros2/src/orchestrator/config/module_i2c_addresses.yaml` exists
   - Verify correct 4-module mapping with addresses 0x08, 0x09, 0x0A, 0x0B

5. **Git Commit Verification:**
   - Verify commit message: "refactor: update repository structure to 4-module I2C architecture"
   - Verify all changed files staged and committed
   - Verify no unintended files included

**Success Criteria:**
- All 4 module directories exist with proper subdirectories
- I2C addresses consistent across all documentation and code
- Architecture docs reflect current 4-module design
- Configuration files use correct module names and addresses

[Source: docs/architecture/coding-standards.md#testing-standards]

## Change Log

| Date       | Version | Description                          | Author          |
|------------|---------|--------------------------------------|-----------------|
| 2025-10-13 | v1.0    | Initial story draft created          | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929 (Sonnet 4.5)

### Debug Log References

No debug issues encountered. All tasks completed successfully on first attempt.

### Completion Notes

Successfully refactored repository structure from 5-module to 4-module architecture. All acceptance criteria met:

**Task 1 - Module Directory Reorganization:**
- Created new `firmware/ears-neck/` directory with firmware subdirectory
- Created comprehensive `firmware/ears-neck/README.md` documenting 7-servo unified control (4× SCS0009 ears + 3× STS3215 neck)
- Created `firmware/ears-neck/platformio.ini` with ESP32-S3 configuration
- Removed old `firmware/ears/`, `firmware/neck/`, and `firmware/projector/` directories
- Verified `firmware/head/`, `firmware/body/`, and `firmware/base/` directories exist

**Task 2 - I2C Register Definitions:**
- Added module ID constants to `shared/i2c_registers.h`:
  - `MODULE_ID_HEAD (0x08)`
  - `MODULE_ID_EARS_NECK (0x09)`
  - `MODULE_ID_BODY (0x0A)`
  - `MODULE_ID_BASE (0x0B)`
- Added comprehensive comments documenting each module's hardware responsibilities
- Updated all references from old 5-module structure to new 4-module architecture

**Task 3 - Architecture Documentation:**
- Updated `docs/architecture/source-tree.md` lines 110-179
- Replaced old 5-module structure with 4-module consolidated structure
- Updated module descriptions to match current architecture
- Updated orchestrator driver node references (removed separate ears/neck/projector drivers)

**Task 4 - Configuration Files:**
- Created `ros2/src/orchestrator/config/module_i2c_addresses.yaml` with complete 4-module mapping
- Included detailed descriptions, hardware specs, and responsibilities for each module
- Documented I2C bus configuration and reserved address space
- Added historical context notes explaining the consolidation rationale
- Verified no hardcoded old addresses (0x0C) in orchestrator code (no Python files exist yet)

**Task 5 - Git Commit:**
- Staged all modified and new files
- Created commit with exact message specified: "refactor: update repository structure to 4-module I2C architecture"
- Commit SHA: 18bd0946104f70517d5685445b9d843f550b326f
- 5 files changed, 377 insertions(+), 38 deletions(-)

**Note:** Found pre-existing modifications to `docs/stories/1.1.repository-setup.md` that already reflected 4-module structure. This file was not included in commit as it was outside the scope of this story.

### File List

**Files Created:**
- `/home/kamal/Documents/Garage/OLAF/firmware/ears-neck/README.md` (180 lines)
- `/home/kamal/Documents/Garage/OLAF/firmware/ears-neck/platformio.ini` (36 lines)
- `/home/kamal/Documents/Garage/OLAF/firmware/ears-neck/firmware/` (directory)
- `/home/kamal/Documents/Garage/OLAF/ros2/src/orchestrator/config/module_i2c_addresses.yaml` (93 lines)

**Files Modified:**
- `/home/kamal/Documents/Garage/OLAF/shared/i2c_registers.h` (added module ID constants and comprehensive documentation)
- `/home/kamal/Documents/Garage/OLAF/docs/architecture/source-tree.md` (updated modules section to reflect 4-module structure)
- `/home/kamal/Documents/Garage/OLAF/docs/stories/1.1.1.refactor-module-structure.md` (this file - updated status and Dev Agent Record)

**Directories Removed:**
- `/home/kamal/Documents/Garage/OLAF/firmware/ears/`
- `/home/kamal/Documents/Garage/OLAF/firmware/neck/`
- `/home/kamal/Documents/Garage/OLAF/firmware/projector/`

## QA Results

_To be filled by QA agent_
