# Story 3.4: Neck Gimbal Assembly & Ears+Neck PCB Integration

## Status
Draft

## Story
**As a** hardware builder,
**I want** a 3-DOF neck gimbal assembled with servos and Ears+Neck Module PCB integrating all upper-body articulation,
**so that** Olaf's head can pan, tilt, and roll for expressive gestures with coordinated ear control.

## Acceptance Criteria

1. **Components Acquired:**
   - 3× Feetech STS3215 servos (30 kg·cm torque for neck articulation)
   - 1× Bus Servo Controller (STSC series, controls 3 neck servos via UART)
   - 1× ESP32-S3-WROOM-2 (N16R8) - Ears+Neck Module controller
   - General purpose PCB (perfboard) for Ears+Neck Module
   - M4 bolts for gimbal joints, M3 screws for servo mounting
   - Bearings (optional, for smoother gimbal rotation)
   - I2C cable (4-wire) to route through neck to torso

2. **3-DOF Gimbal Mechanical Assembly:**
   - **Pan Axis (Yaw):** Rotates head left ↔ right (±90°)
   - **Tilt Axis (Pitch):** Tilts head up ↔ down (±45°)
   - **Roll Axis:** Rolls head clockwise ↔ counterclockwise (±30°)
   - Gimbal order: Pan (base) → Tilt (middle) → Roll (top, connects to head)
   - All three servos mounted in respective brackets
   - Head housing from Story 3.2 mounted to roll gimbal
   - Smooth movement through full range, no binding

3. **Ears+Neck Module PCB Assembly:**
   - PCB designed to fit near gimbal base (mounted in neck or upper torso area)
   - ESP32-S3 soldered to PCB
   - **UART1 connections soldered:** TX (GPIO4), RX (GPIO5) to ear servo controller (from Story 3.3)
   - **UART2 connections soldered:** TX (GPIO16), RX (GPIO17) to neck servo controller
   - I2C header soldered: SDA (GPIO21), SCL (GPIO22), GND, 3.3V
   - Power input: USB or 5V to ESP32 VIN
   - All solder joints inspected (no shorts or cold joints)

4. **Servo Controller Integration:**
   - Ear servo controller (from Story 3.3) connected to PCB UART1
   - Neck servo controller connected to PCB UART2
   - Both controllers powered from 5V supply
   - Servo addressing:
     - Ears: Servo 1-4 (from Story 3.3)
     - Neck: Servo 5 (pan), Servo 6 (tilt), Servo 7 (roll)

5. **Cable Routing:**
   - Head Module I2C cable (from Story 3.2) routed through gimbal cable channels
   - Ears+Neck Module I2C cable prepared to route through neck to torso
   - **Both I2C cables** exit bottom of neck assembly (ready for torso connection in Epic 7)
   - Eye display cables organized inside head housing
   - Servo cables organized and secured
   - Cables avoid pinching during full gimbal range of motion

6. **Mechanical Testing:**
   - Manual test: UART commands to neck controller verify all 3 servos respond
   - Test movements:
     - Pan sweep: -90° to +90° (smooth, no binding)
     - Tilt sweep: -45° to +45° (head doesn't sag)
     - Roll sweep: -30° to +30° (balanced)
     - Combined: Pan + tilt + roll simultaneously (no mechanical interference)
   - Full range tested with head assembly weight
   - Cables remain clear of moving parts throughout full range

7. **Functional Testing:**
   - Power on: Ears+Neck ESP32 boots (via USB or 5V)
   - **Temporary I2C test:** Connect both I2C cables to Raspberry Pi, verify devices at 0x08 (head) and 0x09 (ears+neck)
   - Test ear servos: Send UART1 commands → ears move
   - Test neck servos: Send UART2 commands → head pans/tilts/rolls
   - **Note:** Permanent I2C connections to Pi in torso happen in Epic 7

8. **Documentation:**
   - Neck gimbal assembly photos: `hardware/wiring/neck-gimbal-assembly-photos/`
   - Ears+Neck PCB photos: `hardware/pcb/ears-neck-pcb-layout.jpg`
   - Servo ID mapping updated: `firmware/ears_neck/README.md`
   - Cable routing documented with photos
   - I2C cable pinouts documented for Epic 7

## Tasks / Subtasks

- [ ] **Task 1: Acquire neck gimbal components** (AC: 1)
  - [ ] Purchase 3× Feetech STS3215 servos
  - [ ] Purchase 1× Bus Servo Controller (STSC series, UART interface)
  - [ ] Purchase ESP32-S3-WROOM-2 (N16R8)
  - [ ] Purchase general purpose PCB (perfboard, ~7×10cm)
  - [ ] Gather M4 bolts (gimbal joints), M3 screws (servo mounts)
  - [ ] Optional: Purchase bearings for gimbal pivots
  - [ ] Prepare I2C cable (4-wire, 50-100cm for routing to torso)

- [ ] **Task 2: Assemble pan axis (base)** (AC: 2)
  - [ ] Mount Servo 5 (pan) in `servo-bracket-neck-pan.stl`
  - [ ] Secure bracket to `neck-gimbal-base.stl`
  - [ ] Attach servo horn to Servo 5 output
  - [ ] Connect `neck-gimbal-pan.stl` component to servo horn
  - [ ] Test pan rotation: -90° to +90°

- [ ] **Task 3: Assemble tilt axis (middle)** (AC: 2)
  - [ ] Mount Servo 6 (tilt) in `servo-bracket-neck-tilt.stl`
  - [ ] Attach tilt bracket to pan component (from Task 2)
  - [ ] Attach servo horn to Servo 6 output
  - [ ] Connect `neck-gimbal-tilt.stl` component to servo horn
  - [ ] Test tilt rotation: -45° to +45°

- [ ] **Task 4: Assemble roll axis (top)** (AC: 2)
  - [ ] Mount Servo 7 (roll) in `servo-bracket-neck-roll.stl`
  - [ ] Attach roll bracket to tilt component (from Task 3)
  - [ ] Attach servo horn to Servo 7 output
  - [ ] Connect `neck-gimbal-roll.stl` component to servo horn
  - [ ] Test roll rotation: -30° to +30°

- [ ] **Task 5: Attach head to gimbal** (AC: 2)
  - [ ] Mount head housing (from Story 3.2) to neck-gimbal-roll component
  - [ ] Secure with M3 screws
  - [ ] Verify head balanced (no sag when servos unpowered)
  - [ ] Test full gimbal range with head attached

- [ ] **Task 6: Wire neck servo daisy-chain** (AC: 4)
  - [ ] Connect neck servos in series:
    - [ ] Servo 5 (pan) → Servo 6 (tilt) → Servo 7 (roll)
  - [ ] Connect servo chain to Bus Servo Controller (neck)
  - [ ] Configure servo IDs:
    - [ ] Servo 5: ID = 5
    - [ ] Servo 6: ID = 6
    - [ ] Servo 7: ID = 7
  - [ ] Prepare UART2 cable from neck controller (will connect to PCB)

- [ ] **Task 7: Design Ears+Neck Module PCB layout** (AC: 3)
  - [ ] Sketch PCB layout:
    - [ ] ESP32-S3 position
    - [ ] UART1 header (ear controller): TX (GPIO4), RX (GPIO5)
    - [ ] UART2 header (neck controller): TX (GPIO16), RX (GPIO17)
    - [ ] I2C output header: SDA (GPIO21), SCL (GPIO22), GND, 3.3V
    - [ ] Power input (USB or 5V)
  - [ ] Mark trace routing
  - [ ] Plan mounting location (near gimbal base or upper torso)

- [ ] **Task 8: Solder Ears+Neck Module PCB** (AC: 3)
  - [ ] Solder ESP32-S3 to PCB (headers or direct mount)
  - [ ] Solder UART1 header (GPIO4/5) for ear controller
  - [ ] Solder UART2 header (GPIO16/17) for neck controller
  - [ ] Solder I2C output header (GPIO21/22, GND, 3.3V)
  - [ ] Solder power input
  - [ ] Continuity test: Verify all connections
  - [ ] Short check: Verify no shorts between VCC/GND

- [ ] **Task 9: Connect servo controllers to PCB** (AC: 4)
  - [ ] Connect ear servo controller UART to PCB UART1 (GPIO4/5)
  - [ ] Connect neck servo controller UART to PCB UART2 (GPIO16/17)
  - [ ] Connect 5V power to both controllers
  - [ ] Test: Upload basic firmware, send UART commands, verify servos respond

- [ ] **Task 10: Route cables through gimbal** (AC: 5)
  - [ ] Route Head Module I2C cable through `cable-guide-neck.stl` channels
  - [ ] Route Ears+Neck I2C cable through neck to torso exit
  - [ ] Organize servo cables with cable ties
  - [ ] Test cable clearance: Move gimbal through full range, verify no pinching
  - [ ] Add strain relief at PCB connections

- [ ] **Task 11: Mount PCB and final assembly** (AC: 3, 5)
  - [ ] Mount Ears+Neck PCB near gimbal base (standoffs or adhesive)
  - [ ] Verify USB port accessible for firmware updates
  - [ ] Secure all cable routing
  - [ ] Final check: All connections secure, no loose wires

- [ ] **Task 12: Mechanical range testing** (AC: 6)
  - [ ] Send UART2 position commands to neck servos
  - [ ] Test pan: -90° to +90° (smooth, no binding)
  - [ ] Test tilt: -45° to +45° (head stable, no sag)
  - [ ] Test roll: -30° to +30° (balanced)
  - [ ] Test combined movements (all axes simultaneously)
  - [ ] Verify cables clear of moving parts throughout range
  - [ ] Check for mechanical wear on cable channels

- [ ] **Task 13: Functional testing** (AC: 7)
  - [ ] Power on Ears+Neck ESP32 (via USB or 5V)
  - [ ] **Temporary I2C test:**
    - [ ] Connect both I2C cables to Raspberry Pi
    - [ ] Run `sudo i2cdetect -y 1`
    - [ ] Verify device 0x08 (Head Module)
    - [ ] Verify device 0x09 (Ears+Neck Module)
  - [ ] Test ear servos via UART1 (verify Story 3.3 functionality)
  - [ ] Test neck servos via UART2 (all 3 axes)
  - [ ] Disconnect temporary I2C (permanent connection in Epic 7)

- [ ] **Task 14: Documentation** (AC: 8)
  - [ ] Photograph gimbal assembly (multiple angles)
  - [ ] Photograph Ears+Neck PCB
  - [ ] Photograph cable routing through gimbal
  - [ ] Save photos to:
    - [ ] `hardware/wiring/neck-gimbal-assembly-photos/`
    - [ ] `hardware/pcb/ears-neck-pcb-layout.jpg`
  - [ ] Update `firmware/ears_neck/README.md`:
    - [ ] Servo ID mapping (5-7 for neck)
    - [ ] UART1/UART2 pin assignments
    - [ ] I2C cable pinout (SDA, SCL, GND, 3.3V)
    - [ ] Note: I2C routes to torso Pi (Epic 7)

## Dev Notes

### Prerequisites
From Story 3.1 (3D Printing):
- Neck gimbal components printed: base, pan, tilt, roll, servo brackets, cable guides

From Story 3.2 (Head Module PCB):
- Head assembly complete with I2C cable exiting bottom

From Story 3.3 (Ear Servo Assembly):
- 4 ear servos assembled and functional
- Ear servo controller wired (UART prepared for connection)

### Neck Gimbal Kinematics

**3-DOF Gimbal Order:**
```
Gimbal Base (fixed to torso in Epic 7)
  ↓
Pan Axis (Servo 5) ← rotates head left/right
  ↓
Tilt Axis (Servo 6) ← tilts head up/down
  ↓
Roll Axis (Servo 7) ← rolls head CW/CCW
  ↓
Head Housing (attached to roll gimbal)
```

**Range of Motion:**
| Axis | Servo | Range | Center | Movement |
|------|-------|-------|--------|----------|
| Pan (Yaw) | Servo 5 | -90° to +90° | 0° | Left/right head turn |
| Tilt (Pitch) | Servo 6 | -45° to +45° | 0° | Up/down head tilt |
| Roll | Servo 7 | -30° to +30° | 0° | CW/CCW head roll |

**Expressive Gestures (Examples):**
- **Look left:** Pan -60°, tilt 0°, roll 0°
- **Look up:** Pan 0°, tilt +30°, roll 0°
- **Curious tilt:** Pan -20°, tilt +15°, roll +15° (WALL-E style)
- **Nod yes:** Tilt down -20° → up +10° → center (repeat 2×)
- **Shake no:** Pan left -30° → right +30° → center (repeat 2×)

### Component Specifications

**Feetech STS3215 Servo:**
- **Type:** Serial bus servo (daisy-chainable)
- **Torque:** 30 kg·cm @ 12V
- **Speed:** 0.09 sec/60° @ 12V
- **Voltage:** 6-12V (7.4V LiPo or 12V recommended)
- **Communication:** TTL serial (half-duplex UART)
- **Protocol:** Feetech STS protocol
- **Dimensions:** ~40mm × 20mm × 40mm (L×W×H)
- **Mounting:** M3 screw holes

**Weight Considerations:**
- Head assembly weight: ~300-500g (ESP32, 2× displays, sensors, housing)
- STS3215 torque: 30 kg·cm sufficient for head + ears weight
- Tilt axis bears most weight (verify no sag at 0° tilt)

### Ears+Neck Module PCB

**ESP32-S3 Dual UART Configuration:**
| UART | GPIO TX | GPIO RX | Connected To | Controls |
|------|---------|---------|--------------|----------|
| UART1 | GPIO4 | GPIO5 | Ear Servo Controller | Servos 1-4 (ears) |
| UART2 | GPIO16 | GPIO17 | Neck Servo Controller | Servos 5-7 (neck) |

**I2C Configuration:**
| Signal | GPIO | Destination | Notes |
|--------|------|-------------|-------|
| SDA | GPIO21 | Torso Pi GPIO2 | I2C data (Epic 7) |
| SCL | GPIO22 | Torso Pi GPIO3 | I2C clock (Epic 7) |
| Address | 0x09 | - | Ears+Neck Module address |

**Power Distribution:**
- ESP32-S3: 5V via USB or VIN
- Ear servo controller: 5V supply (shared or separate)
- Neck servo controller: 7.4-12V supply (higher voltage for torque)
- Total current: ~3-5A peak (all 7 servos active)

### Cable Routing Through Neck

**Cable Channels:**
- `cable-guide-neck.stl` provides routing channels through gimbal
- Must accommodate:
  - Head Module I2C cable (4 wires)
  - Ears+Neck Module I2C cable (4 wires)
  - Eye display power/signal cables (internal to head)

**Routing Strategy:**
- I2C cables run along gimbal centerline (minimize movement with articulation)
- Leave slack loops at pivot points (prevents tension during movement)
- Secure cables every 5-10cm (prevents tangling)
- Test full range before final securing

**Strain Relief:**
- Use spiral cable wrap or heat shrink at cable exits
- Add rubber grommets at sharp edges
- Verify no cables pinched at maximum gimbal rotation

### Testing

**Servo Load Test:**
- Command tilt axis to 0° (horizontal)
- Verify head remains level without sag
- If sagging: Increase servo torque limit or check for binding

**Full Range Test:**
- Pan: -90° to +90° in 10° increments
- Tilt: -45° to +45° in 10° increments
- Roll: -30° to +30° in 10° increments
- Verify smooth movement at all positions

**Cable Clearance Test:**
- Move gimbal to all extremes
- Check cables at each position (no pinching, tangling, or tension)
- Adjust cable routing if any interference detected

**Dual I2C Test:**
- Both I2C cables connected to Pi
- `sudo i2cdetect -y 1` shows 0x08 and 0x09
- Send commands to both modules simultaneously
- Verify no I2C bus conflicts

**Troubleshooting:**
- **Servo not responding:** Check UART wiring, verify baud rate, check servo ID
- **Head sags:** Increase tilt servo torque, verify no mechanical binding
- **Gimbal binds:** Check servo alignment, reduce range limits, add lubrication
- **Cable pinching:** Adjust cable routing, add more slack at pivot points
- **I2C conflict:** Verify addresses 0x08 and 0x09 (must be unique)

### File Locations

```
hardware/
├── pcb/
│   └── ears-neck-pcb-layout.jpg       # <-- THIS STORY (PCB sketch)
├── wiring/
│   └── neck-gimbal-assembly-photos/   # <-- THIS STORY (photos)

firmware/ears_neck/
├── firmware/                          # Story 3.5 (firmware)
└── README.md                          # <-- THIS STORY (update with UART1/2, I2C)
```

## Dev Agent Record

### Agent Model Used
<!-- To be filled by dev agent -->

### Debug Log References
<!-- To be filled by dev agent -->

### Completion Notes List
<!-- To be filled by dev agent -->

### File List
<!-- To be filled by dev agent -->

## QA Results
<!-- To be filled by QA agent -->

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-08 | v1.0 | Initial story creation from Epic 3 with PCB integration | Sarah (Product Owner) |
